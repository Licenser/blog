
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Lice!</title>
  <meta name="author" content="Heinz N. 'Licenser' Gies">

  
  <meta name="description" content="Preamble Lets start with this, Erlang releases are super useful they are one of the features I like most about Erlang - you get out an entirely self &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.licenser.net/posts/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Lice!" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31493882-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Lice!</a></h1>
  
    <h2>&#8230;</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.licenser.net">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/19/plugins-with-erlang/">Plugins With Erlang</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-03-19T16:45:00+01:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>4:45 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Preamble</h2>

<p>Lets start with this, Erlang releases are super useful they are one of the features I like most about Erlang - you get out an entirely self contained package you can deploy and forget, no library trouble, no wrong version of the VM no trouble at all.</p>

<p>BUT (this had to come didn&rsquo;t it) sometimes they are limiting and kind of inflexible, adding a tiny little feature means rolling out a new release, with automated builds that is not so bad but &lsquo;not so bad&rsquo; isn&rsquo;t good either. And things get worst when there are different wishes.</p>

<p>A little glimpse into reality: I&rsquo;m currently working a lot on <a href="http://project-fifo.net">Project FiFo</a> and one of the issues I faced is that - surprisingly - not everyone wants things to work exactly as I do. Which was a real shock, how could anyone ever disagree with me? Well &hellip; I got over it, really I did, still solving this issue by adding one code path for every preference and making it configureable didn&rsquo;t looked like a good solution.</p>

<p>Also recently we are thinking a lot about performance metrics, and there are like a gazillion of them and if you pick two random people I think they want three different sets of metrics. Ask again after 5 minutes and their opinions changed to 7 new metrics and certainly not the old ones!</p>

<h2>Plugins</h2>

<p>The problem is a very old one, extending the software after it was shipped, possibly letting the community extend it beyond what was dreamed of in the beginning. The solution is pretty much one day younger then the problem: plugins. Meaning a way to load code into the system.</p>

<p>Sounds easy but it is a bit more complex, just having something load into the VM doesn&rsquo;t do much good when it does not get executed in the proper place - so sadly this comes with extra work for the developer to sprinkle their code with hooks and callbacks for the plugins.</p>

<p>With this I&rsquo;d like to introduce <a href="https://github.com/Licenser/eplugin">eplugin</a> it&rsquo;s a very simplistic library for exactly that task - introduce plugins in an Erlang release or application. It takes care of discovering and loading plugins, letting them register into certain calls, a little dependency management on startup and provides functions to call registered plugins. Erlang comes with great tools already to the whole thing sums up to under 400 LOC.</p>

<h2>Types of plugins</h2>

<p>I feel it&rsquo;s kind of interesting to look at the different kind of plugins that exist and how to handle the cases with <a href="https://github.com/Licenser/eplugin">eplugin</a> also a post entirely without code would look boring.</p>

<h3>informative plugins</h3>

<p>Sometimes a plugin just want to know that something happened but don&rsquo;t care about the result. <code>eplugin</code> provides the <code>call</code> (and <code>apply</code>) functions for that. A logger is a good example for this so lets have a look:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%%% plugin.conf</span>
</span><span class='line'><span class="p">{</span><span class="n">syslog_plugin</span><span class="p">,</span>
</span><span class='line'>  <span class="p">[{</span><span class="n">syslog_plugin</span><span class="p">,</span> <span class="p">[{</span><span class="n">&#39;some:event&#39;</span><span class="p">,</span> <span class="n">log</span><span class="p">}]}],</span>
</span><span class='line'>  <span class="p">[]}.</span>
</span><span class='line'>
</span><span class='line'><span class="c">%%% syslog_plugin.erl</span>
</span><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">syslog_plugin</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">log</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">log</span><span class="p">(</span><span class="nv">String</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nn">os</span><span class="p">:</span><span class="nf">cmd</span><span class="p">(</span><span class="s">&quot;logger &#39;&quot;</span> <span class="o">++</span> <span class="nv">String</span> <span class="o">++</span> <span class="s">&quot;&#39;&quot;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="c">%%% in your code</span>
</span><span class='line'>  <span class="c">%%... </span>
</span><span class='line'>  <span class="nn">eplugin</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="n">&#39;some:event&#39;</span><span class="p">,</span> <span class="s">&quot;logging this!&quot;</span><span class="p">),</span>
</span><span class='line'>  <span class="c">%%... </span>
</span></code></pre></td></tr></table></div></figure>


<p>Thats pretty much it, provided you&rsquo;ve started the <code>eplugin</code> application in your code and put the plugins in the right place this will just work. You could also use this to trigger side effects, like delete all files when an error occurs to remove traces of your failure.</p>

<h3>messing around plugins</h3>

<p>This kind of plugins process some data and return a new version of this data, we have <code>fold</code> for this case. Fold since it internally uses fold to pass the data from one plugin to another. there are many applications for that one would be to replace all occurrences of &lsquo;not js&rsquo; with &lsquo;node.js&rsquo; to prevent freudian typos in your texts.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%%% plugin.conf</span>
</span><span class='line'><span class="p">{</span><span class="n">not_js</span><span class="p">,</span>
</span><span class='line'>  <span class="p">[{</span><span class="n">not_js</span><span class="p">,</span> <span class="p">[{</span><span class="n">&#39;text:check&#39;</span><span class="p">,</span> <span class="n">replace</span><span class="p">}]}],</span>
</span><span class='line'>  <span class="p">[]}.</span>
</span><span class='line'>
</span><span class='line'><span class="c">%%% not_js.erl</span>
</span><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">not_js</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">replace</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">replace</span><span class="p">(</span><span class="nv">String</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nn">re</span><span class="p">:</span><span class="nf">replace</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span> <span class="s">&quot;not js&quot;</span><span class="p">,</span> <span class="s">&quot;node.js&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">global</span><span class="p">]).</span>
</span><span class='line'><span class="c">%%% in your code</span>
</span><span class='line'>  <span class="c">%%... </span>
</span><span class='line'>  <span class="nv">String1</span> <span class="o">=</span> <span class="nn">eplugin</span><span class="p">:</span><span class="nf">fold</span><span class="p">(</span><span class="n">&#39;text:check&#39;</span><span class="p">,</span> <span class="s">&quot;I&#39;m writing a not js application!&quot;</span><span class="p">),</span>
</span><span class='line'>  <span class="c">%%... </span>
</span></code></pre></td></tr></table></div></figure>


<p><code>fold</code> and <code>call</code> are the most interesting and important kind of plugins, they cover most if not all of the possible use cases of plugins so there is a special case left which I found useful to have.</p>

<h3>checking plugins</h3>

<p>Checking plugins are plugins which are supposed to decide if something is Ok or not, they are pretty much a case of <code>fold</code> that returns true or false (or actually whatever is not true). But <code>eplugin</code> solves this too, with the <code>test</code> function! An example here is authentication</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%%% plugin.conf</span>
</span><span class='line'><span class="p">{</span><span class="n">get_out</span><span class="p">,</span>
</span><span class='line'>  <span class="p">[{</span><span class="n">get_out</span><span class="p">,</span> <span class="p">[{</span><span class="n">&#39;login:allowed&#39;</span><span class="p">,</span> <span class="n">no_really_not</span><span class="p">}]}],</span>
</span><span class='line'>  <span class="p">[]}.</span>
</span><span class='line'>
</span><span class='line'><span class="c">%%% get_out.erl</span>
</span><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">get_out</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">no_really_not</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">no_really_not</span><span class="p">(</span><span class="nv">Login</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="p">{</span><span class="n">forbidden</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;Dear &quot;</span><span class="p">,</span> <span class="nv">Login</span><span class="p">,</span> <span class="s">&quot; we don&#39;t want you here go away!&quot;</span><span class="p">]}.</span>
</span><span class='line'>
</span><span class='line'><span class="c">%%% in your code</span>
</span><span class='line'>  <span class="c">%%... </span>
</span><span class='line'>  <span class="k">case</span> <span class="nn">eplugin</span><span class="p">:</span><span class="nf">test</span><span class="p">(</span><span class="n">&#39;login:allowed&#39;</span><span class="p">,</span> <span class="s">&quot;Licenser&quot;</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>     <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">%%% huzza!</span>
</span><span class='line'>     <span class="nv">Error</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;</span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Error</span><span class="p">])</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c">%%... </span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/31/a-vow-to-create-tickets/">A Vow to Create Tickets</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-01-31T01:30:00+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2013</span></span> <span class='time'>1:30 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve had some open source projects before, actually quite some, but Project FiFo is by far the most successful one. And aside from the technical perspective I&rsquo;ve learned a tremendous amount of new things already, one of which I want so share since. It sounds simple but I never looked at it this way before: Tickets.</p>

<p>The project has caught on momentum so fast that at &lsquo;rush hours&rsquo; people come with questions, bug reports and feature requests at rate that it&rsquo;s they pile up faster then we can help or answer, the channel and community already does a great job &lsquo;filtering&rsquo; out easy to answer topics but enough are complicated to a point where a developer has to look at them.</p>

<p>I&rsquo;ve been on both sides of the fence, and I had the honest believe that it&rsquo;s easier for developers if you just pop by the IRC channel and ask/report a issue. And that is not entirely wrong often a quick &lsquo;hey I&rsquo;ve problem X/Y&rsquo; is enough to solve a situation others had before that can be resoved with a few words.</p>

<p>What I did not realise is how crucial it is to open tickets for anything that can&rsquo;t be resolved directly. The reason for this is simple, usually there are N users for 1 developer and for each user it&rsquo;s easy to keep their topic in mind and present it can become very had very fast for a developer with three users to listen to.</p>

<p>But I don&rsquo;t want to wander of ranting, instead I&rsquo;ll try to explain why a ticket really helps me to get stuff done.</p>

<h4>Organisation</h4>

<p>Tickets make it very easy to keep track of them, assign them to people (given you&rsquo;re not solving them yourself) and add followup data. Tickets can be prioritised and categorised, this makes it very easy to group related items or even look up known issues.</p>

<p>The more tickets there are and the more people working on them the more important this gets, handling six tickets gets way easier then handling six email conversations or unthreading six conversations from a IRC channel.</p>

<h4>Information</h4>

<p>One of the great things about tickets is that they can contain additional information, it&rsquo;s absolutely helpful to look at a issue that already has some information attached that goes further then three lines and a &ldquo;it isn&rsquo;t working&rdquo;.</p>

<p>To make this better it is also possible to add files and logs which can contain much more information to a ticket and those can be &lsquo;handed around&rsquo; between different people looking at the issue without the need to send mails.</p>

<h4>Followup</h4>

<p>Tickets are a two way street, once a ticket is logged the reporter can see it&rsquo;s progress without having to ask - or at least can ask if it is not handled for a long period. Also it is easier to say &lsquo;hey what is the status if ticket #42&rsquo; where all the information is provided already instead of &lsquo;hey how about that bug that happened when …&rsquo; and have to explain it all over again.</p>

<h4>Deduplication</h4>

<p>Once a ticket is logged it&rsquo;s visible for everyone, there is no reason to go around and ask &lsquo;hey do you know the bug …&rsquo; or &lsquo;what are your thoughts about feature …&rsquo; and perhaps even get a wrong answer since you&rsquo;re talking to more then one person. This makes everyones live easier.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/28/erlang-and-more-dtrace/">Erlang and More DTrace</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-01-28T18:33:00+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>6:33 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Some nice additions to the little Erlang DTrace demo. For once I&rsquo;ve added a filed to input custom scripts which are run on the server which is pretty neat since it allows running all kind of (l)quantize based scripts from the server and get a nice heatmap.</p>

<p>Like how about the heatmap of how Erlang function call times?</p>

<p><img src="/images/posts/2013-01-28-erlang-and-more-dtrace-1.png" alt="Erlang Call Heatmap" /></p>

<p>The script used (also included in the repository):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='d'><span class='line'><span class="n">erlang</span><span class="p">*:::</span><span class="n">global</span><span class="p">-</span><span class="k">function</span><span class="p">-</span><span class="n">entry</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">self</span><span class="p">-&gt;</span><span class="n">funcall_entry_ts</span><span class="p">[</span><span class="n">copyinstr</span><span class="p">(</span><span class="n">arg1</span><span class="p">)]</span> <span class="p">=</span> <span class="n">vtimestamp</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">erlang</span><span class="p">*:::</span><span class="k">function</span><span class="p">-</span><span class="k">return</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">@</span><span class="n">time</span><span class="p">[</span><span class="n">copyinstr</span><span class="p">(</span><span class="n">arg1</span><span class="p">)]</span> <span class="p">=</span> <span class="n">lquantize</span><span class="p">((</span><span class="n">vtimestamp</span> <span class="p">-</span> <span class="n">self</span><span class="p">-&gt;</span><span class="n">funcall_entry_ts</span><span class="p">[</span><span class="n">copyinstr</span><span class="p">(</span><span class="n">arg1</span><span class="p">)]</span> <span class="p">)</span> <span class="p">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that is already cool <strong>but</strong> there is more, in addition to there is a page now that allows to show list based queries (as count or sum) so for example it would be very easy to get a profiling of an Erlang program like this:</p>

<p><img src="/images/posts/2013-01-28-erlang-and-more-dtrace-2.png" alt="Erlang Profiling" /></p>

<p>The script used (also included in the repository):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='d'><span class='line'><span class="n">erlang</span><span class="p">*:::</span><span class="n">global</span><span class="p">-</span><span class="k">function</span><span class="p">-</span><span class="n">entry</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">self</span><span class="p">-&gt;</span><span class="n">funcall_entry_ts</span><span class="p">[</span><span class="n">copyinstr</span><span class="p">(</span><span class="n">arg1</span><span class="p">)]</span> <span class="p">=</span> <span class="n">vtimestamp</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">erlang</span><span class="p">*:::</span><span class="k">function</span><span class="p">-</span><span class="k">return</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">@</span><span class="n">time</span><span class="p">[</span><span class="n">copyinstr</span><span class="p">(</span><span class="n">arg1</span><span class="p">)]</span> <span class="p">=</span> <span class="n">sum</span><span class="p">((</span><span class="n">vtimestamp</span> <span class="p">-</span> <span class="n">self</span><span class="p">-&gt;</span><span class="n">funcall_entry_ts</span><span class="p">[</span><span class="n">copyinstr</span><span class="p">(</span><span class="n">arg1</span><span class="p">)]</span> <span class="p">)</span> <span class="p">/</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Cool thing is this profiling can be turned on and off in a live system and has a <strong>comparable low</strong> performance impact (less then 50% unless functions are hammering in my tests).</p>

<p>To add to the joy, the scripts are stopped the moment the page is closed eliminating every kind of overhead, without restarting anything!</p>

<p>So lets sum this up, the old news (when you played with dtrace before) is that you can profile and analyse your applications on the fly with minimal impact, but the funky part is that you can do it directly as part of your application and only shows when you actually look at the page :) it&rsquo;s kind of like quantumanalytics just the other way round!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/25/erlang-and-dtrace/">Erlang and DTrace</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-01-25T00:21:00+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>12:21 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As part of <a href="http://project-fifo.net">Project FiFo</a> I&rsquo;ve invested some time to research into DTrace and Erlang, not the probes that are there since some time but a DTrace consumer - letting you execute DTrace scripts from within Erlang and read the results.</p>

<p>The result of this research is the <a href="https://www.github.com/project-fifo/erltrace">erltrace</a> a consumer for DTrace implemented as a Erlang NIF. The NIF is based on the <a href="https://github.com/bcantrill/node-libdtrace">node.js</a> and and <a href="http://tmetsch.github.com/python-dtrace/">python</a> implementations - many thanks to them!</p>

<p>It&rsquo;s pretty easy to consume dtrace data from within erlang with <a href="https://www.github.com/project-fifo/erltrace">erltrace</a> and I figured lets make a little demo. Since I&rsquo;m not a big fan of reinventing the wheel and a simple demo had been done before, namely <a href="http://howtonode.org/heat-tracer">heat-tracer</a>.</p>

<p>It&rsquo;s a nice idea and simple enough to implement and cowboy gives a very nice base for that in Erlang. So there you go <a href="https://github.com/Licenser/dowboy">dowboy</a>. The HTML/JS part of the page is pretty much the same as in the original save for replacing socket.io with simple websockets, I&rsquo;ll skip this and the the cowboy parts to look directly in the interesting parts.</p>

<p>When connecting we set up a timer to inform us every second to gather the results from DTrace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">websocket_init</span><span class="p">(_</span><span class="nv">Any</span><span class="p">,</span> <span class="nv">Req</span><span class="p">,</span> <span class="p">[])</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nn">timer</span><span class="p">:</span><span class="nf">send_interval</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span>
</span><span class='line'>  <span class="nv">Req2</span> <span class="o">=</span> <span class="nn">cowboy_http_req</span><span class="p">:</span><span class="nf">compact</span><span class="p">(</span><span class="nv">Req</span><span class="p">),</span>
</span><span class='line'>  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Req2</span><span class="p">,</span> <span class="n">undefined</span><span class="p">,</span> <span class="n">hibernate</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next up we handle incoming Websockets messages, this deals very simple. Every string that is send is considered a new dtrace script to execute.</p>

<p>The first part creates a new handler, this is pretty much a reference to the libdtrace internal data structures. Since we allow multiple scripts to be send we also have to ensure that the old sockets are closed before new ones are opened.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">websocket_handle</span><span class="p">({</span><span class="n">text</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">},</span> <span class="nv">Req</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c">%% We create a new handler</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Handle</span><span class="p">}</span> <span class="o">=</span> <span class="k">case</span> <span class="nv">State</span> <span class="k">of</span>
</span><span class='line'>                       <span class="n">undefined</span> <span class="o">-&gt;</span>
</span><span class='line'>                           <span class="nn">erltrace</span><span class="p">:</span><span class="nf">open</span><span class="p">();</span>
</span><span class='line'>                       <span class="p">{</span><span class="nv">Old</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>                           <span class="c">%% But we want to make sure that any old one is closed first.</span>
</span><span class='line'>                           <span class="nn">erltrace</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Old</span><span class="p">),</span>
</span><span class='line'>                           <span class="nn">erltrace</span><span class="p">:</span><span class="nf">open</span><span class="p">()</span>
</span><span class='line'>                   <span class="k">end</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we compile the dtrace script, <a href="https://www.github.com/project-fifo/erltrace">erltrace</a> only takes lists as strings and not binaries so we&rsquo;ve to convert it first and then we pass it along with our handle to get the script compiled. It will return <code>ok</code> if everything went well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%% We&#39;ve to confert cowboys binary to a list.</span>
</span><span class='line'><span class="nv">Msg1</span> <span class="o">=</span> <span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Msg</span><span class="p">),</span>
</span><span class='line'><span class="n">ok</span> <span class="o">=</span> <span class="nn">erltrace</span><span class="p">:</span><span class="nf">compile</span><span class="p">(</span><span class="nv">Handle</span><span class="p">,</span> <span class="nv">Msg1</span><span class="p">),</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okay now that we&rsquo;ve compiled the script we just need to tell dtrace to start running it, this happens with the <code>erltrace:go</code> call. Again it will return <code>ok</code> when everything is fine. Finally we just output the script as debug info and return.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="n">ok</span> <span class="o">=</span> <span class="nn">erltrace</span><span class="p">:</span><span class="nf">go</span><span class="p">(</span><span class="nv">Handle</span><span class="p">),</span>
</span><span class='line'><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;SCRIPT&gt; </span><span class="si">~s~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Msg</span><span class="p">]),</span>
</span><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Req</span><span class="p">,</span> <span class="p">{</span><span class="nv">Msg1</span><span class="p">,</span> <span class="nv">Handle</span><span class="p">}};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next up: reading the dtrace data, <code>erltrace:walk</code> do that for you and hand back a datastructur to parse. It is returned as <code>{ok, Data}</code> when there is something to handle.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">websocket_info</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="nv">Req</span><span class="p">,</span> <span class="p">{</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">Handle</span><span class="p">}</span> <span class="o">=</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>     <span class="k">case</span> <span class="nn">erltrace</span><span class="p">:</span><span class="nf">walk</span><span class="p">(</span><span class="nv">Handle</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>         <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">R</span><span class="p">}</span> <span class="o">-&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now since we have JSON on the other side we need to transform the data here Erlangs list comprehensions come to the rescue. Data is returned as <code>[{lquantize, [Name], { {BucketStart, BucketEnd
}, BucketCount}}]</code> and we want it in the form <code>{Name, [[BucketStart, BucketEnd], BucketCount]</code> so here you go. We can tehn simpley encode this with <a href="https://github.com/talentdeficit/jsx">jsx</a> and send it over the wire:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'>         <span class="nv">JSON</span> <span class="o">=</span> <span class="p">[{</span><span class="nb">list_to_binary</span><span class="p">(</span><span class="nv">Call</span><span class="p">),[</span> <span class="p">[[</span><span class="nv">S</span><span class="p">,</span> <span class="nv">E</span><span class="p">],</span> <span class="nv">V</span><span class="p">]||</span> <span class="p">{</span> <span class="p">{</span><span class="nv">S</span><span class="p">,</span> <span class="nv">E</span><span class="p">},</span> <span class="nv">V</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Vs</span><span class="p">]}||</span> <span class="p">{</span><span class="n">lquantize</span><span class="p">,</span> <span class="p">[</span><span class="nv">Call</span><span class="p">],</span> <span class="nv">Vs</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">R</span><span class="p">],</span>
</span><span class='line'>         <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="p">{</span><span class="n">text</span><span class="p">,</span> <span class="nn">jsx</span><span class="p">:</span><span class="nf">encode</span><span class="p">(</span><span class="nv">JSON</span><span class="p">)},</span> <span class="nv">Req</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="n">hibernate</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ok</code> will be returned if there is no data yet to consume, we simply do nothing here.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'>     <span class="n">ok</span> <span class="o">-&gt;</span>
</span><span class='line'>         <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Req</span><span class="p">,</span> <span class="p">{</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">Handle1</span><span class="p">}};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last case is just for making things proper, if an error is returned we close stop the current handle and create a new one the same we did in the init.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'>     <span class="nv">Other</span> <span class="o">-&gt;</span>
</span><span class='line'>         <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">E</span><span class="p">]),</span>
</span><span class='line'>         <span class="k">try</span>
</span><span class='line'>             <span class="nn">erltrace</span><span class="p">:</span><span class="nf">stop</span><span class="p">(</span><span class="nv">Handle</span><span class="p">)</span>
</span><span class='line'>         <span class="k">catch</span>
</span><span class='line'>             <span class="p">_:_</span> <span class="o">-&gt;</span>
</span><span class='line'>                 <span class="n">ok</span>
</span><span class='line'>         <span class="k">end</span><span class="p">,</span>
</span><span class='line'>         <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Handle1</span><span class="p">}</span> <span class="o">=</span> <span class="nn">erltrace</span><span class="p">:</span><span class="nf">open</span><span class="p">(),</span>
</span><span class='line'>         <span class="nn">erltrace</span><span class="p">:</span><span class="nf">compile</span><span class="p">(</span><span class="nv">Handle1</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">),</span>
</span><span class='line'>         <span class="nn">erltrace</span><span class="p">:</span><span class="nf">go</span><span class="p">(</span><span class="nv">Handle</span><span class="p">),</span>
</span><span class='line'>         <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Req</span><span class="p">,</span> <span class="p">{</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">Handle1</span><span class="p">}}</span>
</span><span class='line'> <span class="k">end</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that all put together and run it on a dtrace capable machine we get a nice little heatmap that updates every second:</p>

<p><img src="/images/posts/2013-01-25-erlang-and-dtrace-heatmap.png" alt="Heatmap" /></p>

<p>Neat isn&rsquo;t it?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/24/a-new-start/">A New Start</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-01-24T22:35:00+01:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>10:35 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Now it has been a while, it&rsquo;s surprisingly hard to find a decent way to blog in the end I landed with <a href="http://octropress.org">Octopress</a>. Lets see how that turns out, so far after a slightly bumpy bumpy start it seems decent enough.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/index.html">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/07/10/migrating-to-riak3/">Migrating to Riak3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/28/postmortem-of-a-interesting-bug/">Postmortem of a Interesting Bug</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/02/post-mortem-of-a-failed-support-case/">Post-mortem of a Failed Support Case.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/01/backups-with-project-fifo/">Backups With Project FiFo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/13/a-asynchronous-gced-or-set/">A Asynchronously GCed or Set</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/Licenser">@Licenser</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'Licenser',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Heinz N. &#8216;Licenser&#8217; Gies -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lice';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
