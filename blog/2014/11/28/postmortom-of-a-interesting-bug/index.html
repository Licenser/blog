
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Postmortom of a Interesting Bug - Lice!</title>
  <meta name="author" content="Heinz N. 'Licenser' Gies">

  
  <meta name="description" content="Symptoms After a full network outage in a larger system (7 FiFo instances and, a few dozen of hypervisors, VM&rsquo;s in the 3 digit number) a small &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.licenser.net/blog/2014/11/28/postmortom-of-a-interesting-bug">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Lice!" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31493882-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Lice!</a></h1>
  
    <h2>...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.licenser.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Postmortom of a Interesting Bug</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-28T19:20:34+01:00" pubdate data-updated="true">Nov 28<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>Symptoms</h2>

<p>After a full network outage in a larger system (7 FiFo instances and, a few dozen of hypervisors, VM&rsquo;s in the 3 digit number) a small percentage of the VM&rsquo;s stored in FiFo lost information which package was assigned to them and which organization they belong to.</p>

<h2>Technical background</h2>

<p>As part of planned maintenance on the switching layer the entire network was taken down. Effectively cutting the communication between any two systems in the network.  During the maintenance the FiFo system was kept &lsquo;hot&rsquo;, no services disabled or paused. At the end of the maintenance window the network was as planned enabled again, reinstating communications.</p>

<h2>FiFo background</h2>

<p>We will focus in the sniffle and chunter components since those are the relevant parts of sniffle that handle information related to the symptoms.</p>

<p>Generally all fifo data is stored in CRDT&rsquo;s which provides conflict resolution and nearly loss free merging even of entirely devergent data.</p>

<h3>Sniffle</h3>

<p>Sniffle is a distributed system that runs on top of riak_core, all (7) nodes are connected as a mash network via distributed erlang. While the nodes are connected data and functionality is split out in dynamo fashion, at a default N value of 3 that means every node handles (total data)*3/7 of the data.</p>

<p>In the case of a node failure the adjacent node takes over the function of the failed node. Missing data is resolved by a method called &lsquo;read repair&rsquo;, meaning taht when data is requested and 1 out of the 3 nodes responds with no data that &lsquo;missing&rsquo; data is repaired.</p>

<p>Once the node failure is repaird the system that took over the work for the failed node performs what is called a handoff, sending it&rsquo;s (suposedly) updated data to the returning node to bring it up to speed.</p>

<h3>Chunter</h3>

<p>Under normal conditions chunter will send incremental updates about changing vm state to sniffle. If a chunter system for the first time connects to sniffle it will register it&rsquo;s VM&rsquo;s, meaning they are created if not existant, and assigned to the hypervisor. The registration contains nearly all relevent VM information with some exceptions that do not concern the hypervisor. The missing information was amongst the not updated information.</p>

<p>Sniffle nodes are discovered via mdns broadcasts, the first broadcast recived will trigger the inital registration sending the request to this node.</p>

<h2>What happened?</h2>

<p>It is a combination of conditions that lead to the problem and explains why  only a small percentage of VM&rsquo;s was affected.</p>

<h3>During the outage</h3>

<p>1) The network outage cut the communicaiton between <strong>all</strong> sniffle nodes, so each node was on it&rsquo;s own handeling the full load of the requests.
2) The network outage cut communication of <strong>nearly all</strong> chunter nodes, only those who resided on a hypervisor that also contained a fifo zone did not loose conectivity.</p>

<h3>After the outage</h3>

<p>Now there happend a race condition, on one side the distributed erlang started to re-discover the other nodes, reistablising communicaiton in sniffle and initializing handoffs (handoffs of nearly all parts).</p>

<p>On the other side the periodic mDNS broadcasts from the sniffle nodes triggered re-registration of the chunter nodes.</p>

<h3>The bug</h3>

<p>The bug was triggered by the fact that during reciving a handoff a vnode took the wrong assumption that the recived data must be newer then it&rsquo;s own and overwrite the currently stored data instead of merging it.</p>

<p>Due to the usual repair during reads this turned out to be qutie a edge case that was only triggered when:</p>

<p>1) the mDNS was recived from a node that neither holds the right partition, neither is connected to a node holding the right partition.
2) the registration happend to three vnodes that did not hold that data since as long as one node held the data it would have been merged with this instead of re-created
3) the handoff on all three systems was performed before any read happend, since the read-repair would haver otherwise merged the data.
4) the handoff off all three systems was performed before AAE triggered, since AAE triggers a read-repair on inconsistant data.</p>

<h2>The fix</h2>

<p>This was fixed rather simle, instead of overwriting existing data on a handoff, the handoff is now treated as a read-repair and old and existing data is merged.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Heinz N. 'Licenser' Gies</span></span>

      








  


<time datetime="2014-11-28T19:20:34+01:00" pubdate data-updated="true">Nov 28<span>th</span>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.licenser.net/blog/2014/11/28/postmortom-of-a-interesting-bug/" data-via="heinz_gies" data-counturl="http://blog.licenser.net/blog/2014/11/28/postmortom-of-a-interesting-bug/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/02/02/postmortem-of-a-interesting-bug/" title="Previous Post: Post-mortem of a failed support case.">&laquo; Post-mortem of a failed support case.</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/28/postmortom-of-a-interesting-bug/">Postmortom of a Interesting Bug</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/02/postmortem-of-a-interesting-bug/">Post-mortem of a Failed Support Case.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/01/backups-with-project-fifo/">Backups With Project FiFo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/13/a-asynchronous-gced-or-set/">A Asynchronously GCed or Set</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/11/asyncronous-garbage-collection-with-crdts/">Asynchronous Garbage Collection With CRDTs</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/Licenser">@Licenser</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'Licenser',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Heinz N. 'Licenser' Gies -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lice';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.licenser.net/blog/2014/11/28/postmortom-of-a-interesting-bug/';
        var disqus_url = 'http://blog.licenser.net/blog/2014/11/28/postmortom-of-a-interesting-bug/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
