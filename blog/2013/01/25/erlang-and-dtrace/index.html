
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Erlang and DTrace - Lice!</title>
  <meta name="author" content="Heinz N. 'Licenser' Gies">

  
  <meta name="description" content="As part of Project FiFo I&rsquo;ve invested some time to research into DTrace and Erlang, not the probes that are there since some time but a DTrace &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.licenser.net/blog/2013/01/25/erlang-and-dtrace">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Lice!" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31493882-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Lice!</a></h1>
  
    <h2>...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.licenser.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Erlang and DTrace</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-25T00:21:00+01:00" pubdate data-updated="true">Jan 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>As part of <a href="http://project-fifo.net">Project FiFo</a> I&rsquo;ve invested some time to research into DTrace and Erlang, not the probes that are there since some time but a DTrace consumer &ndash; letting you execute DTrace scripts from within Erlang and read the results.</p>

<p>The result of this research is the <a href="https://www.github.com/project-fifo/erltrace">erltrace</a> a consumer for DTrace implemented as a Erlang NIF. The NIF is based on the <a href="https://github.com/bcantrill/node-libdtrace">node.js</a> and and <a href="http://tmetsch.github.com/python-dtrace/">python</a> implementations &ndash; many thanks to them!</p>

<p>It&rsquo;s pretty easy to consume dtrace data from within erlang with <a href="https://www.github.com/project-fifo/erltrace">erltrace</a> and I figured lets make a little demo. Since I&rsquo;m not a big fan of reinventing the wheel and a simple demo had been done before, namely <a href="http://howtonode.org/heat-tracer">heat-tracer</a>.</p>

<p>It&rsquo;s a nice idea and simple enough to implement and cowboy gives a very nice base for that in Erlang. So there you go <a href="https://github.com/Licenser/dowboy">dowboy</a>. The HTML/JS part of the page is pretty much the same as in the original save for replacing socket.io with simple websockets, I&rsquo;ll skip this and the the cowboy parts to look directly in the interesting parts.</p>

<p>When connecting we set up a timer to inform us every second to gather the results from DTrace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">websocket_init</span><span class="p">(_</span><span class="nv">Any</span><span class="p">,</span> <span class="nv">Req</span><span class="p">,</span> <span class="p">[])</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nn">timer</span><span class="p">:</span><span class="nf">send_interval</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tick</span><span class="p">),</span>
</span><span class='line'>  <span class="nv">Req2</span> <span class="o">=</span> <span class="nn">cowboy_http_req</span><span class="p">:</span><span class="nf">compact</span><span class="p">(</span><span class="nv">Req</span><span class="p">),</span>
</span><span class='line'>  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Req2</span><span class="p">,</span> <span class="n">undefined</span><span class="p">,</span> <span class="n">hibernate</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next up we handle incoming Websockets messages, this deals very simple. Every string that is send is considered a new dtrace script to execute.</p>

<p>The first part creates a new handler, this is pretty much a reference to the libdtrace internal data structures. Since we allow multiple scripts to be send we also have to ensure that the old sockets are closed before new ones are opened.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">websocket_handle</span><span class="p">({</span><span class="n">text</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">},</span> <span class="nv">Req</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c">%% We create a new handler</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Handle</span><span class="p">}</span> <span class="o">=</span> <span class="k">case</span> <span class="nv">State</span> <span class="k">of</span>
</span><span class='line'>                       <span class="n">undefined</span> <span class="o">-&gt;</span>
</span><span class='line'>                           <span class="nn">erltrace</span><span class="p">:</span><span class="nf">open</span><span class="p">();</span>
</span><span class='line'>                       <span class="p">{</span><span class="nv">Old</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>                           <span class="c">%% But we want to make sure that any old one is closed first.</span>
</span><span class='line'>                           <span class="nn">erltrace</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Old</span><span class="p">),</span>
</span><span class='line'>                           <span class="nn">erltrace</span><span class="p">:</span><span class="nf">open</span><span class="p">()</span>
</span><span class='line'>                   <span class="k">end</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we compile the dtrace script, <a href="https://www.github.com/project-fifo/erltrace">erltrace</a> only takes lists as strings and not binaries so we&rsquo;ve to convert it first and then we pass it along with our handle to get the script compiled. It will return <code>ok</code> if everything went well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%% We&#39;ve to confert cowboys binary to a list.</span>
</span><span class='line'><span class="nv">Msg1</span> <span class="o">=</span> <span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">Msg</span><span class="p">),</span>
</span><span class='line'><span class="n">ok</span> <span class="o">=</span> <span class="nn">erltrace</span><span class="p">:</span><span class="nf">compile</span><span class="p">(</span><span class="nv">Handle</span><span class="p">,</span> <span class="nv">Msg1</span><span class="p">),</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okay now that we&rsquo;ve compiled the script we just need to tell dtrace to start running it, this happens with the <code>erltrace:go</code> call. Again it will return <code>ok</code> when everything is fine. Finally we just output the script as debug info and return.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="n">ok</span> <span class="o">=</span> <span class="nn">erltrace</span><span class="p">:</span><span class="nf">go</span><span class="p">(</span><span class="nv">Handle</span><span class="p">),</span>
</span><span class='line'><span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;SCRIPT&gt; </span><span class="si">~s~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Msg</span><span class="p">]),</span>
</span><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Req</span><span class="p">,</span> <span class="p">{</span><span class="nv">Msg1</span><span class="p">,</span> <span class="nv">Handle</span><span class="p">}};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next up: reading the dtrace data, <code>erltrace:walk</code> do that for you and hand back a datastructur to parse. It is returned as <code>{ok, Data}</code> when there is something to handle.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">websocket_info</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="nv">Req</span><span class="p">,</span> <span class="p">{</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">Handle</span><span class="p">}</span> <span class="o">=</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>     <span class="k">case</span> <span class="nn">erltrace</span><span class="p">:</span><span class="nf">walk</span><span class="p">(</span><span class="nv">Handle</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>         <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">R</span><span class="p">}</span> <span class="o">-&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now since we have JSON on the other side we need to transform the data here Erlangs list comprehensions come to the rescue. Data is returned as <code>[{lquantize, [Name], { {BucketStart, BucketEnd
}, BucketCount}}]</code> and we want it in the form <code>{Name, [[BucketStart, BucketEnd], BucketCount]</code> so here you go. We can tehn simpley encode this with <a href="https://github.com/talentdeficit/jsx">jsx</a> and send it over the wire:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'>         <span class="nv">JSON</span> <span class="o">=</span> <span class="p">[{</span><span class="nb">list_to_binary</span><span class="p">(</span><span class="nv">Call</span><span class="p">),[</span> <span class="p">[[</span><span class="nv">S</span><span class="p">,</span> <span class="nv">E</span><span class="p">],</span> <span class="nv">V</span><span class="p">]||</span> <span class="p">{</span> <span class="p">{</span><span class="nv">S</span><span class="p">,</span> <span class="nv">E</span><span class="p">},</span> <span class="nv">V</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Vs</span><span class="p">]}||</span> <span class="p">{</span><span class="n">lquantize</span><span class="p">,</span> <span class="p">[</span><span class="nv">Call</span><span class="p">],</span> <span class="nv">Vs</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">R</span><span class="p">],</span>
</span><span class='line'>         <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="p">{</span><span class="n">text</span><span class="p">,</span> <span class="nn">jsx</span><span class="p">:</span><span class="nf">encode</span><span class="p">(</span><span class="nv">JSON</span><span class="p">)},</span> <span class="nv">Req</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="n">hibernate</span><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ok</code> will be returned if there is no data yet to consume, we simply do nothing here.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'>     <span class="n">ok</span> <span class="o">-&gt;</span>
</span><span class='line'>         <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Req</span><span class="p">,</span> <span class="p">{</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">Handle1</span><span class="p">}};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last case is just for making things proper, if an error is returned we close stop the current handle and create a new one the same we did in the init.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'>     <span class="nv">Other</span> <span class="o">-&gt;</span>
</span><span class='line'>         <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">E</span><span class="p">]),</span>
</span><span class='line'>         <span class="k">try</span>
</span><span class='line'>             <span class="nn">erltrace</span><span class="p">:</span><span class="nf">stop</span><span class="p">(</span><span class="nv">Handle</span><span class="p">)</span>
</span><span class='line'>         <span class="k">catch</span>
</span><span class='line'>             <span class="p">_:_</span> <span class="o">-&gt;</span>
</span><span class='line'>                 <span class="n">ok</span>
</span><span class='line'>         <span class="k">end</span><span class="p">,</span>
</span><span class='line'>         <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Handle1</span><span class="p">}</span> <span class="o">=</span> <span class="nn">erltrace</span><span class="p">:</span><span class="nf">open</span><span class="p">(),</span>
</span><span class='line'>         <span class="nn">erltrace</span><span class="p">:</span><span class="nf">compile</span><span class="p">(</span><span class="nv">Handle1</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">),</span>
</span><span class='line'>         <span class="nn">erltrace</span><span class="p">:</span><span class="nf">go</span><span class="p">(</span><span class="nv">Handle</span><span class="p">),</span>
</span><span class='line'>         <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Req</span><span class="p">,</span> <span class="p">{</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">Handle1</span><span class="p">}}</span>
</span><span class='line'> <span class="k">end</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that all put together and run it on a dtrace capable machine we get a nice little heatmap that updates every second:</p>

<p><img src="/images/posts/2013-01-25-erlang-and-dtrace-heatmap.png" alt="Heatmap" /></p>

<p>Neat isn&rsquo;t it?</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Heinz N. 'Licenser' Gies</span></span>

      








  


<time datetime="2013-01-25T00:21:00+01:00" pubdate data-updated="true">Jan 25<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/dtrace/'>DTrace</a>, <a class='category' href='/blog/categories/erlang/'>Erlang</a>, <a class='category' href='/blog/categories/fifo/'>FiFo</a>, <a class='category' href='/blog/categories/smartos/'>SmartOS</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.licenser.net/blog/2013/01/25/erlang-and-dtrace/" data-via="heinz_gies" data-counturl="http://blog.licenser.net/blog/2013/01/25/erlang-and-dtrace/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/01/24/a-new-start/" title="Previous Post: A new start">&laquo; A new start</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/01/28/erlang-and-more-dtrace/" title="Next Post: Erlang and more DTrace">Erlang and more DTrace &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/28/postmortom-of-a-interesting-bug/">Postmortom of a Interesting Bug</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/02/post-mortem-of-a-failed-support-case/">Post-mortem of a Failed Support Case.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/01/backups-with-project-fifo/">Backups With Project FiFo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/13/a-asynchronous-gced-or-set/">A Asynchronously GCed or Set</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/11/asyncronous-garbage-collection-with-crdts/">Asynchronous Garbage Collection With CRDTs</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/Licenser">@Licenser</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'Licenser',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Heinz N. 'Licenser' Gies -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lice';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.licenser.net/blog/2013/01/25/erlang-and-dtrace/';
        var disqus_url = 'http://blog.licenser.net/blog/2013/01/25/erlang-and-dtrace/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
