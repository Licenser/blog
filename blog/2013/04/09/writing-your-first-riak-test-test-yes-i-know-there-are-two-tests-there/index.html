
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Writing Your First Riak Test Test (Yes I Know There Are Two Tests There) - Lice!</title>
  <meta name="author" content="Heinz N. 'Licenser' Gies">

  
  <meta name="description" content="As promised in a previous post I&rsquo;ll talk a bit about writing tests for riak_test. To start with the obvious it&rsquo;s pretty simple and pretty &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.licenser.net/blog/2013/04/09/writing-your-first-riak-test-test-yes-i-know-there-are-two-tests-there/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Lice!" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31493882-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Lice!</a></h1>
  
    <h2>&#8230;</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.licenser.net">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Writing Your First Riak Test Test (Yes I Know There Are Two Tests There)</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2013-04-09T23:33:00+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>11:33 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>As promised in a <a href="/blog/2013/03/31/getting-started-with-riak-test-and-riak-core/">previous post</a> I&rsquo;ll talk a bit about writing tests for <code>riak_test</code>. To start with the obvious it&rsquo;s pretty simple and pretty awesome. <code>riak_test</code> gives you the tools you&rsquo;ve dreamed of when testing distributed <code>riak_core</code> applications:</p>

<ul>
<li>a backchannel to communicate and execute commands on the nodes.</li>
<li>a nice and way to bring up and tear down the test environment.</li>
<li>helper functions to deal with the <code>riak_core</code> cluster.</li>
<li>something called <code>intercepts</code> that allow you to mock certain behaviours in the cluster.</li>
<li>all the power of Erlang.</li>
</ul>


<h2>How a test works</h2>

<p>Tests have a very simple structre they pretty much contain a single function: <code>confirm/0</code></p>

<p>This function gets called when the test is executed and should return <code>pass</code> when everything works well or throw an exception when not. The actual test are simple unit asserts you use.</p>

<p>That in itself is not really overly exciting and those of you with a short attention span might start to thing &lsquo;boooooooring&rsquo; so lets look at the exciting part.</p>

<h2>Starting your applicatio</h2>

<p><code>riak_test</code> offers a way to start instances of your application and communicate with them, the common pattern is to start one (or more) nodes as first part of the script and check of they are up and running. That could look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">confirm</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">Node</span><span class="p">]</span> <span class="o">=</span> <span class="nn">rt</span><span class="p">:</span><span class="nf">deploy_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span class='line'>    <span class="o">?</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span> <span class="nn">rt</span><span class="p">:</span><span class="nf">wait_until_nodes_ready</span><span class="p">([</span><span class="nv">Node</span><span class="p">])),</span>
</span><span class='line'>    <span class="n">pass</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a minimal test it sets up one instance of our application and waits for it to be ready.</p>

<p><code>rt:deploy_nodes(1)</code> will deploy one node, the id of the node (a atom with that identifies it to erlang) will be sotred in <code>Node</code>, you can deploy more nodes by increasing the number in <code>rt:deploy_nodes/1</code>.</p>

<p><code>?assertEqual(ok, rt:wait_until_nodes_ready([Node]))</code> will make the test wait for the nodes to be ready, ready here means that all ring services we defined in the config are provided.</p>

<p>The node will be running in its own Erlang VM and have the test suite connected as a hidden node. This is the first thing that is truly interesting, since the connection will allow us to run rpc calls on the node this is the first thing that is truly fun.</p>

<h2>An official channel</h2>

<p>Now we&rsquo;ve a basic test running have our nodes to be started up and the test waiting until all is started and happy.</p>

<p>So chances are that aside of this back channel communication the node provides some kind of API, and we want to be able to connect to this API to run our tests. Un my case it&rsquo;s a simple TCP port that announces itself over mdns, we could simply listen to the broadcast and use the information it provides to talk to the node. This would work, as long as we&rsquo;ve a single node, the moment we&rsquo;ve to we would never know which node we&rsquo;re talking to and that would make testing hard.</p>

<p>So backchannel to the rescue! We&rsquo;ll just get the nodes configuration from the host, for my application I store this kind of information in the application configuration so I&rsquo;ve made a function that given a <code>Node</code> returns <code>IP</code> and <code>Port</code> for it to talk to plus one to send data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">node_endpoing</span><span class="p">(</span><span class="nv">Node</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">IP</span><span class="p">}</span> <span class="o">=</span> <span class="nn">rpc</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">get_env</span><span class="p">,</span> <span class="p">[</span><span class="n">mdns_server_lib</span><span class="p">,</span> <span class="n">ip</span><span class="p">]),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Port</span><span class="p">}</span> <span class="o">=</span> <span class="nn">rpc</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">get_env</span><span class="p">,</span> <span class="p">[</span><span class="n">mdns_server_lib</span><span class="p">,</span> <span class="n">port</span><span class="p">]),</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">IP</span><span class="p">,</span> <span class="nv">Port</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">IP</span><span class="p">,</span> <span class="nv">Port</span><span class="p">}</span> <span class="o">=</span> <span class="n">node_endpoing</span><span class="p">(</span><span class="nv">Node</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">lager</span><span class="p">:</span><span class="nf">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">~s</span><span class="s">:</span><span class="si">~p</span><span class="s"> &lt;- </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">IP</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">]),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">connect</span><span class="p">(</span><span class="nv">IP</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">,</span> <span class="p">{</span><span class="n">active</span><span class="p">,</span><span class="n">false</span><span class="p">},</span> <span class="p">{</span><span class="n">packet</span><span class="p">,</span><span class="mi">4</span><span class="p">}],</span> <span class="mi">100</span><span class="p">),</span>
</span><span class='line'>    <span class="n">ok</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nb">term_to_binary</span><span class="p">(</span><span class="nv">Msg</span><span class="p">)),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Repl</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">recv</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Res</span><span class="p">}</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Repl</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">lager</span><span class="p">:</span><span class="nf">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">~s</span><span class="s">:</span><span class="si">~p</span><span class="s"> -&gt; </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">IP</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">Res</span><span class="p">]),</span>
</span><span class='line'>    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Res</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is some <code>gen_tcp</code> stuff in there but lets just ignore it for now it&rsquo;s detail not important, the first function is the more interesting one it uses the <code>rpc</code> module to execute the commands on the node we just started which is quite awesome.</p>

<p>As a note I&rsquo;ve put those functions into <code>rt_&lt;applicatin name&gt;</code> so for example rt_sniffle.</p>

<h2>Testing the API</h2>

<p>With <code>call/2</code> we&rsquo;ve now a way to send data directly to the node over the official API channel so lets add to our test. So lets get back to our <code>confirm/0</code> and add some real tests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">confirm</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">Node</span><span class="p">]</span> <span class="o">=</span> <span class="nn">rt</span><span class="p">:</span><span class="nf">deploy_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span class='line'>    <span class="o">?</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span> <span class="nn">rt</span><span class="p">:</span><span class="nf">wait_until_nodes_ready</span><span class="p">([</span><span class="nv">Node</span><span class="p">])),</span>
</span><span class='line'>    <span class="o">?</span><span class="n">assertEqual</span><span class="p">({</span><span class="n">ok</span><span class="p">,[]},</span>
</span><span class='line'>                 <span class="nn">rt_sniffle</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="p">{</span><span class="n">vm</span><span class="p">,</span> <span class="n">list</span><span class="p">})),</span>
</span><span class='line'>    <span class="o">?</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span>
</span><span class='line'>                 <span class="nn">rt_sniffle</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="p">{</span><span class="n">vm</span><span class="p">,</span> <span class="nb">register</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;vmid&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;hypervisor&quot;</span><span class="o">&gt;&gt;</span><span class="p">})),</span>
</span><span class='line'>    <span class="o">?</span><span class="n">assertEqual</span><span class="p">({</span><span class="n">ok</span><span class="p">,[</span><span class="o">&lt;&lt;</span><span class="s">&quot;vmid&quot;</span><span class="o">&gt;&gt;</span><span class="p">]},</span>
</span><span class='line'>                 <span class="nn">rt_sniffle</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="p">{</span><span class="n">vm</span><span class="p">,</span> <span class="n">list</span><span class="p">})),</span>
</span><span class='line'>    <span class="n">pass</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s as easy as this, this test will</p>

<ul>
<li>List the registered VM&rsquo;s and expect none to be there.</li>
<li>Create a new VM and expect a ok result.</li>
<li>List the registered vm&rsquo;s and expect the one we just registered to be present.</li>
</ul>


<p>And that&rsquo;s it for basic testing with <code>riak_test</code> I&rsquo;ll follow up on this with an article over intercepts since they add another cool feature to <code>riak_test</code>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Heinz N. &#8216;Licenser&#8217; Gies</span></span>

      




<time class='entry-date' datetime='2013-04-09T23:33:00+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2013</span></span> <span class='time'>11:33 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/erlang/'>erlang</a>, <a class='category' href='/blog/categories/project-fifo/'>project-fifo</a>, <a class='category' href='/blog/categories/riak/'>riak</a>, <a class='category' href='/blog/categories/riak-test/'>riak_test</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.licenser.net/blog/2013/04/09/writing-your-first-riak-test-test-yes-i-know-there-are-two-tests-there/" data-via="heinz_gies" data-counturl="http://blog.licenser.net/blog/2013/04/09/writing-your-first-riak-test-test-yes-i-know-there-are-two-tests-there/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/03/31/getting-started-with-riak-test-and-riak-core/" title="Previous Post: Getting started with riak_test and riak_core">&laquo; Getting started with riak_test and riak_core</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/04/23/fifo-plus-80loc-of-bash-equals-5-node-riak-cluster/" title="Next Post: FiFo + 80LOC of bash = 5 node riak cluster">FiFo + 80LOC of bash = 5 node riak cluster &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/07/10/migrating-to-rebar3/">Migrating to Rebar3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/28/postmortem-of-a-interesting-bug/">Postmortem of a Interesting Bug</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/02/post-mortem-of-a-failed-support-case/">Post-mortem of a Failed Support Case.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/01/backups-with-project-fifo/">Backups With Project FiFo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/13/a-asynchronous-gced-or-set/">A Asynchronously GCed or Set</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/Licenser">@Licenser</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'Licenser',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Heinz N. &#8216;Licenser&#8217; Gies -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lice';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.licenser.net/blog/2013/04/09/writing-your-first-riak-test-test-yes-i-know-there-are-two-tests-there/';
        var disqus_url = 'http://blog.licenser.net/blog/2013/04/09/writing-your-first-riak-test-test-yes-i-know-there-are-two-tests-there/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
