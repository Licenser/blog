
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Lice!</title>
  <meta name="author" content="Heinz N. 'Licenser' Gies">

  
  <meta name="description" content="Symptoms After a full network outage in a larger system (7 FiFo instances and, a few dozen of hypervisors, VM&rsquo;s in the 3 digit number) a small &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.licenser.net">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Lice!" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31493882-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Lice!</a></h1>
  
    <h2>...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.licenser.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/28/postmortom-of-a-interesting-bug/">Postmortom of a Interesting Bug</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-28T19:20:34+01:00" pubdate data-updated="true">Nov 28<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Symptoms</h2>

<p>After a full network outage in a larger system (7 FiFo instances and, a few dozen of hypervisors, VM&rsquo;s in the 3 digit number) a small percentage of the VM&rsquo;s stored in FiFo lost information which package was assigned to them and which organization they belong to.</p>

<h2>Technical background</h2>

<p>As part of planned maintenance on the switching layer the entire network was taken down. Effectively cutting the communication between any two systems in the network.  During the maintenance the FiFo system was kept &lsquo;hot&rsquo;, no services disabled or paused. At the end of the maintenance window the network was as planned enabled again, reinstating communications.</p>

<h2>FiFo background</h2>

<p>We will focus in the sniffle and chunter components since those are the relevant parts of sniffle that handle information related to the symptoms.</p>

<p>Generally all fifo data is stored in CRDT&rsquo;s which provides conflict resolution and nearly loss free merging even of entirely devergent data.</p>

<h3>Sniffle</h3>

<p>Sniffle is a distributed system that runs on top of riak_core, all (7) nodes are connected as a mash network via distributed erlang. While the nodes are connected data and functionality is split out in dynamo fashion, at a default N value of 3 that means every node handles (total data)*3/7 of the data.</p>

<p>In the case of a node failure the adjacent node takes over the function of the failed node. Missing data is resolved by a method called &lsquo;read repair&rsquo;, meaning taht when data is requested and 1 out of the 3 nodes responds with no data that &lsquo;missing&rsquo; data is repaired.</p>

<p>Once the node failure is repaird the system that took over the work for the failed node performs what is called a handoff, sending it&rsquo;s (suposedly) updated data to the returning node to bring it up to speed.</p>

<h3>Chunter</h3>

<p>Under normal conditions chunter will send incremental updates about changing vm state to sniffle. If a chunter system for the first time connects to sniffle it will register it&rsquo;s VM&rsquo;s, meaning they are created if not existant, and assigned to the hypervisor. The registration contains nearly all relevent VM information with some exceptions that do not concern the hypervisor. The missing information was amongst the not updated information.</p>

<p>Sniffle nodes are discovered via mdns broadcasts, the first broadcast recived will trigger the inital registration sending the request to this node.</p>

<h2>What happened?</h2>

<p>It is a combination of conditions that lead to the problem and explains why  only a small percentage of VM&rsquo;s was affected.</p>

<h3>During the outage</h3>

<p>1) The network outage cut the communicaiton between <strong>all</strong> sniffle nodes, so each node was on it&rsquo;s own handeling the full load of the requests.
2) The network outage cut communication of <strong>nearly all</strong> chunter nodes, only those who resided on a hypervisor that also contained a fifo zone did not loose conectivity.</p>

<h3>After the outage</h3>

<p>Now there happend a race condition, on one side the distributed erlang started to re-discover the other nodes, reistablising communicaiton in sniffle and initializing handoffs (handoffs of nearly all parts).</p>

<p>On the other side the periodic mDNS broadcasts from the sniffle nodes triggered re-registration of the chunter nodes.</p>

<h3>The bug</h3>

<p>The bug was triggered by the fact that during reciving a handoff a vnode took the wrong assumption that the recived data must be newer then it&rsquo;s own and overwrite the currently stored data instead of merging it.</p>

<p>Due to the usual repair during reads this turned out to be qutie a edge case that was only triggered when:</p>

<p>1) the mDNS was recived from a node that neither holds the right partition, neither is connected to a node holding the right partition.
2) the registration happend to three vnodes that did not hold that data since as long as one node held the data it would have been merged with this instead of re-created
3) the handoff on all three systems was performed before any read happend, since the read-repair would haver otherwise merged the data.
4) the handoff off all three systems was performed before AAE triggered, since AAE triggers a read-repair on inconsistant data.</p>

<h2>The fix</h2>

<p>This was fixed rather simle, instead of overwriting existing data on a handoff, the handoff is now treated as a read-repair and old and existing data is merged.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/02/postmortem-of-a-interesting-bug/">Post-mortem of a Failed Support Case.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-02T05:27:27+01:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Every now and then I check the link reports for Project FiFo to see what people think and write about it. Recently I stumbled about <a href="http://consulting.miracleas.dk/blog/post/2014/01/17/Quick-and-Dirty-spawned-LightlyCloudy!.aspx">an article</a> that oddly enough made me both proud and sad. It actually was a rather negative one, which is a shame, but on the other hand a project isn&rsquo;t mature until people care enough to complain.</p>

<p>Yet even so it would be very easy to cast this aside as a &lsquo;success&rsquo; in a strange manner, it still bothers me that someone is upset enough with FiFo to spend his time writing a longish blog article and write their own management software. I do take great pride in the fact that we do our best to have a outstanding documentation and a good support for users of FiFo, and I dare to say so does anyone else who is involved in the project.</p>

<p>So armed with the full history of events  plus the additional background from the <a href="http://consulting.miracleas.dk/blog/post/2014/01/17/Quick-and-Dirty-spawned-LightlyCloudy!.aspx">article</a> mentioned above I want to try a post mortal analysis of this support case, what went wrong and how it could be avoided. I obviously will try to be as impartial as I can be but in the end I can only look at what I see. Hopefully there is a lesson to be learned from this so next time things went smoother.</p>

<p>As a disclaimer: the problem is still a mystery and will probably remain so forever. Also all documentation linked is from the time the bug was filed (thanks for versioning) to give a fair picture of what was available back then.</p>

<h1>Act 3 &ndash; the mailing list</h1>

<p>The history of this case starts a bit into the history of the whole story, but for now lets skip the first part and look at the first time we (as in the FiFo team) came aware of the problem: <a href="https://groups.google.com/forum/#!topic/project-fifo/MZJYOs-CtP8">A mail to the mailing list and the conversation following it</a>.</p>

<p>Sadly the initial mail gives every little to no information on the problem aside that &lsquo;not firing on all cylinders/Suddenly FiFo stopped working all by it self&rsquo;. I must admit that for me such a thing is a big red flag that the person on the other end does not care much or is not willing to invest energy into finding the problem, looking from today and after reading the articles on Gordon&rsquo;s blog it might as well just have been the kind of humor used, we will never know.</p>

<p>But fortunately I am not the only one on the mailing list and others are slower to judge and have more patience and Mark jumped in to help and tried to help, starting to ask for additional information that were missing from the original mail. After the information not showing any additional evidence that could lead to a easy conclusion Marks ask for him to take a look at <a href="http://project-fifo.net/pages/viewpage.action?pageId=8126470">FiFo&rsquo;s Problem Checklist</a> and come to the IRC channel to help further.</p>

<h2>Act 3 conclusion</h2>

<p>Mark replied to the initial mail within less then an hour which is a truly amazing response time that can put most commercial support to shame request to go through the checklist and join the channel for a more direct help is a very good approach.</p>

<p>Since I can actually look into my head I shed a bit more light on my take at the point, I decided to opt out of that request at that moment since Mark seemed to have it covered and the tone of the mail already made me sort it in a bucket of &lsquo;going to be annoying&rsquo;. So I probably should not judge as fast.</p>

<p>To receive the best possible support there are some things Gordon could have done, the initial mail could have contained more information, the tone could have been different &ndash; jokes often communicate badly over written text, and following Marks request to go through the checklist had probably helped too if only to get some additional facts for later.</p>

<h1>Act 4 &ndash; IRC</h1>

<p>Marks suggested to swap to IRC for a quicker communication, we all hate mail ping pong I guess. Fortunately we <a href="http://echelog.com/logs/browse/project-fifo/1382914800">keep logs</a> of the FiFo channel to make it easy to google for known problems that were discussed before &ndash; in this case it allows us to look at the conversation between Mark (aka trentster) and Gordon (g-flemming).</p>

<p>This is pretty uneventful mark asks a few more questions to rule out common errors none of which seem to be the cause. At this point Mark asks to escalate the issue and file a ticket with the logs and offers the suggestion to move to a newer version of FiFo (the development build at that time) along with <a href="http://project-fifo.net/pages/viewpage.action?pageId=7176245">the manual containing steps necessary to do this</a>. The reasoning being that the development build is quite well tested with multiple people (including Mark and myself) running it.</p>

<h2>Act 4 conclusions</h2>

<p>Things are still pretty well at this point, our escalation process seems to work wonderfully and the resources of the documentation hold a lot of valuable information.</p>

<p>This is where the story ends for Mark and to all honestly he did an astonishing job to support here and escalate when he ran out of ways to help.</p>

<p>On the channel Gordon mentions the first time that he is running FiFo with customer on it this indicates some urgency on the matter and at least I missed that line. Sadly so he did not seem to have went through the troubleshooting steps or read the update documentation.</p>

<p>The lesson to learn here for us is to either ask people to include a IRC log in a new ticket or do it ourselves after they create it, this might have added some additional info to the ticket that was not present when it was created.</p>

<h1>Act 5 &ndash; The ticketing system</h1>

<p>Now this is where my part in the story starts, just as before I&rsquo;ll try to give some additional insight on what I was thinking at this time to shed a bit of light on my end &ndash; I obviously can&rsquo;t do the same for Gordon.</p>

<p>As asked by Mark Gordon created a <a href="http://jira.project-fifo.net/browse/FIFO-142">JIRA Ticket</a> with the logs. When seeing the ticket I had already read the mailing list but not the IRC backlog (I don&rsquo;t always do that since I don&rsquo;t want to spend too much time reading old things that might not even affect me). From the ML I have already an unhappy feeling towards the issue as it looked to me that Gordon was not willing to put much effort into resolving the issue.</p>

<p>Non the less I take a look at the logs and trie to pice together what exactly happened, up to this date I do not know what it was. The suggestions were pretty close to what Mark suggested earlier, a problem with too little memory or the filesystem the error in the logs <code>einval</code> hinted to some issue with a POSIX filesystem call.</p>

<p>And at this point things are going wrong, lacking the information that there are production users on the system I make the mistake to judge the issue as non urgent especially after the full reply from Gordon takes a day. At that point I pretty much stop caring about the issue since I feel neither does Gordon (which is a grave misjudgment as it turns out). I revisit the issue only one week later at which point I now can only assume Gordon had given up and in a last attempt to provide a direction suggest looking at FS errors, missing the question asked in Gordon&rsquo;s reply.</p>

<p>Gordon makes the mistake of not reading the documentation Mark gave him earlier or the question he posted next day would have already been answered and probably waiting a day with replying to the question.</p>

<h2>Act 5 conclusion</h2>

<p>I need to stop drawing conclusions so quickly and read bug requests more carefully or I would not have missed the migration question in the bug report. It would also be worth a try not to treat less urgent tickets with less care, it sucks to have tickets open the goal should be to close (as in resolve) then as soon as possible even if they seem not urgent &ndash; this applies especially to bugs.</p>

<p>Gordon could have made his own life a lot easier by including more information in the ticket, noting that it is a urgent issue, including the history of what he already did to debug would have both helped a lot. In addition to that actually reading the documentation Mark provided would have answered the migration question beforehand.</p>

<p>Mark while out of the picture already could have included the chat history in the ticket when seeing that Gordon did not &ndash; this admittedly is asking a lot.</p>

<h1>Act 0 &ndash; how everything started</h1>

<p>I know this is the wrong order, but Star Wars got away with it too. Now after the fact I know more then I did before. Reading Gordon&rsquo;s blog posts shed some light on the history and I think this is where actually things started to go wrong.</p>

<p>I am glad for every person choosing to try out FiFo, it means people put trust in what we&rsquo;ve build and that is a really cool thing. But please if you want to use something in production inform yourself ahead of time. Don&rsquo;t put yourself and your customers at risk by blindly running into things.</p>

<p>Talk to us, even before you start deploying! We know FiFo inside out, everyone in the FiFo team is running it themselves either for fun, for profit, for testing or for all three things. The channel is helpful too, there are more people outside the core team on the channel too who will gladly share their stories.</p>

<p>To put this straight, you&rsquo;ll not only get the software for free you will even get some &ldquo;consulting&rdquo; tossed in the mix for not anything more then just asking! That is of cause in a sensible limit and given we have time, but there is always half an hour to spare here or there.</p>

<h2>Act 0 conclusions</h2>

<p>Deploying in a single node for a production system was not the best move, FiFo clusters for a reason and a distributed setup has many advantages over a single node. Probably some of the config settings could have been tweaked for a better user experience. It might have even made sense to run on dev instead of release or at least to switch early.</p>

<p>Had we known the surrounding circumstances helping might have been a lot easier.</p>

<h1>Act 1 &ndash; be active in the community</h1>

<p>There is a huge advantage to this. And I don&rsquo;t even mean the fact that the community grows and everyone benefits. Being present in the channel and occasionally talking to people helps you to stay in the loop, know what is going on and what other people face for problems or find for solutions.</p>

<p>It also gives the benefit to influence the course of the project, a lot of the features were thought up and discussed within the community. And last but not least being active might actually end up in helping others, which will make the community as a while stronger.</p>

<h2>Act 1 conclusion</h2>

<p>I admit I am totally biased here. Everyones time is limited. When I have to chose to help a stranger I have no idea who it is or someone I know and has contributed in one way or another to the community I will pick the community member every time.</p>

<p>I can only talk for me here but I know for a fact that if Gordon or one of his colleges had been around in the channel and were a known face I would have taken the problem more serious. That said I have no idea if that is good or bad that I put community members before strangers.</p>

<h1>Act 2 &ndash; read the fantastic manual</h1>

<p>As Gordon points out FiFo not a trivial application. And he is entirely right, it is not, and there are may reasons for that which I am not going to argue here if that is a good or bad thing I will simply state that I have thought long about every choice I did in FiFo and claim them to be sound.</p>

<p>But we are well aware that it is not a simple pice of software like a editor or something, that is why we put a lot of time and effort in providing a manual and an extensive set of informations surrounding it.</p>

<p>We have a fully fledged manual, guides for Installation, Migration, and update. Best practice articles for Scaling, Networking and clustering. Checklists for problems and known issues. A list of terminology, information about our versioning system, recorded trainings (admittedly not much) and videos on usage.</p>

<p>For people interested in developing we have API documentations, starter guides, a documented build process. We have a list of internal libraries, and specifications on data structures. A guide to plugins, the messaging system and how to write plugins.</p>

<p>And last but not least we even have <a href="http://project-fifo.net/pages/viewpage.action?pageId=4194636">a page in which we explain how to best submit a bug</a></p>

<h2>Act 2 conclusion</h2>

<p>Reading those documents this would probably have saved a lot of time and pain and the fifo team some work. This is a reoccurring problem that we sadly see way too often  &ndash; if anyone has suggestions how to encourage users to read manuals please share the holy grail.</p>

<p>The documents would have given good advice on how to set up a redundant fifo, how to check for problems and perhaps most importantly how to properly report a bug.</p>

<h1>The Rant</h1>

<p>Given I spent the last two years of my life working on Project FiFo I feel I am entitled to this. Bad bug reports are a pet peeve! And this was a prime example of one.</p>

<p>All the right signs were there, a entirely nonsensical title the catch phrases &lsquo;it stopped working&rsquo; and &lsquo;nothing had changed&rsquo;. I can&rsquo;t say if this is the one in a million where that was actually true but in all my time in IT I have never seen those words to be correct, nor have I ever heard from someone else that saw the mystical situation of something just stopping to work.</p>

<p>There was no usable information in there, no sign of interest to actually help the process of finding the root cause. Just because FiFo is free and there is no charge in using it does not mean my time is worth any less then yours, gladly help you with a problem but I&rsquo;ll expect some engagement in return. I do not like to have my time wasted by having to pull every but of information out of someones nose.</p>

<p>Bottom line is: If you don&rsquo;t care enough about your problem to put some effort into getting help I will not care enough to help.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/01/backups-with-project-fifo/">Backups With Project FiFo</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-01T12:15:37+01:00" pubdate data-updated="true">Jan 1<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>With 0.4.3 FiFo introduces support for <a href="http://www.leofs.org">LeoFS</a> and this allows for some quite nice new features. Most importantly it decouples FiFo&rsquo;s operations from storing big amounts of data which makes maintaining either of this much more sensible and scaling storage much more easy.</p>

<p>Then again while nice that is not the important part, just storing datasets somewhere else does not make much of a difference for most users but what LoeFS allows FiFo to store much more data then would be good in the old setup. &lsquo;A lot more&rsquo; here means pretty much as much as you can store.</p>

<p>So with this options 0.4.3 FiFo introduce backups! Backups complement the snapshots already in the system for quiet a while but while snapshots were made to stay on the hypervisor backups are supposed to be shipped off to LeoFS. This not only helps to keep the number of snapshots limited, does not count against the local quota but also widens the failure domain.</p>

<p>And to make it better there is a sensible concept about incremental and full backups, that said there are a few limitations to be aware of:</p>

<ul>
<li>Backups that stay on the hypervisor will count against the local quota.</li>
<li>Once a backup is moved away from the hypervisor it can&rsquo;t be restored without overwriting the current state.</li>
<li>Restoring a backup might mean first deleting the local zfs volume for the vm.</li>
</ul>


<p>But that aside that there are some very interesting things:</p>

<ul>
<li>While it&rsquo;s not possible to keep multiple branches with snapshots this is very well possible with backups.</li>
<li>It&rsquo;s possible to make a difference between incremental and full backups choosing between recovery speed or space efficiency.</li>
</ul>


<p>All that sums up to something quite awesome, it allows for proper grandfather backups concepts for VM&rsquo;s and they can even be scripted using the fifo python client. So here is an example how this could be done.</p>

<p>Lets quickly describe what we want to achieve:</p>

<ul>
<li>Every month we want a full backup.</li>
<li>Every week we want an incremental backup

<ul>
<li>for the first week in a month towards the monthly full backup</li>
<li>for other weeks to the previous week</li>
</ul>
</li>
<li>Every day we want a incremental backup

<ul>
<li>for the first day of a week from the week backup</li>
<li>for other days from the previous day</li>
</ul>
</li>
</ul>


<p>To allow for the incremental backups we need to keep some of the backups around:</p>

<ul>
<li>monthly until the first weekly was done.</li>
<li>weekly until the next weekly was done but not longer the the next monthly.</li>
<li>daily until the next daily but not longer then the next weekly or monthly.</li>
</ul>


<p>The FiFo backup code fortunately helps a lot with this, a important part of the logic is <em>&lsquo;create a incremental snapshot and delete its parent from the hypervisor&rsquo;</em> and that is exactly the behavior of the backup code when passing both a parent and requesting a delete.</p>

<p>Here some <a href="https://github.com/project-fifo/pyfi/blob/master/examples/backup.sh">code</a> (with some comments added):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'><span class="nv">fifo</span><span class="o">=</span>fifo
</span><span class='line'><span class="nv">vm</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>
</span><span class='line'><span class="k">case</span> <span class="nv">$1</span> in
</span><span class='line'>    monthly<span class="o">)</span>
</span><span class='line'>        <span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> create monthly
</span><span class='line'>        <span class="c"># After createing a new monthly snapshot we first delete the last weekly and daily backup</span>
</span><span class='line'>        <span class="nv">last_daily</span><span class="o">=</span><span class="k">$(</span><span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> list -pH --fmt uuid,local,comment | grep <span class="s1">&#39;daily&#39;</span> | grep <span class="s1">&#39;YES&#39;</span> | tail -1<span class="k">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&quot;$last_daily&quot;</span> <span class="o">]</span>
</span><span class='line'>        <span class="k">then</span>
</span><span class='line'><span class="k">            </span><span class="nv">daily_uuid</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$last_daily</span> | cut -d: -f1<span class="k">)</span>
</span><span class='line'>            <span class="c"># the -l flag tells FiFo to only remove the backup from the hypervisor.</span>
</span><span class='line'>            <span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> delete -l <span class="nv">$daily_uuid</span>
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'><span class="k">        </span><span class="nv">last_weekly</span><span class="o">=</span><span class="k">$(</span><span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> list -pH --fmt uuid,local,comment | grep <span class="s1">&#39;weekly&#39;</span> | grep <span class="s1">&#39;YES&#39;</span> | tail -1<span class="k">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&quot;$last_weekly&quot;</span> <span class="o">]</span>
</span><span class='line'>        <span class="k">then</span>
</span><span class='line'><span class="k">            </span><span class="nv">weekly_uuid</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$last_weekly</span> | cut -d: -f1<span class="k">)</span>
</span><span class='line'>            <span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> delete -l <span class="nv">$weekly_uuid</span>
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'>        ;;
</span><span class='line'>    weekly<span class="o">)</span>
</span><span class='line'>        <span class="nv">last_backup</span><span class="o">=</span><span class="k">$(</span><span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> list -pH --fmt uuid,local,comment | grep <span class="s1">&#39;monthly\|weekly&#39;</span> | grep <span class="s1">&#39;YES&#39;</span> | tail -1<span class="k">)</span>
</span><span class='line'>        <span class="nv">uuid</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$last_backup</span> | cut -d: -f1<span class="k">)</span>
</span><span class='line'>        <span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> create --parent <span class="nv">$uuid</span> -d weekly
</span><span class='line'>        <span class="c"># After creating a new weekly we need to make sure to delete the last daily one</span>
</span><span class='line'>        <span class="nv">last_daily</span><span class="o">=</span><span class="k">$(</span><span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> list -pH --fmt uuid,local,comment | grep <span class="s1">&#39;daily&#39;</span> | grep <span class="s1">&#39;YES&#39;</span> | tail -1<span class="k">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&quot;$last_daily&quot;</span> <span class="o">]</span>
</span><span class='line'>        <span class="k">then</span>
</span><span class='line'><span class="k">            </span><span class="nv">daily_uuid</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$last_daily</span> | cut -d: -f1<span class="k">)</span>
</span><span class='line'>            <span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> delete -l <span class="nv">$daily_uuid</span>
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'>        ;;
</span><span class='line'>    daily<span class="o">)</span>
</span><span class='line'>        <span class="nv">last_backup</span><span class="o">=</span><span class="k">$(</span><span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> list -pH --fmt uuid,local,comment | grep <span class="s1">&#39;daily\|weekly&#39;</span> | grep <span class="s1">&#39;YES&#39;</span> | tail -1<span class="k">)</span>
</span><span class='line'>        <span class="nv">uuid</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$last_backup</span> | cut -d: -f1<span class="k">)</span>
</span><span class='line'>        <span class="nb">type</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$last_backup</span> | cut -d: -f2<span class="k">)</span>
</span><span class='line'>        <span class="k">case</span> <span class="nv">$type</span> in
</span><span class='line'>            weekly<span class="o">)</span>
</span><span class='line'>                <span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> create --parent <span class="nv">$uuid</span> daily
</span><span class='line'>                ;;
</span><span class='line'>            daily<span class="o">)</span>
</span><span class='line'>                <span class="nv">$fifo</span> vms backups <span class="nv">$vm</span> create --parent <span class="nv">$uuid</span> -d daily
</span><span class='line'>                ;;
</span><span class='line'>        <span class="k">esac</span>
</span><span class='line'>        ;;
</span><span class='line'><span class="k">esac</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/13/a-asynchronous-gced-or-set/">A Asynchronously GCed or Set</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-13T11:09:00+02:00" pubdate data-updated="true">Jun 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Following the <a href="/blog/2013/06/11/asyncronous-garbage-collection-with-crdts/">article about Asynchronous garbage collection with CRDTs</a> I experimented with <a href="https://github.com/Licenser/ecrdt/blob/master/src/vorsetg.erl">implementing the concept</a>. The OR Set is a very nice data structure for this  since it&rsquo;s rather simple and so is it&rsquo;s garbage!</p>

<p>To garbage collect the <a href="https://github.com/Licenser/ecrdt/blob/master/src/vorset.erl">OR Set</a> we do the following, we take some of the elements of the remove set, and delete them from both the add and the remove set &ndash; this way we save the space for them and generate a new baseline.</p>

<p>First step was to implement the data structure described to hold the collectable items, I call it a <a href="https://github.com/Licenser/ecrdt/blob/master/src/rot.erl">ROT</a> (Roughly Ordered Tree) it&rsquo;s a nice name for garbage related stuff ;) and it is treeish and mostly ordered.</p>

<p>The interface of the ROT is rather simple, Elements must be time tagged, in the form {Time, Element}. Where time must not be a clock, as long as the Erlang comparison operations work on it to give an order. Then it allows asking for full buckets, and removing buckets based on their hash value and newest message timestamp.</p>

<p>While the elements in a the OR set area already tagged with a timestamp, this timestamp records addition, not deletion so it would be misleading to use them since the ROT would think the remove happened when actually the addition happened and this would violate the rule that no event can travel back behind T<sub>100</sub>. As a result we&rsquo;ll have to double timestamp the removes &ndash; as in add a second when when it was removed.</p>

<p>So since the ROT has a very similar interface to a G Set (which implemented the remove set before) the change is trivial. <strong>Remove</strong>, <strong>GC</strong> and the <strong>merge</strong> function are more interesting.</p>

<h3>remove</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">remove</span><span class="p">(</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">Element</span><span class="p">,</span> <span class="nv">ORSet</span> <span class="o">=</span> <span class="nl">#vorsetg</span><span class="p">{</span><span class="n">removes</span> <span class="o">=</span> <span class="nv">Removes</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">CurrentExisting</span> <span class="o">=</span> <span class="p">[</span><span class="nv">Elem</span> <span class="p">||</span> <span class="nv">Elem</span> <span class="o">=</span> <span class="p">{_,</span> <span class="nv">E1</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="n">raw_value</span><span class="p">(</span><span class="nv">ORSet</span><span class="p">),</span>
</span><span class='line'>                               <span class="nv">E1</span> <span class="o">=:=</span> <span class="nv">Element</span><span class="p">],</span>
</span><span class='line'>    <span class="nv">Removes1</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">foldl</span><span class="p">(</span><span class="k">fun</span><span class="p">(</span><span class="nv">R</span><span class="p">,</span> <span class="nv">Rs</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>                                   <span class="nn">rot</span><span class="p">:</span><span class="nf">add</span><span class="p">({</span><span class="nv">Id</span><span class="p">,</span> <span class="nv">R</span><span class="p">},</span> <span class="nv">Rs</span><span class="p">)</span>
</span><span class='line'>                           <span class="k">end</span><span class="p">,</span> <span class="nv">Removes</span><span class="p">,</span> <span class="nv">CurrentExisting</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">ORSet</span><span class="nl">#vorsetg</span><span class="p">{</span><span class="n">removes</span> <span class="o">=</span> <span class="nv">Removes1</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Id</code> defaults to a the current time in nanoseconds since it&rsquo;s precise enough for most cases, but can be given any value that provides timed order. Line 2 and 3 collect all observed and not yet removed instances of the element to delete, we then fold over those instances and add each of them to the ROT.</p>

<h3>GC</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">gc</span><span class="p">(</span><span class="nv">HashID</span><span class="p">,</span>
</span><span class='line'>   <span class="nl">#vorsetg</span><span class="p">{</span>
</span><span class='line'>      <span class="n">adds</span> <span class="o">=</span> <span class="nv">Adds</span><span class="p">,</span>
</span><span class='line'>      <span class="n">removes</span> <span class="o">=</span> <span class="nv">Removes</span><span class="p">,</span>
</span><span class='line'>      <span class="n">gced</span> <span class="o">=</span> <span class="nv">GCed</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Values</span><span class="p">,</span> <span class="nv">Removes1</span><span class="p">}</span> <span class="o">=</span> <span class="nn">rot</span><span class="p">:</span><span class="nf">remove</span><span class="p">(</span><span class="nv">HashID</span><span class="p">,</span> <span class="nv">Removes</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Values1</span> <span class="o">=</span> <span class="p">[</span><span class="nv">V</span> <span class="p">||</span> <span class="p">{_,</span> <span class="nv">V</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Values</span><span class="p">],</span>
</span><span class='line'>    <span class="nv">Values2</span> <span class="o">=</span> <span class="nn">ordsets</span><span class="p">:</span><span class="nf">from_list</span><span class="p">(</span><span class="nv">Values1</span><span class="p">),</span>
</span><span class='line'>    <span class="nl">#vorsetg</span><span class="p">{</span><span class="n">adds</span> <span class="o">=</span> <span class="nn">ordsets</span><span class="p">:</span><span class="nf">subtract</span><span class="p">(</span><span class="nv">Adds</span><span class="p">,</span> <span class="nv">Values2</span><span class="p">),</span>
</span><span class='line'>             <span class="n">gced</span> <span class="o">=</span> <span class="nn">ordsets</span><span class="p">:</span><span class="nf">add_element</span><span class="p">(</span><span class="nv">HashID</span><span class="p">,</span> <span class="nv">GCed</span><span class="p">),</span>
</span><span class='line'>             <span class="n">removes</span> <span class="o">=</span> <span class="nv">Removes1</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>To GC the set we take the <code>HashID</code>, this is what the rot returns when it reports full buckets, and in line 6 remove it from the ROT. Thankfully the ROT will return the content of the deleted bucket, this comes in very handy, since in the process of garbage collecting the bucket we also need to remove the items once and for all from the add list as seen in line 9. We then record the GC action in line 10 to make sure it will applied during a merge.</p>

<p>Please note that currently this set, even so it is garbage collected still grows without bounds since the GC actions themselves are not (yet) garbage collected, this will be added in a later iteration.</p>

<h3>merge</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">merge</span><span class="p">(</span><span class="nv">ROTA</span> <span class="o">=</span> <span class="nl">#vorsetg</span><span class="p">{</span><span class="n">gced</span> <span class="o">=</span> <span class="nv">GCedA</span><span class="p">},</span>
</span><span class='line'>      <span class="nv">ROTB</span> <span class="o">=</span> <span class="nl">#vorsetg</span><span class="p">{</span><span class="n">gced</span> <span class="o">=</span> <span class="nv">GCedB</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nl">#vorsetg</span><span class="p">{</span>
</span><span class='line'>       <span class="n">adds</span> <span class="o">=</span> <span class="nv">AddsA</span><span class="p">,</span>
</span><span class='line'>       <span class="n">gced</span> <span class="o">=</span> <span class="nv">GCed</span><span class="p">,</span>
</span><span class='line'>       <span class="n">removes</span> <span class="o">=</span> <span class="nv">RemovesA</span><span class="p">}</span>
</span><span class='line'>        <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">foldl</span><span class="p">(</span><span class="k">fun</span> <span class="n">gc</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nv">ROTA</span><span class="p">,</span> <span class="nv">GCedB</span><span class="p">),</span>
</span><span class='line'>    <span class="nl">#vorsetg</span><span class="p">{</span>
</span><span class='line'>       <span class="n">adds</span> <span class="o">=</span> <span class="nv">AddsB</span><span class="p">,</span>
</span><span class='line'>       <span class="n">removes</span> <span class="o">=</span> <span class="nv">RemovesB</span><span class="p">}</span>
</span><span class='line'>        <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">foldl</span><span class="p">(</span><span class="k">fun</span> <span class="n">gc</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nv">ROTB</span><span class="p">,</span> <span class="nv">GCedA</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">ROT1</span> <span class="o">=</span> <span class="nn">rot</span><span class="p">:</span><span class="nf">merge</span><span class="p">(</span><span class="nv">RemovesA</span><span class="p">,</span> <span class="nv">RemovesB</span><span class="p">),</span>
</span><span class='line'>    <span class="nl">#vorsetg</span><span class="p">{</span><span class="n">adds</span> <span class="o">=</span> <span class="nn">ordsets</span><span class="p">:</span><span class="nf">union</span><span class="p">(</span><span class="nv">AddsA</span><span class="p">,</span> <span class="nv">AddsB</span><span class="p">),</span>
</span><span class='line'>             <span class="n">gced</span> <span class="o">=</span> <span class="nv">GCed</span><span class="p">,</span>
</span><span class='line'>             <span class="n">removes</span> <span class="o">=</span> <span class="nv">ROT1</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Merging gets a bit more complicated due to the fact that we now have to take into account that values might be garbage collected in one set but not in the other. While merging them would do no harm it would recreate the garbage which isn&rsquo;t too nice. So what we do is applying the recorded GC actions to both sets first as seen in line 3 to 11 and then merge the remove values (line 12) finally the add values (line 13).</p>

<h2>Results</h2>

<p>I set up some proper tests for the implementation, comparing the GCed OR Set (bucket size 10) with a normal OR Set, running 1000 iterations with a set of 1000 instructions composed of 70% adds and removes, 20% merges and 10% GC events. T<sub>100</sub> is a sliding time from the allowed collection of events older then the last merge.</p>

<p>Each stored element had the size of between 500 and 600 bytes (so there were 100 possible elements). A remove will always remove the stalest element, since they are added in random order this equals a random remove.</p>

<p>The operations are carried out of replicas copies of the set where add, and remove have a equal chance to be either happening just on copy A, or just on copy B, or on both replicas at the some time. GC operations are always carried out on both replicas but it should be noted that the GC operation does not include a merge operation so can be considered asynchronous.</p>

<p>All operations but the GC operation are executed exactly the same on the GCed OR set and the not GCed or Set in the same order and same spread.</p>

<p>At the end a final merge was performed and the resulting values compared for each iteration, no additional GC action takes place at the end.</p>

<p>Measured were both the space reduction per GC run and the final difference of size. Per GC run about 15% space was reclaimed and at the end the GCed set had a total space consumption of around 26% of the normal OR Set in average, 6% in the best and 143% in the worst case.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">vorsetg</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="mi">389</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">135</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span> <span class="p">[</span><span class="nv">Size</span><span class="p">]</span> <span class="nv">Cnt</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>   <span class="nv">Avg</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">261</span><span class="p">,</span>  <span class="nv">Min</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">062</span><span class="p">,</span> <span class="nv">Max</span><span class="p">:</span> <span class="mi">1</span><span class="p">.</span><span class="mi">507</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">vorsetg</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="mi">389</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">135</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span> <span class="p">[</span> <span class="nv">RS</span> <span class="p">]</span> <span class="nv">Cnt</span><span class="p">:</span> <span class="mi">49221</span><span class="p">,</span>  <span class="nv">Avg</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">866</span><span class="p">,</span>  <span class="nv">Min</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">064</span><span class="p">,</span> <span class="nv">Max</span><span class="p">:</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">vorsetg</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="mi">389</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">135</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span> <span class="p">[</span> <span class="nv">GC</span> <span class="p">]</span> <span class="nv">Cnt</span><span class="p">:</span> <span class="mi">49221</span><span class="p">,</span>  <span class="nv">Avg</span><span class="p">:</span> <span class="mi">55</span><span class="p">.</span><span class="mi">870</span><span class="p">,</span> <span class="nv">Min</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="nv">Max</span><span class="p">:</span> <span class="mi">6483</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">vorsetg</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="mi">389</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">135</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span> <span class="p">[</span> <span class="nv">MG</span> <span class="p">]</span> <span class="nv">Cnt</span><span class="p">:</span> <span class="mi">98357</span><span class="p">,</span>  <span class="nv">Avg</span><span class="p">:</span> <span class="mi">58</span><span class="p">.</span><span class="mi">110</span><span class="p">,</span> <span class="nv">Min</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="nv">Max</span><span class="p">:</span> <span class="mi">6596</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">vorsetg</span><span class="p">.</span><span class="nn">erl</span><span class="p">:</span><span class="mi">389</span><span class="p">:</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">135</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span> <span class="p">[</span> <span class="nv">OP</span> <span class="p">]</span> <span class="nv">Cnt</span><span class="p">:</span> <span class="mi">344708</span><span class="p">,</span> <span class="nv">Avg</span><span class="p">:</span> <span class="mi">38</span><span class="p">.</span><span class="mi">539</span><span class="p">,</span> <span class="nv">Min</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="nv">Max</span><span class="p">:</span> <span class="mi">6916</span><span class="err">```</span>
</span></code></pre></td></tr></table></div></figure>


<p>The numbers are from a test run, for readability truncated manually after 3 digest and aligned to be nicer readable. <strong>Size</strong> is total size at the end of the iteration, <strong>RS</strong> is the space reduction per GC run. <strong>GC</strong>, <strong>MG</strong> and <strong>OP</strong> are the time used for garbage collection, merging and other operations respectively, the numbers are per execution and measured microseconds. Time measurements also include noise that from additional operations required for the test and should not be seen as a useful benchmark!</p>

<h2>Conclusion</h2>

<p>The GC method described seems to work, and not even too badly, in the course of experimenting with values it showed that the conserved space is heavily dependant on the environment like the bucket size chosen, the size of the elements, the add/remove ratio and the ratio on which merges happen.</p>

<p>The OR Set it was compared with was not optimised at all, but thanks to it&rsquo;s simplicity a rather good candidate, the gains on already optimised sets will likely be lower. (run with a <a href="https://github.com/Licenser/ecrdt/blob/master/src/vorset2.erl">optimised OR Set</a> gave only 1 54% reduction in space instead of a 74% one with a normal OR Set).</p>

<p>The downside is that garbage collection takes time, so does merging, so a structure like this is over all slower then a not garbage collected version</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/11/asyncronous-garbage-collection-with-crdts/">Asynchronous Garbage Collection With CRDTs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-11T15:45:00+02:00" pubdate data-updated="true">Jun 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So CRDTs are very very nice data structures awesome for eventual consistent applications like riak, or the components of <a href="http://project-fifo.net">Project-FiFo</a>. So they have one big drawback, most of them collect garbage, and over time that can sum up to a lot making them pretty unpractical in many cases. Collecting this garbage is a bit tricky, since usually it means synchronising the data &ndash; which going back to the eventual consistent stuff prevents either A or P.</p>

<p>I want to outline some thoughts here how one could deal with this issue. As usual the idea here isn&rsquo;t without tradeoffs, it does impose certain constrains on the systems behaviour and does not fit every behaviour in exchange of allowing garbage to be disposed of without the need of synchronisation. Now then, lets dive right in.</p>

<h2>What&rsquo;s that trash?</h2>

<p>We start with understanding what the garbage is that sums up. To allow CRDTs to work the way we do, they need to store some kind of history or legend of how the current state (version/value) of the CRDT came to existence.</p>

<p>If we look at a OR Set for example the history of this set is stored by recording all elements ever added along with all elements ever deleted &ndash; elements are tagged to be unique too so adding 5, removing 5 and adding 5 again and removing that again, leaves not a data structure with 0 elements but one with 4. That said there are ways to optimise the OR Set bot lets ignore this for the sake of the example. We can&rsquo;t just store an empty list since we need to make sure that when another copy of the same set can recreate the steps even if it just missed one of the events.</p>

<p>Actually we could, if we would synchronise all copies, say hey from now on you all agree that the new <strong>baseline</strong> (this is bold since it will come up a few more times) is an empty set from now on. And  doing that we would have garbage collected the OR Set, disposed of data that isn&rsquo;t directly relevant to the current state any more.</p>

<p>If we don&rsquo;t guarantee that all objects are garbage collected to the same state, we face a real issue, since the new baseline will cause quite some trouble since the partially applied effects will just be applied again and possibly cause them to be doubly applied. <strong>Or in short, partially applied GCing will cause the CRDT to stop functioning.</strong></p>

<h2>Things get old.</h2>

<p>Looking at the data that gathers and how it is distributed there is one observation to be made: the older a change in state is the more likely it is to be present in all replicas. It makes sense, with eventual consistency we say &lsquo;eventually&rsquo; our data will be the same everywhere, and the chances of &lsquo;eventual&rsquo; are growing the older the change is since it will get more chance to replicate. (mechanisms similar to riak&rsquo;s AAE greatly help here).</p>

<p><img src="/images/posts/2013-06-11-asynchronous-garbage-collection-with-crdts1.png" alt="state distribution" /></p>

<p>So generally there is a T<sub>100</sub> from which point on older data is shared between all instances and by that no longer relevant if we could just garbage collect it. But we don&rsquo;t want synchronous operations, nor do we want partial garbage collection (since that rally would suck).</p>

<p>Back to state, we know which ones we want to garbage collect, lets say we record not only the state change but a timestamp, a simple non monotonic system timestamp, it&rsquo;s cheap to get. Keep in  mind T<sub>100</sub> is well in the past, so if the precision of the times taps is good enough to guarantee that a event at T<sub>0</sub> can not travel back behind T<sub>100</sub>, it&rsquo;s OK if order between T<sub>0</sub> and T<sub>99</sub> changes all the time, we don&rsquo;t really care about that so lets store the state data in a way that helps us with this:</p>

<p>T<sub>0</sub> [S<sub>0</sub>,S<sub>1</sub>, &hellip;, S<sub>n</sub>] T<sub>100</sub> [S<sub>n+1</sub>, &hellip;, S<sub>n+m</sub>]</p>

<h2>A trash bin</h2>

<p>But since it would really suck (I know I&rsquo;m repeating myself) if we partially GC the data we want to be sure that we agree, so would could go and ask all the replicas for their old data (older then T<sub>100</sub>). Yet this approach has a problem, for once T<sub>100</sub> will shift in the time we check, then this might be more data to move then we care for.</p>

<p>So lets use a trash bin, or multiple once order our data in them so you&rsquo;ve some groups of old messages, bunched together which can be agreed on, no matter on the time moving and they are smaller portions. Something like this</p>

<p>&hellip; T<sub>100</sub> [S<sub>n+1</sub>, &hellip;, S<sub>n+100</sub>] [S<sub>n+101</sub>, &hellip;, S<sub>n+200</sub>]&hellip;</p>

<p>So we just have to agree on some bucket to garbage collect, since so if there is another half full bucket now since T<sub>100</sub> has moved since the agreement we don&rsquo;t really care about that. Thanks to the fact that operations are commutative we also can garbage collect in a non direct order, so it&rsquo;s not a biggie if we take just one bucket and not the oldest one.</p>

<p>We&rsquo;re still left with transmitting (in this example) 100 elements to delete and haven&rsquo;t solve the problem of partial garbage collection, but at least we&rsquo;re a good step closer, we&rsquo;ve put the garbage in bins now that are much easier to handle then just on a huge pile.</p>

<h2>A garbage compactor</h2>

<p>Lets tackle the last two issues we do a little trick, instead of sending out the entire bucket we compress it, create a hash of it and send this back and forth, so instead of:</p>

<p>[S<sub>n+1</sub>, &hellip;, S<sub>n+100</sub>]</p>

<p>We tag this bucket with a hash (over it&rsquo;s content) and the newest timestamp of the first element. Since it&rsquo;s older then T<sub>100</sub> we do not need to worry of it changing and recreating the hash, and we get something like this:</p>

<p>(hash, T<sub>S<sub>n+1</sub></sub>)[S<sub>n+1</sub>, &hellip;, S<sub>n+100</sub>]</p>

<p>To agree on buckets to collect and to give the collect order we just need to send the hash and timestamp and an identifier, this is pretty little data to send forth and back. This solves the send much data problem, curiously it also helps a lot with the partial garbage collection status.</p>

<h2>A schedule for garbage collection</h2>

<p>With only the buckets tag identifying it we can solve the partial collection issue, we just treat garbage collection as just another event, storing it and replaying it if it wasn&rsquo;t present in a old replica. So we gradually progress the baseline of a replica towards the common baseline somewhat like this:</p>

<p><img src="/images/posts/2013-06-11-asyncronous-garbage-collection-with-crdts2.png" alt="gc graph" /></p>

<p>Ideally we store the GC operations in a own list and since we can easier apply it then and guarantee that the GC events are synchronised and applied before other events.</p>

<p>That&rsquo;s it, and should be a somewhat working implementation of asynchronous garbage collection for CRTDs. But it&rsquo;s not perfect so lets take a look at the downsides before we end this.</p>

<h2>Lets be honest, it still has a downside</h2>

<p>This concept of GCing does not come for free, the data structure required isn&rsquo;t entirely trivial so it will add overhead, even so the current <a href="https://github.com/Licenser/ecrdt/blob/master/src/rot.erl">implementation</a> is pretty cheap when adding the events in right order, wrong order will cause additional overhead because it might cause elements to shift around in the structure.</p>

<p>It requires events to be timestamped, even so there is no requirement for absolute order, this adds a constraint to messages and events that wasn&rsquo;t there before. Also this is additional work and space that is consumed.</p>

<p>We need to define a T<sub>100</sub> for the system and guarantee it, and find a balance of choosing a big enough T<sub>100</sub> to ensure it&rsquo;s correctness while keeping it small enough to not keep a huge tail of non garbage collected events. That said this can be mitigated slightly by using a dynamic T<sub>100</sub> for example put record when a object was last written to all primary nodes.</p>

<p>If T<sub>100</sub> isn&rsquo;t chooses correctly it might end up getting really messy! if a elements slips by T<sub>100</sub> that wasn&rsquo;t there it could mean that the garbage collection is broken for quite some while or worst state gets inconsistent.</p>

<p>Bucket size is another matter, it needs to be chosen carefully to be big enough to not spam the system but small enough to not take ages to fill, a event passing T<sub>100</sub> but not filling the bucket isn&rsquo;t doing much good.</p>

<p>This is just a crazy idea. I haven&rsquo;t tried this, implemented it or have a formal prove, it is based on common sense and my understanding on matters so it might just explode ;)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/06/happy-birthday-project-fifo/">Happy Birthday Project FiFo</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-06T00:00:00+02:00" pubdate data-updated="true">May 6<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Some might know it, some might not and some might not care but for what it&rsquo;s worth I&rsquo;m the author of <a href="http://project-fifo.net">Project-FiFo</a> (or most of it) and today is Project-FiFo&rsquo;s first birthday (since the domain registration) and I want to take this chance to look back to the past year and reflect, say thank you to all of you and take a look in the future.</p>

<p>When I started Project FiFo a year ago it was more of a tiny hobby project and I could have sworn it would stand in row with all the other little open source projects no one would ever give a damn about. I really could not have been more wrong, what started as a <a href="https://github.com/project-fifo/vmwebadm">few lines of clojurescript</a> has grown to a beat of project with thousands of lines of code, a ever growing and incredible community (the project page gets between 2.5 and 3 thousand visitors a month by now and constantly more then 20 people in the irc channel) and a totally enthusiastic team!</p>

<h2>Thank you</h2>

<p>With a year gone it is about time to call out a few people and say &lsquo;thanks&rsquo; because without their time, effort and work FiFo would not exist and in the day to day business of killing bugs, adding features and contemplating world domination it&rsquo;s easy to forget this.</p>

<p>I want to start with <a href="http://blog.smartcore.net.au/">Mark Slatem aka trentster</a> author of the SmartCore blog and FiFo&rsquo;s <a href="http://ukiahman.tripod.com/Ryker_7.jpg">number one</a>. He was pretty much the first person looking into FiFo and has sticked around till now going from first observer to tester, <a href="http://project-fifo.net/display/PF/The+FiFo+Manual">writer</a>, helper and most of all a good friend.</p>

<p><a href="http://www.beginningwithi.com/">Deirdr</a> the Joyent community manager for SmartOS. Solaris and with that SmartOS is a underdog, and I&rsquo;m sure without the incredible brilliant community it would have been doomed from the start. But it is not, and in a good part thanks to Deirdrs effort to shape the community and make it part of the ecosystem instead of a second class citizen.</p>

<p>Killphil author of jingles, FiFo&rsquo;s web UI, it is amazing he popped up one day, out of the blue saying &lsquo;hey I&rsquo;ve played a bit with improving your UI&rsquo; and put jingles down with became the official UI within matters of days. Sadly I could not get rid of him again since then so you all have to live with him adding <a href="https://monosnap.com/image/QNxrmvEecVoly173dt5OOrVgc">crazy new features</a>.</p>

<p><a href="http://joyent.com">Joyent</a> as a whole for open sourcing SmartOS and making it better and better. Without SmartOs there sure would be no FiFo and I&rsquo;d be stuck with Linux/KVM, which would be not too much fun.</p>

<p><a href="http://basho.com">basho</a> who open sourced riak_core and riak_test which make fifo so much more incredible and provide me with free T-Shirts (I got four by now but please don&rsquo;t tell them or I might not get any more).</p>

<p>Every single person using FiFo, it&rsquo;s amazing to see how well the project is received, hear the feedback. Thanks a lot for all the help with the little things, for putting up with the occasional bugs and bearing with the time it might take to fix them or add new features.</p>

<h2>Looking back</h2>

<p>I&rsquo;ve been working on FiFo for a year now, well first attempts counted a bit longer even, and without exaggerating this was the most amazing year in my life. It has been a blast, I&rsquo;ve learned tons of things, both technical and socially, meet some of the most amazing people I can think of and honestly never have been this happy before.</p>

<p>The whole thing started when I wanted to share a co-located server with some friends who are kind of consoleophobe and I wasn&rsquo;t happy with the approach to give everyone root access. So a solution had to be found but vanilla SmartOS provided none, SDC was making no sense with a single node and too expensive for a hobby system. Everything else was simply not Solaris, period. Adding to it that Deirdr showed me the community, randomly answering a question on twitter with a hint to visit the channel &ndash; which was was incredible surprising after experiencing some of the Linux community really there was no chance in hell ending up with anything but SmartOS.</p>

<p>But all in all there was no virtualisation solution that suited what I wanted, not even if I had taken cost out of the equation. And since I refuse to swing the white flag and surrender to something I don&rsquo;t like the only wan was: build one! (also I&rsquo;m crazy about challenges and seeing how far I can push things ;) And after</p>

<p>That sums up how the whole thing started, with a little nodejs/clojurescript application that could be used with sdc-* commands over http. But that did only work with a single host, not that I had more to serve but it looked kind of clumsy and unprofessional for a cloud operating system like SmartOS so wiggle was born as kind of a broker in front of multiple vmwebadm (man the name was horribly boring). And from there on it kept growing and growing.</p>

<p>Now over the last year of work, and lots of lots of input from the community the one badly named program has become 5 services, three of them distributed via riak_core, and a HTML/JS UI on top of that, that most importantly, all have very cool names.</p>

<p>All the technical things aside, running an open source project where people get engaged is a fascinating experience, there is so much to learn I would have never dreamed of, so much to take away from the situation that helped me understand the problems and inner working of teams, people, projects
better. That alone was worth every second of time invested.</p>

<h2>Dogs and funky names</h2>

<p>Now before we go on I share something that was asked a few times now: why the crazy names and obsession with dogs?</p>

<p>So the story starts with naming the first component, which back then was wiggle (after being very disappointed with my name choice for vmwebadm). Wiggle was the component that gave a unified interface to multiple hypervisors and in the SmartOS channel I had heard that Joyent called it&rsquo;s thing &lsquo;headnode&rsquo;, but for FiFo the goal was never to clone something that already existed and I wanted to make a point of it so here is how the thought chain went: head &ndash;> tail, node &ndash;> nod &ndash;> wiggle, tail&amp;wiggle &ndash;> dog.</p>

<p>Now I had a promise to keep, back when I was younger and my brother was even younger (since he is my little brother) he got a pet (as in not real) dog, and I had just learned with a FiFo (First in First out) queue is, I found that Fifo is a amazing name for a dog, so I talked my brother into naming his pet dog Fifo telling hime that if I ever had a dog I&rsquo;d name it Fifo too, that said, I&rsquo;m a man of my word even if it takes over something like 15 years to make good on it.</p>

<p>All other names just followed the same naming scheme, expect jingles but then again I did not name it myself. That said Fifo, the dog, is still with us, he is sitting on my window board drying from taking a shower earlier today to get cleaned up for it&rsquo;s birthday!</p>

<p>As a nice side effect it is great for people to remember things that are named so silly as FiFo&rsquo;s components!</p>

<h2>Looking ahead</h2>

<p>To be honest I feel that even after a year FiFo is still in its infancy, don&rsquo;t get me wrong it&rsquo;s quite stable and the features it provides build a very good foundation but there is so much more it can and will be!</p>

<p>PXE booting, integrated in FiFo, allowing to spin up new hypervisors by a click in the UI (or a call from he console) adding ipmi to the mix makes it even more exciting! Think about automatically booting a new hypervisor when the capacity reaches a certain percentage, or shutting an empty one down when it&rsquo;s below.</p>

<p>Support for Clouds spread over WAN, location awareness of VM&rsquo;s and Hypervisors with a notion of distance with deployment rules that take this into account (please don&rsquo;t deploy all my database cluster VM&rsquo;s on the same physical host, but don&rsquo;t spread them over multiple datacenters!).</p>

<p>Cold migration of VM&rsquo;s from one host to another, and putting them into cold storage / backing them up as a whole.</p>

<p>Well, I could go on and on rambling about crazy ideas for another thousand or so words or so but lets save this for another time. All in all I wanted to say it was an amazing year, amazing to see the community develop, seeing how FiFo gets used and I am hugely excited to see how things continue from here on! I can&rsquo;t wait to see the first 10+ node FiFo setup, hear what people make out of it. See a first adopted UI, people starting to build things around FiFo &ndash; there already is a <a href="https://github.com/bakins/project-fifo-ruby">ruby implementation</a> of the API along with a <a href="https://github.com/bakins/knife-fifo">chef knife thing</a>.</p>

<p>So to close: Happy birthday FiFo, thanks to all of you for joining this journey and lets brace for another year of dog-named-components!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/23/fifo-plus-80loc-of-bash-equals-5-node-riak-cluster/">FiFo + 80LOC of Bash = 5 Node Riak Cluster</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-23T14:47:00+02:00" pubdate data-updated="true">Apr 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>The reason</h2>

<p>The question &lsquo;why would I want at least 5 nodes&rsquo; comes up very often in the #riak IRC channel, there is a <a href="http://basho.com/why-your-riak-cluster-should-have-at-least-five-nodes/">good explanation</a>. But that&rsquo;s boring, no one likes reading manuals, we, as engineers, like to try things out (aka. break stuff).</p>

<p>Only downside with that is that we need to set things up before we can break them, or even worst need to un-break it later to try out different things (aka. break it in different ways). Admittedly setting up a riak instance is <strong>easy</strong> but setting up 5 and connecting them then break them and do all again to break them again, erm I mean try things out of cause, can get really tedious and I for once am too lazy to bother with that.</p>

<h2>The goal</h2>

<p>Make setting our breakage, erm test, bed setup as simple as possible, and whipping up things and tearing them down trivial, ideally have one simple command like <code>./riak.sh setup</code> to do that for us and <code>./riak.sh delete</code> undo it all for us to get back to a clean state.</p>

<h2>The tools</h2>

<p>To build anything we&rsquo;ll need some tools, hammer and nails will not do us much good here so we are going to pick:</p>

<ul>
<li><a href="http://project-fifo.net">Project FiFo</a> &ndash; my favourite virtualisation tool (I am biassed I wrote it), but it&rsquo;s very easy to set up and very powerful.</li>
<li><a href="https://github.com/project-fifo/pyfi">The FiFo Console Client</a> &ndash; we want to script things, a UI isn&rsquo;t helpful.</li>
<li>bash &ndash; the simplest possible scripting tool.</li>
<li>curl &ndash; since riak offers a http fronted it&rsquo;s a wonderful way to check if the system is up.</li>
<li><a href="http://trentm.com/json/">jsontool</a> &ndash; a nifty utility to traverse JSON documents.</li>
</ul>


<p>With that we should be set and good to go.</p>

<h2>The steps</h2>

<p>We&rsquo;ll have to perform multiple steps to build our wracking ground for riak lets look at them one by one:</p>

<h3>Preparing the environment</h3>

<p>Before we can begin we&rsquo;ve to set up a few things, I&rsquo;ll not go into detail how to set up FiFo, there is a [good manual] for that with only like 5 steps required. So lets start at some of the script&rsquo;s variables:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#/usr/bin/env bash</span>
</span><span class='line'><span class="nv">PACKAGE</span><span class="o">=</span><span class="s2">&quot;small&quot;</span>
</span><span class='line'><span class="nv">DATASET</span><span class="o">=</span><span class="s2">&quot;base64-1.9.1&quot;</span>
</span><span class='line'><span class="nv">NET</span><span class="o">=</span><span class="s2">&quot;7df94bc3-6a9f-4c88-8f80-7a8f4086b79d&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>smal</code> is the name of the package created in FiFo, I picked something with 512MB of memory since that should be enough for now.</li>
<li><code>base64-1.9.1</code> is the dataset it means things are running in a solaris zone this also can be installed from the FiFo UI.</li>
<li><code>7df94bc3-6a9f-4c88-8f80-7a8f4086b79d</code> is the UUID of the network you can find that with <code>fifo networks list</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>schroedinger:fifopy heinz <span class="o">[</span>master<span class="o">]</span> <span class="nv">$ </span>fifo packages list
</span><span class='line'>                                UUID Name       RAM        CPU cap    Quota
</span><span class='line'>------------------------------------ ---------- ---------- ---------- ----------
</span><span class='line'>5f9f6c41-d700-4b4f-80f1-7350a71ed2e6 small      512 MB     100%       10 GB
</span><span class='line'>schroedinger:fifopy heinz <span class="o">[</span>master<span class="o">]</span> <span class="nv">$ </span>fifo networks list
</span><span class='line'>                                UUID Name       Tag                  First            Last
</span><span class='line'>------------------------------------ ---------- ---------- --------------- ---------------
</span><span class='line'>7df94bc3-6a9f-4c88-8f80-7a8f4086b79d <span class="nb">test       </span>admin        192.168.0.210   192.168.0.220
</span><span class='line'>schroedinger:fifopy heinz <span class="o">[</span>master<span class="o">]</span> <span class="nv">$ </span>fifo datasets list
</span><span class='line'>                                UUID Name       Version Type  Description
</span><span class='line'>------------------------------------ ---------- ------- ----- ----------
</span><span class='line'>60ed3a3e-92c7-11e2-ba4a-9b6d5feaa0c4 base       1.9.1   zone  A SmartOS ...
</span></code></pre></td></tr></table></div></figure>


<h3>Creating a VM with riak installed</h3>

<p>Creating a VM is rather simple we need a little JSON and pipe it to fifo with a cat. Please note the section reading <code>user-script</code> here we make the setup. Here is how it looks.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat <span class="s">&lt;&lt;EOF | fifo vms create -p $PACKAGE -d $DATASET</span>
</span><span class='line'><span class="s">{</span>
</span><span class='line'><span class="s">  &quot;alias&quot;: &quot;riak1&quot;,</span>
</span><span class='line'><span class="s">  &quot;networks&quot;: {&quot;net0&quot;: &quot;$NET&quot;},</span>
</span><span class='line'><span class="s">  &quot;metadata&quot;: {&quot;user-script&quot;: &quot;/opt/local/bin/sed -i.bak \\&quot;s/pkgsrc/pkgsrc-eu-ams/\\&quot; /opt/local/etc/pkgin/repositories.conf; /opt/local/bin/pkgin update; /opt/local/bin/pkgin -y install riak; export IP=\`ifconfig net0 | head -n 2 | tail -n 1 | awk &#39;{print \$2}&#39;\`; /opt/local/bin/sed -i.bak \\&quot;s/127.0.0.1/\$IP/\\&quot; /opt/local/etc/riak/app.config; /opt/local/bin/sed -i.bak \\&quot;s/127.0.0.1/\$IP/\\&quot; /opt/local/etc/riak/vm.args; svcadm enable epmd riak&quot;}</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>To get a bit better look user script section and remove the escape things:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># We configure pkgin to use the european mirror you might not need to do that.</span>
</span><span class='line'>/opt/local/bin/sed -i.bak <span class="s2">&quot;s/pkgsrc/pkgsrc-eu-ams/&quot;</span> /opt/local/etc/pkgin/repositories.conf;
</span><span class='line'><span class="c"># We update the pkgin database and install riak</span>
</span><span class='line'>/opt/local/bin/pkgin update;
</span><span class='line'>/opt/local/bin/pkgin -y install riak;
</span><span class='line'><span class="c"># We find out what IP our VM has from within the VM.</span>
</span><span class='line'><span class="nb">export </span><span class="nv">IP</span><span class="o">=</span><span class="sb">`</span>ifconfig net0 | head -n 2 | tail -n 1 | awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>;
</span><span class='line'><span class="c"># We update the app.config and vm.args to use the &#39;public&#39; ip instead of the 127.0.0.1</span>
</span><span class='line'>/opt/local/bin/sed -i.bak <span class="s2">&quot;s/127.0.0.1/$IP/&quot;</span> /opt/local/etc/riak/app.config;
</span><span class='line'>/opt/local/bin/sed -i.bak <span class="s2">&quot;s/127.0.0.1/$IP/&quot;</span> /opt/local/etc/riak/vm.args;
</span><span class='line'><span class="c"># Start epmd and riak</span>
</span><span class='line'>svcadm <span class="nb">enable </span>epmd riak
</span></code></pre></td></tr></table></div></figure>


<h3>Waiting for riak</h3>

<p>Now that is the first zone set up next we&rsquo;ll want to wait for riak to properly start up. This is needed since the commands are asynchronous and installing the packages can be a tad slow. But we can just to curl the http interface to check for this, so it&rsquo;s rather simple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># We&#39;ll ask fifo for the IP of our first zone.</span>
</span><span class='line'><span class="nv">IP1</span><span class="o">=</span><span class="sb">`</span>fifo vms get riak1 | json networks<span class="o">[</span>0<span class="o">]</span>.ip<span class="sb">`</span>
</span><span class='line'><span class="c"># Print some info so waiting is not so boring</span>
</span><span class='line'><span class="nb">echo</span> -n <span class="s1">&#39;Waiting until riak is up and running on the primary node.&#39;</span>
</span><span class='line'><span class="c"># now we curl the http interface every second to see if things are good.</span>
</span><span class='line'><span class="k">until </span>curl http://<span class="k">${</span><span class="nv">IP1</span><span class="k">}</span>:8098 2&gt;/dev/null &gt;/dev/null
</span><span class='line'><span class="k">do</span>
</span><span class='line'><span class="k">  </span>sleep 1
</span><span class='line'>  <span class="nb">echo</span> -n <span class="s1">&#39;.&#39;</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'><span class="c"># and we&#39;re done!</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot; done.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Setting up the remaining zones</h3>

<p>We&rsquo;re not going to get into too much details with this since it is pretty much working the same as the first VM with the only difference that the user-script holds two more lines:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">for </span>i in 2 3 4 5
</span><span class='line'><span class="k">do</span>
</span><span class='line'><span class="k">  </span>cat <span class="s">&lt;&lt;EOF | fifo vms create -p $PACKAGE -d $DATASET</span>
</span><span class='line'><span class="s">  {</span>
</span><span class='line'><span class="s">    &quot;alias&quot;: &quot;riak${i}&quot;,</span>
</span><span class='line'><span class="s">    &quot;networks&quot;: {&quot;net0&quot;: &quot;$NET&quot;},</span>
</span><span class='line'><span class="s">    &quot;metadata&quot;: {&quot;user-script&quot;: &quot;/opt/local/bin/sed -i.bak \\&quot;s/pkgsrc/pkgsrc-eu-ams/\\&quot; /opt/local/etc/pkgin/repositories.conf; /opt/local/bin/pkgin update; /opt/local/bin/pkgin -y install riak; export IP=\`ifconfig net0 | head -n 2 | tail -n 1 | awk &#39;{print \$2}&#39;\`; /opt/local/bin/sed -i.bak \\&quot;s/127.0.0.1/\$IP/\\&quot; /opt/local/etc/riak/app.config; /opt/local/bin/sed -i.bak \\&quot;s/127.0.0.1/\$IP/\\&quot; /opt/local/etc/riak/vm.args; svcadm enable epmd riak; sleep 10; /opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster join riak@${IP1}; /opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster plan; /opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster commit&quot;}</span>
</span><span class='line'><span class="s">  }</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>  <span class="nv">IP</span><span class="o">=</span><span class="sb">`</span>fifo vms get riak<span class="nv">$i</span> | json networks<span class="o">[</span>0<span class="o">]</span>.ip<span class="sb">`</span>
</span><span class='line'>  <span class="nb">echo</span> -n <span class="s2">&quot;Waiting untill riak is up and running on the node $i.&quot;</span>
</span><span class='line'>  <span class="k">until </span>curl http://<span class="k">${</span><span class="nv">IP</span><span class="k">}</span>:8098 2&gt;/dev/null &gt;/dev/null
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'><span class="k">      </span>sleep 1
</span><span class='line'>      <span class="nb">echo</span> -n <span class="s1">&#39;.&#39;</span>
</span><span class='line'>  <span class="k">done</span>
</span><span class='line'><span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot; done.&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>The two new lines are joining the node to the existing riak node which is quite easy, we can use $IP1 we generated in the first step too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster join riak@<span class="k">${</span><span class="nv">IP1</span><span class="k">}</span>
</span><span class='line'>/opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster plan
</span><span class='line'>/opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster commit
</span></code></pre></td></tr></table></div></figure>


<p>This is run that up and you&rsquo;ve a 5 node riak cluster, and it&rsquo;s quick at last if you&rsquo;re in the US and have a good connection to the package repository.</p>

<p><a href="https://raw.github.com/project-fifo/pyfi/master/examples/riak.sh">Here</a> is this all slapped together.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/09/writing-your-first-riak-test-test-yes-i-know-there-are-two-tests-there/">Writing Your First Riak Test Test (Yes I Know There Are Two Tests There)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-09T23:33:00+02:00" pubdate data-updated="true">Apr 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As promised in a <a href="/blog/2013/03/31/getting-started-with-riak-test-and-riak-core/">previous post</a> I&rsquo;ll talk a bit about writing tests for <code>riak_test</code>. To start with the obvious it&rsquo;s pretty simple and pretty awesome. <code>riak_test</code> gives you the tools you&rsquo;ve dreamed of when testing distributed <code>riak_core</code> applications:</p>

<ul>
<li>a backchannel to communicate and execute commands on the nodes.</li>
<li>a nice and way to bring up and tear down the test environment.</li>
<li>helper functions to deal with the <code>riak_core</code> cluster.</li>
<li>something called <code>intercepts</code> that allow you to mock certain behaviours in the cluster.</li>
<li>all the power of Erlang.</li>
</ul>


<h2>How a test works</h2>

<p>Tests have a very simple structre they pretty much contain a single function: <code>confirm/0</code></p>

<p>This function gets called when the test is executed and should return <code>pass</code> when everything works well or throw an exception when not. The actual test are simple unit asserts you use.</p>

<p>That in itself is not really overly exciting and those of you with a short attention span might start to thing &lsquo;boooooooring&rsquo; so lets look at the exciting part.</p>

<h2>Starting your applicatio</h2>

<p><code>riak_test</code> offers a way to start instances of your application and communicate with them, the common pattern is to start one (or more) nodes as first part of the script and check of they are up and running. That could look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">confirm</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">Node</span><span class="p">]</span> <span class="o">=</span> <span class="nn">rt</span><span class="p">:</span><span class="nf">deploy_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span class='line'>    <span class="o">?</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span> <span class="nn">rt</span><span class="p">:</span><span class="nf">wait_until_nodes_ready</span><span class="p">([</span><span class="nv">Node</span><span class="p">])),</span>
</span><span class='line'>    <span class="n">pass</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a minimal test it sets up one instance of our application and waits for it to be ready.</p>

<p><code>rt:deploy_nodes(1)</code> will deploy one node, the id of the node (a atom with that identifies it to erlang) will be sotred in <code>Node</code>, you can deploy more nodes by increasing the number in <code>rt:deploy_nodes/1</code>.</p>

<p><code>?assertEqual(ok, rt:wait_until_nodes_ready([Node]))</code> will make the test wait for the nodes to be ready, ready here means that all ring services we defined in the config are provided.</p>

<p>The node will be running in its own Erlang VM and have the test suite connected as a hidden node. This is the first thing that is truly interesting, since the connection will allow us to run rpc calls on the node this is the first thing that is truly fun.</p>

<h2>An official channel</h2>

<p>Now we&rsquo;ve a basic test running have our nodes to be started up and the test waiting until all is started and happy.</p>

<p>So chances are that aside of this back channel communication the node provides some kind of API, and we want to be able to connect to this API to run our tests. Un my case it&rsquo;s a simple TCP port that announces itself over mdns, we could simply listen to the broadcast and use the information it provides to talk to the node. This would work, as long as we&rsquo;ve a single node, the moment we&rsquo;ve to we would never know which node we&rsquo;re talking to and that would make testing hard.</p>

<p>So backchannel to the rescue! We&rsquo;ll just get the nodes configuration from the host, for my application I store this kind of information in the application configuration so I&rsquo;ve made a function that given a <code>Node</code> returns <code>IP</code> and <code>Port</code> for it to talk to plus one to send data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">node_endpoing</span><span class="p">(</span><span class="nv">Node</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">IP</span><span class="p">}</span> <span class="o">=</span> <span class="nn">rpc</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">get_env</span><span class="p">,</span> <span class="p">[</span><span class="n">mdns_server_lib</span><span class="p">,</span> <span class="n">ip</span><span class="p">]),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Port</span><span class="p">}</span> <span class="o">=</span> <span class="nn">rpc</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">get_env</span><span class="p">,</span> <span class="p">[</span><span class="n">mdns_server_lib</span><span class="p">,</span> <span class="n">port</span><span class="p">]),</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">IP</span><span class="p">,</span> <span class="nv">Port</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">IP</span><span class="p">,</span> <span class="nv">Port</span><span class="p">}</span> <span class="o">=</span> <span class="n">node_endpoing</span><span class="p">(</span><span class="nv">Node</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">lager</span><span class="p">:</span><span class="nf">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">~s</span><span class="s">:</span><span class="si">~p</span><span class="s"> &lt;- </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">IP</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">]),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Socket</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">connect</span><span class="p">(</span><span class="nv">IP</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="p">[</span><span class="n">binary</span><span class="p">,</span> <span class="p">{</span><span class="n">active</span><span class="p">,</span><span class="n">false</span><span class="p">},</span> <span class="p">{</span><span class="n">packet</span><span class="p">,</span><span class="mi">4</span><span class="p">}],</span> <span class="mi">100</span><span class="p">),</span>
</span><span class='line'>    <span class="n">ok</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="nb">term_to_binary</span><span class="p">(</span><span class="nv">Msg</span><span class="p">)),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Repl</span><span class="p">}</span> <span class="o">=</span> <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">recv</span><span class="p">(</span><span class="nv">Socket</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Res</span><span class="p">}</span> <span class="o">=</span> <span class="nb">binary_to_term</span><span class="p">(</span><span class="nv">Repl</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">lager</span><span class="p">:</span><span class="nf">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">~s</span><span class="s">:</span><span class="si">~p</span><span class="s"> -&gt; </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">IP</span><span class="p">,</span> <span class="nv">Port</span><span class="p">,</span> <span class="nv">Res</span><span class="p">]),</span>
</span><span class='line'>    <span class="nn">gen_tcp</span><span class="p">:</span><span class="nf">close</span><span class="p">(</span><span class="nv">Socket</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Res</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is some <code>gen_tcp</code> stuff in there but lets just ignore it for now it&rsquo;s detail not important, the first function is the more interesting one it uses the <code>rpc</code> module to execute the commands on the node we just started which is quite awesome.</p>

<p>As a note I&rsquo;ve put those functions into <code>rt_&lt;applicatin name&gt;</code> so for example rt_sniffle.</p>

<h2>Testing the API</h2>

<p>With <code>call/2</code> we&rsquo;ve now a way to send data directly to the node over the official API channel so lets add to our test. So lets get back to our <code>confirm/0</code> and add some real tests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">confirm</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">Node</span><span class="p">]</span> <span class="o">=</span> <span class="nn">rt</span><span class="p">:</span><span class="nf">deploy_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span class='line'>    <span class="o">?</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span> <span class="nn">rt</span><span class="p">:</span><span class="nf">wait_until_nodes_ready</span><span class="p">([</span><span class="nv">Node</span><span class="p">])),</span>
</span><span class='line'>    <span class="o">?</span><span class="n">assertEqual</span><span class="p">({</span><span class="n">ok</span><span class="p">,[]},</span>
</span><span class='line'>                 <span class="nn">rt_sniffle</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="p">{</span><span class="n">vm</span><span class="p">,</span> <span class="n">list</span><span class="p">})),</span>
</span><span class='line'>    <span class="o">?</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span>
</span><span class='line'>                 <span class="nn">rt_sniffle</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="p">{</span><span class="n">vm</span><span class="p">,</span> <span class="nb">register</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;vmid&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;hypervisor&quot;</span><span class="o">&gt;&gt;</span><span class="p">})),</span>
</span><span class='line'>    <span class="o">?</span><span class="n">assertEqual</span><span class="p">({</span><span class="n">ok</span><span class="p">,[</span><span class="o">&lt;&lt;</span><span class="s">&quot;vmid&quot;</span><span class="o">&gt;&gt;</span><span class="p">]},</span>
</span><span class='line'>                 <span class="nn">rt_sniffle</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="p">{</span><span class="n">vm</span><span class="p">,</span> <span class="n">list</span><span class="p">})),</span>
</span><span class='line'>    <span class="n">pass</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s as easy as this, this test will</p>

<ul>
<li>List the registered VM&rsquo;s and expect none to be there.</li>
<li>Create a new VM and expect a ok result.</li>
<li>List the registered vm&rsquo;s and expect the one we just registered to be present.</li>
</ul>


<p>And that&rsquo;s it for basic testing with <code>riak_test</code> I&rsquo;ll follow up on this with an article over intercepts since they add another cool feature to <code>riak_test</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/31/getting-started-with-riak-test-and-riak-core/">Getting Started With Riak_test and Riak_core</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-31T07:30:00+02:00" pubdate data-updated="true">Mar 31<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you don&rsquo;t know what <code>riak_core</code> is, or don&rsquo;t have a <code>riak_core</code> based application you&rsquo;ll probably not take too much practical use of this posts you might want to start with <a href="https://github.com/rzezeski/try-try-try">Ryan Zezeski&rsquo;s &ldquo;working&rdquo; blog try try try</a> and the <a href="https://github.com/basho/rebar_riak_core">rebar plugin</a>.</p>

<p>That said if you have a <code>riak_core</code> app this posts should get you started on how to test it with <code>riak_test</code>. We&rsquo;ll not go through the topic of how to write the tests itself, this might come in a later post also the <code>riak_kv</code> tests are a good point to start.</p>

<p>Please note that the approach described here is what I choose to do, it might not be best practice of the best way for you to do things. I also will link to <a href="https://github.com/Licenser/riak_test">my fork</a> of <code>riak_test</code> instead of the <a href="https://github.com/basho/riak_test">official one</a> since it includes some modifications required for testing apps other then <code>riak_kv</code> I hope those modifications will be merged back at some point but for now I want to get it ironed out a bit more before making a pull request.</p>

<h2>What is riak_test?</h2>

<p>So before we start a few words to <code>riak_test</code>. <code>riak_test</code> is a pretty nice framework for testing distributed applications, it is, just as about all other <code>riak_</code> stuff created by <a href="http://basho.com">Basho</a> and it is pretty darn awesome.</p>

<p>At it&rsquo;s current state it is very focused on testing <code>riak_kv</code> (or <code>riak</code> as in the database) but from a first glance a lot of functionality is very universal and after all <code>riak_core</code> is also build on top of <code>riak_core</code>, so modifying it to run with other <code>riak_core</code> based apps is pretty easy.</p>

<h2>The setup</h2>

<p>Since I will be testing multiple <code>riak_core</code> apps and not just one I decided to go the following path: Have the entire setup in a git repository, then have one branch for general fixes/changed to <code>riak_core</code> then have one branch for each application I want to test that is based on the general branch so common changes can easily be merged so it will look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---riak_test--------- (bashos master tree)
</span><span class='line'>   `---riak_core----- (modifications to make riak_test work with core apps)
</span><span class='line'>    ` `  `---sniffle- (tests for sniffle)
</span><span class='line'>     ` `---snarl----- (tests for snarl)
</span><span class='line'>      `---howl------- (tests for howl)</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll go over this and setting up tests for the <a href="https://github.com/project-fifo/howl">howl application</a> it&rsquo;s rather small and simple and it&rsquo;s easier to follow along with something real instead of a made up situation.</p>

<h2>Getting started</h2>

<p>Step one of getting started is to get a clone from the <code>riak_test</code> repository, that&rsquo;s pretty simple (alter the path if you decided to fork):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd ~/Projects
</span><span class='line'>git clone https://github.com/Licenser/riak_test.git
</span><span class='line'>cd riak_test</span></code></pre></td></tr></table></div></figure>


<p>Now we branch of to have a place to get our howl application but first we need to checkout the riak_core branch to make sure we get the changes included in it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git checkout riak_core
</span><span class='line'>git branch howl
</span><span class='line'>git checkout howl</span></code></pre></td></tr></table></div></figure>


<p>Okay that&rsquo;s it for the basic setup not that bad so far is it?</p>

<h2>Configuration</h2>

<p>Next thing we need to do is creating a configuration, at this point we assume you don&rsquo;t have any yet so we&rsquo;ll start from scratch, if you add more then one application later on you can just add them to an existing configuration.</p>

<p><code>riak_test</code> looks for the configuration file <code>~/.riak_test.config</code> and reads all the data from there so we&rsquo;ll first need to copy the sample config there:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cp riak_test.config.sample ~/.riak_test.config</span></code></pre></td></tr></table></div></figure>


<p>Next step is to open it in your favourite editor, you&rsquo;ll recognise it&rsquo;s a good old Erlang config file with tuples to group sections. We&rsquo;ll be ignoring the <code>default</code> section for now, if you&rsquo;re interested in it the documentation is quite good!</p>

<p>So lets go down to where it reads:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%% ===============================================================</span>
</span><span class='line'><span class="c">%%  Project-specific configurations</span>
</span><span class='line'><span class="c">%% ===============================================================</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is where the fun starts, you&rsquo;ll see a tuple starting with <code>{rtdev,</code> &ndash; note this <code>rtdev</code> has nothing whatsoever to do with the <code>rtdev</code> that is in the <code>default</code> section as <code>{rt_harness, rtdev}</code>. The <code>rtdev</code> in the project part is just the name of the project, since your project is named <code>howl</code> not <code>rtdev</code> we&rsquo;ll go and change that first.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">rtdev</span><span class="p">,</span> <span class="p">[</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can go to set up some variables first up the project name and executables, the name itself is just for information (or if you use <code>giddyup</code>) the executables are how your application is started, since our application is named <code>howl</code> it&rsquo;s started with the command <code>howl</code> and the admin command for it is <code>howl-admin</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%% The name of the project/product, used when fetching the test</span>
</span><span class='line'><span class="c">%% suite and reporting.</span>
</span><span class='line'><span class="p">{</span><span class="n">rt_project</span><span class="p">,</span> <span class="s">&quot;howl&quot;</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="n">rc_executable</span><span class="p">,</span> <span class="s">&quot;howl&quot;</span><span class="p">},</span>
</span><span class='line'><span class="p">{</span><span class="n">rc_admin</span><span class="p">,</span> <span class="s">&quot;howl-admin&quot;</span><span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>With that done come the services, those are the buggers you register in your _app.erl file, lets have a look at the howl_app.erl:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%...</span>
</span><span class='line'>            <span class="n">ok</span> <span class="o">=</span> <span class="nn">riak_core_node_watcher</span><span class="p">:</span><span class="nf">service_up</span><span class="p">(</span><span class="n">howl</span><span class="p">,</span> <span class="n">self</span><span class="p">()),</span>
</span><span class='line'><span class="c">%...</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we only have one service here we need to watch out for, named, you might guess  right <code>howl</code> that makes the list rather short:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">rc_services</span><span class="p">,</span> <span class="p">[</span><span class="n">howl</span><span class="p">]},</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the cookie, it&rsquo;s a bit hidden in the code that you need to set it but you do, you will need this later so remember it! Since I am bad at remembering things I named it  <code>howl</code>  again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">rt_cookie</span><span class="p">,</span> <span class="n">howl</span><span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now comes the setup of paths, for this we&rsquo;ve to decide where we want to put our data later on, I&rsquo;ve put all my <code>riak_test</code> things in <code>/Users/heinz/rt/...</code> so we&rsquo;ll follow with this. Also note that my development process works on three branches:</p>

<ul>
<li><code>test</code> &ndash; the most unstable branch.</li>
<li><code>dev</code> &ndash; here things go that should work.</li>
<li><code>master</code> &ndash; only full releases go in here.</li>
</ul>


<p>This setup might not work for you at all, but since it are only path names it should be easy enough to adept the.</p>

<p>Note that by default <code>riak_test</code> will run tests on the <code>current</code> environment</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%% Paths to the locations of various versions of the project. This</span>
</span><span class='line'><span class="c">%% is only valid for the `rtdev&#39; harness.</span>
</span><span class='line'><span class="p">{</span><span class="n">rtdev_path</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>              <span class="c">%% This is the root of the built `rtdev&#39; repository,</span>
</span><span class='line'>              <span class="c">%% used for manipulating the repo with git. All</span>
</span><span class='line'>              <span class="c">%% versions should be inside this directory.</span>
</span><span class='line'>              <span class="p">{</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;/Users/heinz/rt/howl&quot;</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'>              <span class="c">%% The path to the `current&#39; version, which is used</span>
</span><span class='line'>              <span class="c">%% exclusively except during upgrade tests.</span>
</span><span class='line'>              <span class="p">{</span><span class="n">current</span><span class="p">,</span> <span class="s">&quot;/Users/heinz/rt/howl/howl-test&quot;</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'>              <span class="c">%% The path to the most immediately previous version</span>
</span><span class='line'>              <span class="c">%% of the project, which is used when doing upgrade</span>
</span><span class='line'>              <span class="c">%% tests.</span>
</span><span class='line'>              <span class="p">{</span><span class="n">previous</span><span class="p">,</span> <span class="s">&quot;/Users/heinz/rt/howl/howl-dev&quot;</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'>              <span class="c">%% The path to the version before `previous&#39;, which</span>
</span><span class='line'>              <span class="c">%% is used when doing upgrade tests.</span>
</span><span class='line'>              <span class="p">{</span><span class="n">legacy</span><span class="p">,</span> <span class="s">&quot;/Users/heinz/rt/howl/howl-stable&quot;</span><span class="p">}</span>
</span><span class='line'>             <span class="p">]}</span>
</span><span class='line'><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&rsquo;s it now the config is set up and should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="n">rtdev</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>    <span class="c">%% The name of the project/product, used when fetching the test</span>
</span><span class='line'>    <span class="c">%% suite and reporting.</span>
</span><span class='line'>    <span class="p">{</span><span class="n">rt_project</span><span class="p">,</span> <span class="s">&quot;howl&quot;</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">{</span><span class="n">rc_executable</span><span class="p">,</span> <span class="s">&quot;rhowl&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">rc_admin</span><span class="p">,</span> <span class="s">&quot;howl-admin&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">rc_services</span><span class="p">,</span> <span class="p">[</span><span class="n">howl</span><span class="p">]},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">rt_cookie</span><span class="p">,</span> <span class="n">howl</span><span class="p">},</span>
</span><span class='line'>    <span class="c">%% Paths to the locations of various versions of the project. This</span>
</span><span class='line'>    <span class="c">%% is only valid for the `rtdev&#39; harness.</span>
</span><span class='line'>    <span class="p">{</span><span class="n">rtdev_path</span><span class="p">,</span> <span class="p">[</span>
</span><span class='line'>                  <span class="c">%% This is the root of the built `rtdev&#39; repository,</span>
</span><span class='line'>                  <span class="c">%% used for manipulating the repo with git. All</span>
</span><span class='line'>                  <span class="c">%% versions should be inside this directory.</span>
</span><span class='line'>                  <span class="p">{</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;/Users/heinz/rt/howl&quot;</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'>                  <span class="c">%% The path to the `current&#39; version, which is used</span>
</span><span class='line'>                  <span class="c">%% exclusively except during upgrade tests.</span>
</span><span class='line'>                  <span class="p">{</span><span class="n">current</span><span class="p">,</span> <span class="s">&quot;/Users/heinz/rt/howl/howl-test&quot;</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'>                  <span class="c">%% The path to the most immediately previous version</span>
</span><span class='line'>                  <span class="c">%% of the project, which is used when doing upgrade</span>
</span><span class='line'>                  <span class="c">%% tests.</span>
</span><span class='line'>                  <span class="p">{</span><span class="n">previous</span><span class="p">,</span> <span class="s">&quot;/Users/heinz/rt/howl/howl-dev&quot;</span><span class="p">},</span>
</span><span class='line'>
</span><span class='line'>                  <span class="c">%% The path to the version before `previous&#39;, which</span>
</span><span class='line'>                  <span class="c">%% is used when doing upgrade tests.</span>
</span><span class='line'>                  <span class="p">{</span><span class="n">legacy</span><span class="p">,</span> <span class="s">&quot;/Users/heinz/rt/howl/howl-stable&quot;</span><span class="p">}</span>
</span><span class='line'>                 <span class="p">]}</span>
</span><span class='line'><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Setting up the application</h2>

<p>We&rsquo;ve <code>riak_test</code> ready to test now next we need to prepare howl to be tested, we&rsquo;ll only look at the <code>current</code> (aka <code>test</code>) setup since the steps for others are pretty much the same.</p>

<p>The first step is that we need the folder, so lets create it</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="nv">Users</span><span class="o">/</span><span class="n">heinz</span><span class="o">/</span><span class="n">rt</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="n">howl</span>
</span><span class='line'><span class="n">cd</span> <span class="o">/</span><span class="nv">Users</span><span class="o">/</span><span class="n">heinz</span><span class="o">/</span><span class="n">rt</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="n">howl</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since howl lives with the octocat on github it&rsquo;s easy to fetch our application and checkout the test branch (remember <code>current</code> is on the test branch for me):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="n">git</span> <span class="n">clone</span> <span class="nn">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">project</span><span class="o">-</span><span class="n">fifo</span><span class="o">/</span><span class="n">howl</span><span class="p">.</span><span class="n">git</span> <span class="n">howl</span><span class="o">-</span><span class="n">test</span>
</span><span class='line'><span class="n">cd</span> <span class="n">howl</span><span class="o">-</span><span class="n">test</span>
</span><span class='line'><span class="n">git</span> <span class="n">checkout</span> <span class="n">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>And done, now since it&rsquo;s a <code>riak_core</code> app we should have a task called <code>stagedevrel</code> in our makefile which will basically generate three copies of <code>howl</code> for us in the folders <code>dev/dev{1,2,3}</code> and in the process take care of compiling and getting the dependencies. I prefer <code>stagedevrel</code> over the normal <code>devrel</code> since later on it will it easier to recompile code files (<code>make</code> is enough) because it links them to the right place instead of copying the.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="n">make</span> <span class="n">stagedevrel</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we&rsquo;ve to do a bit of a cheating, riak_text expects the root dir to be a git repository, that is why we can&rsquo;t just put the data in there directly, so we&rsquo;ve to manually build the tree for riak core and set up as git repositor.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="nv">Users</span><span class="o">/</span><span class="n">heinz</span><span class="o">/</span><span class="n">rt</span><span class="o">/</span><span class="n">howl</span>
</span><span class='line'><span class="n">cd</span> <span class="o">/</span><span class="nv">Users</span><span class="o">/</span><span class="n">heinz</span><span class="o">/</span><span class="n">rt</span><span class="o">/</span><span class="n">howl</span>
</span><span class='line'><span class="n">git</span> <span class="n">init</span>
</span><span class='line'>
</span><span class='line'><span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="nv">EOF</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">Users</span><span class="o">/</span><span class="n">heinz</span><span class="o">/</span><span class="n">rt</span><span class="o">/</span><span class="n">howl</span><span class="o">/</span><span class="p">.</span><span class="n">gitignore</span>
</span><span class='line'><span class="o">*/</span><span class="n">dev</span><span class="o">/*/</span><span class="n">bin</span>
</span><span class='line'><span class="o">*/</span><span class="n">dev</span><span class="o">/*/</span><span class="n">erts</span><span class="o">-*</span>
</span><span class='line'><span class="o">*/</span><span class="n">dev</span><span class="o">/*/</span><span class="n">lib</span>
</span><span class='line'><span class="o">*/</span><span class="n">dev</span><span class="o">/*/</span><span class="n">releases</span>
</span><span class='line'><span class="nv">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to link our devrel files and for my setup I&rsquo;ve to copy the <code>*.example</code> files of the <code>app.config</code> and <code>vm.args</code> into the right place they might be named differently for you.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="n">export</span> <span class="nv">RT_BASE</span><span class="o">=/</span><span class="nv">Users</span><span class="o">/</span><span class="n">heinz</span><span class="o">/</span><span class="n">rt</span><span class="o">/</span><span class="n">howl</span><span class="o">/</span><span class="n">howl</span><span class="o">-</span><span class="n">test</span>
</span><span class='line'><span class="n">export</span> <span class="nv">RC_BASE</span><span class="o">=/</span><span class="nv">Users</span><span class="o">/</span><span class="n">heinz</span><span class="o">/</span><span class="n">rt</span><span class="o">/</span><span class="n">raw</span><span class="o">/</span><span class="n">howl</span><span class="o">/</span><span class="n">howl</span><span class="o">-</span><span class="n">test</span>
</span><span class='line'><span class="n">for</span> <span class="n">i</span> <span class="n">in</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span>
</span><span class='line'><span class="n">do</span>
</span><span class='line'>  <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="sc">${</span><span class="nv">RT_BASE</span><span class="p">}</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">dev</span><span class="sc">${</span><span class="n">i</span><span class="p">}</span><span class="o">/</span>
</span><span class='line'>  <span class="n">cd</span> <span class="sc">${</span><span class="nv">RT_BASE</span><span class="p">}</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">dev</span><span class="sc">${</span><span class="n">i</span><span class="p">}</span><span class="o">/</span>
</span><span class='line'>  <span class="n">mkdir</span> <span class="n">data</span> <span class="n">etc</span>
</span><span class='line'>  <span class="n">touch</span> <span class="n">data</span><span class="o">/</span><span class="p">.</span><span class="n">gitignore</span>
</span><span class='line'>  <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="sc">${</span><span class="nv">RC_BASE</span><span class="p">}</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">dev</span><span class="sc">${</span><span class="n">i</span><span class="p">}</span><span class="o">/</span><span class="p">{</span><span class="n">bin</span><span class="p">,</span><span class="n">erts</span><span class="o">-*</span><span class="p">,</span><span class="n">lib</span><span class="p">,</span><span class="n">releases</span><span class="p">}</span> <span class="p">.</span>
</span><span class='line'>  <span class="n">cp</span> <span class="sc">${</span><span class="nv">RC_BASE</span><span class="p">}</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">dev</span><span class="sc">${</span><span class="n">i</span><span class="p">}</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vm</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">example</span> <span class="n">etc</span><span class="o">/</span><span class="n">vm</span><span class="p">.</span><span class="n">args</span>
</span><span class='line'>  <span class="n">cp</span> <span class="sc">${</span><span class="nv">RC_BASE</span><span class="p">}</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">dev</span><span class="sc">${</span><span class="n">i</span><span class="p">}</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">example</span> <span class="n">etc</span><span class="o">/</span><span class="n">app</span><span class="p">.</span><span class="n">config</span>
</span><span class='line'><span class="n">done</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>We still need to edit the <code>vm.args</code> in <code>dev/dev{1,2,3,4}/etc/</code>  since we need to set the correct cookie &ndash; I hope you still remember yours, I told you you&rsquo;d need it (if not you can just look in the <code>~/.riak_test.config</code>)!</p>

<p>That&rsquo;s it.</p>

<h2>Running a first test</h2>

<p>In the <code>riak_core</code> branch of <code>riak_test</code> I&rsquo;ve moved all the <code>riak_kv</code> specific tests from <code>tests</code> to <code>tests_riakkv</code> so you still can look at them but I left one of them in <code>tests</code>, namely the basic command test &ndash; it will check if your applications command (<code>howl</code> in our case) is well behaved.</p>

<p>We&rsquo;ll want to run it to see if <code>howl</code> is a good boy and does well to do so we&rsquo;ll need to get back into the <code>riak_test</code> folder and run the <code>riak_test</code> command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="n">cd</span> <span class="err">~</span><span class="o">/</span><span class="nv">Projects</span><span class="o">/</span><span class="n">riak_test</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">riak_test</span> <span class="o">-</span><span class="n">t</span> <span class="n">tests</span><span class="o">/*</span> <span class="o">-</span><span class="n">c</span> <span class="n">howl</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">b</span> <span class="n">none</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;d like to explain this a bit, the arguments have the following meaning:</p>

<ul>
<li><code>-t tests/*</code> &ndash; we&rsquo;ll be running all tests in the folder <code>tests/</code>.</li>
<li><code>-c howl</code> &ndash; our application we want to test is named howl, this is the first element of the tuple we put in our config file when you remember.</li>
<li><code>-v</code> &ndash; This just turns on verbose output.</li>
<li><code>-b none</code> &ndash; This is still a relict from the <code>riak_kv</code> roots, it means which backend to test with, since we don&rsquo;t have backends at all we&rsquo;ll just pass none which means riak_test will happily ignore it.</li>
</ul>


<p>That&rsquo;s it! Now go and test all the things!</p>

<p>This is the first part of a series that goes on <a href="/blog/2013/04/09/writing-your-first-riak-test-test-yes-i-know-there-are-two-tests-there/">here</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/19/plugins-with-erlang/">Plugins With Erlang</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-19T16:45:00+01:00" pubdate data-updated="true">Mar 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Preamble</h2>

<p>Lets start with this, Erlang releases are super useful they are one of the features I like most about Erlang &ndash; you get out an entirely self contained package you can deploy and forget, no library trouble, no wrong version of the VM no trouble at all.</p>

<p>BUT (this had to come didn&rsquo;t it) sometimes they are limiting and kind of inflexible, adding a tiny little feature means rolling out a new release, with automated builds that is not so bad but &lsquo;not so bad&rsquo; isn&rsquo;t good either. And things get worst when there are different wishes.</p>

<p>A little glimpse into reality: I&rsquo;m currently working a lot on <a href="http://project-fifo.net">Project FiFo</a> and one of the issues I faced is that &ndash; surprisingly &ndash; not everyone wants things to work exactly as I do. Which was a real shock, how could anyone ever disagree with me? Well &hellip; I got over it, really I did, still solving this issue by adding one code path for every preference and making it configureable didn&rsquo;t looked like a good solution.</p>

<p>Also recently we are thinking a lot about performance metrics, and there are like a gazillion of them and if you pick two random people I think they want three different sets of metrics. Ask again after 5 minutes and their opinions changed to 7 new metrics and certainly not the old ones!</p>

<h2>Plugins</h2>

<p>The problem is a very old one, extending the software after it was shipped, possibly letting the community extend it beyond what was dreamed of in the beginning. The solution is pretty much one day younger then the problem: plugins. Meaning a way to load code into the system.</p>

<p>Sounds easy but it is a bit more complex, just having something load into the VM doesn&rsquo;t do much good when it does not get executed in the proper place &ndash; so sadly this comes with extra work for the developer to sprinkle their code with hooks and callbacks for the plugins.</p>

<p>With this I&rsquo;d like to introduce <a href="https://github.com/Licenser/eplugin">eplugin</a> it&rsquo;s a very simplistic library for exactly that task &ndash; introduce plugins in an Erlang release or application. It takes care of discovering and loading plugins, letting them register into certain calls, a little dependency management on startup and provides functions to call registered plugins. Erlang comes with great tools already to the whole thing sums up to under 400 LOC.</p>

<h2>Types of plugins</h2>

<p>I feel it&rsquo;s kind of interesting to look at the different kind of plugins that exist and how to handle the cases with <a href="https://github.com/Licenser/eplugin">eplugin</a> also a post entirely without code would look boring.</p>

<h3>informative plugins</h3>

<p>Sometimes a plugin just want to know that something happened but don&rsquo;t care about the result. <code>eplugin</code> provides the <code>call</code> (and <code>apply</code>) functions for that. A logger is a good example for this so lets have a look:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%%% plugin.conf</span>
</span><span class='line'><span class="p">{</span><span class="n">syslog_plugin</span><span class="p">,</span>
</span><span class='line'>  <span class="p">[{</span><span class="n">syslog_plugin</span><span class="p">,</span> <span class="p">[{</span><span class="n">&#39;some:event&#39;</span><span class="p">,</span> <span class="n">log</span><span class="p">}]}],</span>
</span><span class='line'>  <span class="p">[]}.</span>
</span><span class='line'>
</span><span class='line'><span class="c">%%% syslog_plugin.erl</span>
</span><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">syslog_plugin</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">log</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">log</span><span class="p">(</span><span class="nv">String</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nn">os</span><span class="p">:</span><span class="nf">cmd</span><span class="p">(</span><span class="s">&quot;logger &#39;&quot;</span> <span class="o">++</span> <span class="nv">String</span> <span class="o">++</span> <span class="s">&quot;&#39;&quot;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="c">%%% in your code</span>
</span><span class='line'>  <span class="c">%%... </span>
</span><span class='line'>  <span class="nn">eplugin</span><span class="p">:</span><span class="nf">call</span><span class="p">(</span><span class="n">&#39;some:event&#39;</span><span class="p">,</span> <span class="s">&quot;logging this!&quot;</span><span class="p">),</span>
</span><span class='line'>  <span class="c">%%... </span>
</span></code></pre></td></tr></table></div></figure>


<p>Thats pretty much it, provided you&rsquo;ve started the <code>eplugin</code> application in your code and put the plugins in the right place this will just work. You could also use this to trigger side effects, like delete all files when an error occurs to remove traces of your failure.</p>

<h3>messing around plugins</h3>

<p>This kind of plugins process some data and return a new version of this data, we have <code>fold</code> for this case. Fold since it internally uses fold to pass the data from one plugin to another. there are many applications for that one would be to replace all occurrences of &lsquo;not js&rsquo; with &lsquo;node.js&rsquo; to prevent freudian typos in your texts.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%%% plugin.conf</span>
</span><span class='line'><span class="p">{</span><span class="n">not_js</span><span class="p">,</span>
</span><span class='line'>  <span class="p">[{</span><span class="n">not_js</span><span class="p">,</span> <span class="p">[{</span><span class="n">&#39;text:check&#39;</span><span class="p">,</span> <span class="n">replace</span><span class="p">}]}],</span>
</span><span class='line'>  <span class="p">[]}.</span>
</span><span class='line'>
</span><span class='line'><span class="c">%%% not_js.erl</span>
</span><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">not_js</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">replace</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">replace</span><span class="p">(</span><span class="nv">String</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nn">re</span><span class="p">:</span><span class="nf">replace</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span> <span class="s">&quot;not js&quot;</span><span class="p">,</span> <span class="s">&quot;node.js&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">global</span><span class="p">]).</span>
</span><span class='line'><span class="c">%%% in your code</span>
</span><span class='line'>  <span class="c">%%... </span>
</span><span class='line'>  <span class="nv">String1</span> <span class="o">=</span> <span class="nn">eplugin</span><span class="p">:</span><span class="nf">fold</span><span class="p">(</span><span class="n">&#39;text:check&#39;</span><span class="p">,</span> <span class="s">&quot;I&#39;m writing a not js application!&quot;</span><span class="p">),</span>
</span><span class='line'>  <span class="c">%%... </span>
</span></code></pre></td></tr></table></div></figure>


<p><code>fold</code> and <code>call</code> are the most interesting and important kind of plugins, they cover most if not all of the possible use cases of plugins so there is a special case left which I found useful to have.</p>

<h3>checking plugins</h3>

<p>Checking plugins are plugins which are supposed to decide if something is Ok or not, they are pretty much a case of <code>fold</code> that returns true or false (or actually whatever is not true). But <code>eplugin</code> solves this too, with the <code>test</code> function! An example here is authentication</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">%%% plugin.conf</span>
</span><span class='line'><span class="p">{</span><span class="n">get_out</span><span class="p">,</span>
</span><span class='line'>  <span class="p">[{</span><span class="n">get_out</span><span class="p">,</span> <span class="p">[{</span><span class="n">&#39;login:allowed&#39;</span><span class="p">,</span> <span class="n">no_really_not</span><span class="p">}]}],</span>
</span><span class='line'>  <span class="p">[]}.</span>
</span><span class='line'>
</span><span class='line'><span class="c">%%% get_out.erl</span>
</span><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">get_out</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">no_really_not</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">no_really_not</span><span class="p">(</span><span class="nv">Login</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="p">{</span><span class="n">forbidden</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;Dear &quot;</span><span class="p">,</span> <span class="nv">Login</span><span class="p">,</span> <span class="s">&quot; we don&#39;t want you here go away!&quot;</span><span class="p">]}.</span>
</span><span class='line'>
</span><span class='line'><span class="c">%%% in your code</span>
</span><span class='line'>  <span class="c">%%... </span>
</span><span class='line'>  <span class="k">case</span> <span class="nn">eplugin</span><span class="p">:</span><span class="nf">test</span><span class="p">(</span><span class="n">&#39;login:allowed&#39;</span><span class="p">,</span> <span class="s">&quot;Licenser&quot;</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>     <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">%%% huzza!</span>
</span><span class='line'>     <span class="nv">Error</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;</span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Error</span><span class="p">])</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c">%%... </span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/28/postmortom-of-a-interesting-bug/">Postmortom of a Interesting Bug</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/02/postmortem-of-a-interesting-bug/">Post-mortem of a Failed Support Case.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/01/01/backups-with-project-fifo/">Backups With Project FiFo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/13/a-asynchronous-gced-or-set/">A Asynchronously GCed or Set</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/11/asyncronous-garbage-collection-with-crdts/">Asynchronous Garbage Collection With CRDTs</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/Licenser">@Licenser</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'Licenser',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Heinz N. 'Licenser' Gies -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lice';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
