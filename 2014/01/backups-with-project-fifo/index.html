<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="Backups with Project FiFo"><meta property="og:description" content="With 0.4.3 FiFo introduces support for LeoFS and this allows for some quite nice new features. Most importantly it decouples FiFo's operations from storing big amounts of data which makes maintaining either of this much more sensible and scaling storage much more easy.
Then again while nice that is not the important part, just storing datasets somewhere else does not make much of a difference for most users but what LoeFS allows FiFo to store much more data then would be good in the old setup."><meta property="og:type" content="article"><meta property="og:url" content="https://bloc.licenser.net/2014/01/backups-with-project-fifo/"><meta property="article:published_time" content="2014-01-01T00:00:00+00:00"><meta property="article:modified_time" content="2014-01-01T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Backups with Project FiFo"><meta name=twitter:description content="With 0.4.3 FiFo introduces support for LeoFS and this allows for some quite nice new features. Most importantly it decouples FiFo's operations from storing big amounts of data which makes maintaining either of this much more sensible and scaling storage much more easy.
Then again while nice that is not the important part, just storing datasets somewhere else does not make much of a difference for most users but what LoeFS allows FiFo to store much more data then would be good in the old setup."><meta name=generator content="Hugo 0.62.2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Backups with Project FiFo","url":"https:\/\/bloc.licenser.net\/2014\/01\/backups-with-project-fifo\/","wordCount":"752","datePublished":"2014-01-01T00:00:00+00:00","dateModified":"2014-01-01T00:00:00+00:00","author":{"@type":"Person","name":"Heinz N. Gies"}}</script><link rel=canonical href=https://bloc.licenser.net/2014/01/backups-with-project-fifo/><title>Backups with Project FiFo | Lice!</title><link href=https://bloc.licenser.net/css/style.6da5c906cc7a8fbb93f31cd2316c5dbe3f19ac4aa6bfb066f1243045b8f6061e.css rel=stylesheet integrity="sha256-baXJBsx6j7uT8xzSMWxdvj8ZrEqmv7Bm8SQwRbj2Bh4=" crossorigin=anonymous><script defer src=https://bloc.licenser.net/js/fontawesome.min.90e14c13cee52929ac33e1c21694a3cc95063a194eb22aad9f7976434e1a9125.js integrity="sha256-kOFME87lKSmsM+HCFpSjzJUGOhlOsiqtn3l2Q04akSU=" crossorigin=anonymous></script></head><body><div class=blog-masthead><div class=container><nav class="nav blog-nav"><a class=nav-link href=https://bloc.licenser.net/>Home</a></nav></div></div><header class=blog-header><div class=container><h1 class=blog-title dir=auto><a href=https://bloc.licenser.net/ rel=home>Lice!</a></h1><p class="lead blog-description" dir=auto>A collection of somewhat random thoughts.</p></div></header><div class=container><div class=row><div class="col-sm-8 blog-main"><article class=blog-post><header><h2 class=blog-post-title dir=auto><a href=https://bloc.licenser.net/2014/01/backups-with-project-fifo/>Backups with Project FiFo</a></h2><p class=blog-post-meta><time datetime=2014-01-01T00:00:00Z>2014-01-01</time> by Heinz N. Gies</p></header><p>With 0.4.3 FiFo introduces support for <a href=http://www.leofs.org>LeoFS</a> and this allows for some quite nice new features. Most importantly it decouples FiFo's operations from storing big amounts of data which makes maintaining either of this much more sensible and scaling storage much more easy.</p><p>Then again while nice that is not the important part, just storing datasets somewhere else does not make much of a difference for most users but what LoeFS allows FiFo to store much more data then would be good in the old setup. &lsquo;A lot more&rsquo; here means pretty much as much as you can store.</p><p>So with this options 0.4.3 FiFo introduce backups! Backups complement the snapshots already in the system for quiet a while but while snapshots were made to stay on the hypervisor backups are supposed to be shipped off to LeoFS. This not only helps to keep the number of snapshots limited, does not count against the local quota but also widens the failure domain.</p><p>And to make it better there is a sensible concept about incremental and full backups, that said there are a few limitations to be aware of:</p><ul><li>Backups that stay on the hypervisor will count against the local quota.</li><li>Once a backup is moved away from the hypervisor it can't be restored without overwriting the current state.</li><li>Restoring a backup might mean first deleting the local zfs volume for the vm.</li></ul><p>But that aside that there are some very interesting things:</p><ul><li>While it's not possible to keep multiple branches with snapshots this is very well possible with backups.</li><li>It's possible to make a difference between incremental and full backups choosing between recovery speed or space efficiency.</li></ul><p>All that sums up to something quite awesome, it allows for proper grandfather backups concepts for VM's and they can even be scripted using the fifo python client. So here is an example how this could be done.</p><p>Lets quickly describe what we want to achieve:</p><ul><li>Every month we want a full backup.</li><li>Every week we want an incremental backup<ul><li>for the first week in a month towards the monthly full backup</li><li>for other weeks to the previous week</li></ul></li><li>Every day we want a incremental backup<ul><li>for the first day of a week from the week backup</li><li>for other days from the previous day</li></ul></li></ul><p>To allow for the incremental backups we need to keep some of the backups around:</p><ul><li>monthly until the first weekly was done.</li><li>weekly until the next weekly was done but not longer the the next monthly.</li><li>daily until the next daily but not longer then the next weekly or monthly.</li></ul><p>The FiFo backup code fortunately helps a lot with this, a important part of the logic is <em>&lsquo;create a incremental snapshot and delete its parent from the hypervisor&rsquo;</em> and that is exactly the behavior of the backup code when passing both a parent and requesting a delete.</p><p>Here some <a href=https://github.com/project-fifo/pyfi/blob/master/examples/backup.sh>code</a> (with some comments added):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/usr/bin/env bash
</span><span style=color:#75715e></span>fifo<span style=color:#f92672>=</span>fifo
vm<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>case</span> $1 in
    monthly<span style=color:#f92672>)</span>
        $fifo vms backups $vm create monthly
        <span style=color:#75715e># After createing a new monthly snapshot we first delete the last weekly and daily backup</span>
        last_daily<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>$fifo vms backups $vm list -pH --fmt uuid,local,comment | grep <span style=color:#e6db74>&#39;daily&#39;</span> | grep <span style=color:#e6db74>&#39;YES&#39;</span> | tail -1<span style=color:#66d9ef>)</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -z <span style=color:#e6db74>&#34;</span>$last_daily<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>
        <span style=color:#66d9ef>then</span>
            daily_uuid<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $last_daily | cut -d: -f1<span style=color:#66d9ef>)</span>
            <span style=color:#75715e># the -l flag tells FiFo to only remove the backup from the hypervisor.</span>
            $fifo vms backups $vm delete -l $daily_uuid
        <span style=color:#66d9ef>fi</span>
        last_weekly<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>$fifo vms backups $vm list -pH --fmt uuid,local,comment | grep <span style=color:#e6db74>&#39;weekly&#39;</span> | grep <span style=color:#e6db74>&#39;YES&#39;</span> | tail -1<span style=color:#66d9ef>)</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -z <span style=color:#e6db74>&#34;</span>$last_weekly<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>
        <span style=color:#66d9ef>then</span>
            weekly_uuid<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $last_weekly | cut -d: -f1<span style=color:#66d9ef>)</span>
            $fifo vms backups $vm delete -l $weekly_uuid
        <span style=color:#66d9ef>fi</span>
        ;;
    weekly<span style=color:#f92672>)</span>
        last_backup<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>$fifo vms backups $vm list -pH --fmt uuid,local,comment | grep <span style=color:#e6db74>&#39;monthly\|weekly&#39;</span> | grep <span style=color:#e6db74>&#39;YES&#39;</span> | tail -1<span style=color:#66d9ef>)</span>
        uuid<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $last_backup | cut -d: -f1<span style=color:#66d9ef>)</span>
        $fifo vms backups $vm create --parent $uuid -d weekly
        <span style=color:#75715e># After creating a new weekly we need to make sure to delete the last daily one</span>
        last_daily<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>$fifo vms backups $vm list -pH --fmt uuid,local,comment | grep <span style=color:#e6db74>&#39;daily&#39;</span> | grep <span style=color:#e6db74>&#39;YES&#39;</span> | tail -1<span style=color:#66d9ef>)</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -z <span style=color:#e6db74>&#34;</span>$last_daily<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>
        <span style=color:#66d9ef>then</span>
            daily_uuid<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $last_daily | cut -d: -f1<span style=color:#66d9ef>)</span>
            $fifo vms backups $vm delete -l $daily_uuid
        <span style=color:#66d9ef>fi</span>
        ;;
    daily<span style=color:#f92672>)</span>
        last_backup<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>$fifo vms backups $vm list -pH --fmt uuid,local,comment | grep <span style=color:#e6db74>&#39;daily\|weekly&#39;</span> | grep <span style=color:#e6db74>&#39;YES&#39;</span> | tail -1<span style=color:#66d9ef>)</span>
        uuid<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $last_backup | cut -d: -f1<span style=color:#66d9ef>)</span>
        type<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $last_backup | cut -d: -f2<span style=color:#66d9ef>)</span>
        <span style=color:#66d9ef>case</span> $type in
            weekly<span style=color:#f92672>)</span>
                $fifo vms backups $vm create --parent $uuid daily
                ;;
            daily<span style=color:#f92672>)</span>
                $fifo vms backups $vm create --parent $uuid -d daily
                ;;
        <span style=color:#66d9ef>esac</span>
        ;;
<span style=color:#66d9ef>esac</span>

</code></pre></div><hr><footer><section><h4>Share</h4><nav class="nav sharing-icons"><a class=nav-item href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fbloc.licenser.net%2f2014%2f01%2fbackups-with-project-fifo%2f" title="Share on Facebook"><span class="fab fa-facebook-f fa-2x" aria-hidden=true></span></a><a class=nav-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fbloc.licenser.net%2f2014%2f01%2fbackups-with-project-fifo%2f" title="Share on LinkedIn"><span class="fab fa-linkedin-in fa-2x" aria-hidden=true></span></a><a class=nav-item href="https://twitter.com/intent/tweet?url=https%3a%2f%2fbloc.licenser.net%2f2014%2f01%2fbackups-with-project-fifo%2f&text=Backups%20with%20Project%20FiFo" title="Tweet this"><span class="fab fa-twitter fa-2x"></span></a></nav></section></footer></article></div><aside class="col-sm-3 ml-auto blog-sidebar"><section class=sidebar-module><h4>Links</h4><ol class=list-unstyled><li><a href=https://github.com/Licenser>GitHub</a></li></ol></section></aside></div></div><footer class=blog-footer><p dir=auto>Blog template created by <a href=https://twitter.com/mdo>@mdo</a>, ported to Hugo by <a href=https://twitter.com/mralanorth>@mralanorth</a>.</p><p><a href=#>Back to top</a></p></footer></body></html>