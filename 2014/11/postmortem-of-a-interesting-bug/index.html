<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="Postmortem of a interesting bug"><meta property="og:description" content="Symptoms After a full network outage in a larger system (7 FiFo instances and, a few dozen of hypervisors, VM's in the 3 digit number) a small percentage of the VM's stored in FiFo lost information which package was assigned to them and which organization they belong to.
Technical background As part of planned maintenance on the switching layer the entire network was taken down. Effectively cutting the communication between any two systems in the network."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.licenser.net/2014/11/postmortem-of-a-interesting-bug/"><meta property="article:published_time" content="2014-11-28T00:00:00+00:00"><meta property="article:modified_time" content="2014-11-28T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Postmortem of a interesting bug"><meta name=twitter:description content="Symptoms After a full network outage in a larger system (7 FiFo instances and, a few dozen of hypervisors, VM's in the 3 digit number) a small percentage of the VM's stored in FiFo lost information which package was assigned to them and which organization they belong to.
Technical background As part of planned maintenance on the switching layer the entire network was taken down. Effectively cutting the communication between any two systems in the network."><meta name=generator content="Hugo 0.62.2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Postmortem of a interesting bug","url":"https:\/\/blog.licenser.net\/2014\/11\/postmortem-of-a-interesting-bug\/","wordCount":"703","datePublished":"2014-11-28T00:00:00+00:00","dateModified":"2014-11-28T00:00:00+00:00","author":{"@type":"Person","name":"Heinz N. Gies"}}</script><link rel=canonical href=https://blog.licenser.net/2014/11/postmortem-of-a-interesting-bug/><title>Postmortem of a interesting bug | Lice!</title><link href=https://blog.licenser.net/css/style.6da5c906cc7a8fbb93f31cd2316c5dbe3f19ac4aa6bfb066f1243045b8f6061e.css rel=stylesheet integrity="sha256-baXJBsx6j7uT8xzSMWxdvj8ZrEqmv7Bm8SQwRbj2Bh4=" crossorigin=anonymous><script defer src=https://blog.licenser.net/js/fontawesome.min.90e14c13cee52929ac33e1c21694a3cc95063a194eb22aad9f7976434e1a9125.js integrity="sha256-kOFME87lKSmsM+HCFpSjzJUGOhlOsiqtn3l2Q04akSU=" crossorigin=anonymous></script></head><body><div class=blog-masthead><div class=container><nav class="nav blog-nav"><a class=nav-link href=https://blog.licenser.net/>Home</a></nav></div></div><header class=blog-header><div class=container><h1 class=blog-title dir=auto><a href=https://blog.licenser.net/ rel=home>Lice!</a></h1><p class="lead blog-description" dir=auto>A collection of somewhat random thoughts.</p></div></header><div class=container><div class=row><div class="col-sm-8 blog-main"><article class=blog-post><header><h2 class=blog-post-title dir=auto><a href=https://blog.licenser.net/2014/11/postmortem-of-a-interesting-bug/>Postmortem of a interesting bug</a></h2><p class=blog-post-meta><time datetime=2014-11-28T00:00:00Z>2014-11-28</time> by Heinz N. Gies</p></header><h2 id=symptoms>Symptoms</h2><p>After a full network outage in a larger system (7 FiFo instances and, a few dozen of hypervisors, VM's in the 3 digit number) a small percentage of the VM's stored in FiFo lost information which package was assigned to them and which organization they belong to.</p><h2 id=technical-background>Technical background</h2><p>As part of planned maintenance on the switching layer the entire network was taken down. Effectively cutting the communication between any two systems in the network. During the maintenance the FiFo system was kept &ldquo;hot&rdquo;, no services disabled or paused. At the end of the maintenance window the network was as planned enabled again, reinstating communications.</p><h2 id=fifo-background>FiFo background</h2><p>We will focus in the sniffle and chunter components since those are the relevant parts of sniffle that handle information related to the symptoms.
Â¯
Generally all fifo data is stored in CRDT's which provides conflict resolution and nearly loss free merging even of entirely divergent data.</p><h3 id=sniffle>Sniffle</h3><p>Sniffle is a distributed system that runs on top of riak_core, all (7) nodes are connected as a mash network via distributed erlang. While the nodes are connected data and functionality is split out in dynamo fashion, at a default N value of 3 that means every node handles (total data)*3/7 of the data.</p><p>In the case of a node failure the adjacent node takes over the function of the failed node. Missing data is resolved by a method called &ldquo;read repair&rdquo;, meaning that when data is requested and 1 out of the 3 nodes responds with no data that &ldquo;missing&rdquo; data is repaired.</p><p>Once the node failure is repaired the system that took over the work for the failed node performs what is called a handoff, sending it's (supposedly) updated data to the returning node to bring it up to speed.</p><h3 id=chunter>Chunter</h3><p>Under normal conditions chunter will send incremental updates about changing vm state to sniffle. If a chunter system for the first time connects to sniffle it will register it's VM's, meaning they are created if not existent, and assigned to the hypervisor. The registration contains nearly all relevant VM information with some exceptions that do not concern the hypervisor. The missing information was amongst the not updated information.</p><p>Sniffle nodes are discovered via mDNS broadcasts, the first broadcast received will trigger the initial registration sending the request to this node.</p><h2 id=what-happened>What happened?</h2><p>It is a combination of conditions that lead to the problem and explains why only a small percentage of VM's were affected.</p><h3 id=during-the-outage>During the outage</h3><ol><li>The network outage cut the communication between <strong>all</strong> sniffle nodes, so each node was on its own handling the full load of the requests.</li><li>The network outage cut communication of <strong>nearly all</strong> chunter nodes, only those who resided on a hypervisor that also contained a fifo zone did not loose connectivity.</li></ol><h3 id=after-the-outage>After the outage</h3><p>Now there happened a race condition, on one side the distributed erlang started to re-discover the other nodes, reestablishing communication in sniffle and initializing handoffs (handoffs of nearly all parts).</p><p>On the other side the periodic mDNS broadcasts from the sniffle nodes triggered re-registration of the chunter nodes.</p><h3 id=the-bug>The bug</h3><p>The bug was triggered by the fact that during receiving a handoff a vnode took the wrong assumption that the received data must be newer then its own and overwrite the currently stored data instead of merging it.</p><p>Due to the usual repair during reads this turned out to be quite an edge case that was only triggered when:</p><ol><li>The mDNS was received from a node that neither holds the right partition, neither is connected to a node holding the right partition.</li><li>the registration happened to three vnodes that did not hold that data since as long as one node held the data it would have been merged with this instead of re-created</li><li>The handoff on all three systems was performed before any read happened, since the read-repair would haver otherwise merged the data.</li><li>The handoff off all three systems was performed before AAE triggered, since AAE triggers a read-repair on inconsistent data.</li></ol><h2 id=the-fix>The fix</h2><p>This was fixed rather simple, instead of overwriting existing data on a handoff, the handoff is now treated as a read-repair and old and existing data is merged.</p><hr><footer><section><h4>Share</h4><nav class="nav sharing-icons"><a class=nav-item href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.licenser.net%2f2014%2f11%2fpostmortem-of-a-interesting-bug%2f" title="Share on Facebook"><span class="fab fa-facebook-f fa-2x" aria-hidden=true></span></a><a class=nav-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.licenser.net%2f2014%2f11%2fpostmortem-of-a-interesting-bug%2f" title="Share on LinkedIn"><span class="fab fa-linkedin-in fa-2x" aria-hidden=true></span></a><a class=nav-item href="https://twitter.com/intent/tweet?url=https%3a%2f%2fblog.licenser.net%2f2014%2f11%2fpostmortem-of-a-interesting-bug%2f&text=Postmortem%20of%20a%20interesting%20bug" title="Tweet this"><span class="fab fa-twitter fa-2x"></span></a></nav></section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"lice"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="col-sm-3 ml-auto blog-sidebar"><section class=sidebar-module><h4>Links</h4><ol class=list-unstyled><li><a href=https://github.com/Licenser>GitHub</a></li></ol></section></aside></div></div><footer class=blog-footer><p dir=auto>Blog template created by <a href=https://twitter.com/mdo>@mdo</a>, ported to Hugo by <a href=https://twitter.com/mralanorth>@mralanorth</a>.</p><p><a href=#>Back to top</a></p></footer></body></html>