<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="Erlang and more DTrace"><meta property="og:description" content="Some nice additions to the little Erlang DTrace demo. For once I've added a filed to input custom scripts which are run on the server which is pretty neat since it allows running all kind of (l)quantize based scripts from the server and get a nice heatmap.
Like how about the heatmap of how Erlang function call times?
The script used (also included in the repository):
erlang*:::global-function-entry { self->funcall_entry_ts[copyinstr(arg1)] = vtimestamp; } erlang*:::function-return { @time[copyinstr(arg1)] = lquantize((vtimestamp - self->funcall_entry_ts[copyinstr(arg1)] ) / 1000, 0, 63, 2); } Now that is already cool but there is more, in addition to there is a page now that allows to show list based queries (as count or sum) so for example it would be very easy to get a profiling of an Erlang program like this:"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.licenser.net/2013/01/erlang-and-more-dtrace/"><meta property="article:published_time" content="2013-01-28T00:00:00+00:00"><meta property="article:modified_time" content="2013-01-28T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Erlang and more DTrace"><meta name=twitter:description content="Some nice additions to the little Erlang DTrace demo. For once I've added a filed to input custom scripts which are run on the server which is pretty neat since it allows running all kind of (l)quantize based scripts from the server and get a nice heatmap.
Like how about the heatmap of how Erlang function call times?
The script used (also included in the repository):
erlang*:::global-function-entry { self->funcall_entry_ts[copyinstr(arg1)] = vtimestamp; } erlang*:::function-return { @time[copyinstr(arg1)] = lquantize((vtimestamp - self->funcall_entry_ts[copyinstr(arg1)] ) / 1000, 0, 63, 2); } Now that is already cool but there is more, in addition to there is a page now that allows to show list based queries (as count or sum) so for example it would be very easy to get a profiling of an Erlang program like this:"><meta name=generator content="Hugo 0.62.2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Erlang and more DTrace","url":"https:\/\/blog.licenser.net\/2013\/01\/erlang-and-more-dtrace\/","wordCount":"278","datePublished":"2013-01-28T00:00:00+00:00","dateModified":"2013-01-28T00:00:00+00:00","author":{"@type":"Person","name":"Heinz N. Gies"}}</script><link rel=canonical href=https://blog.licenser.net/2013/01/erlang-and-more-dtrace/><title>Erlang and more DTrace | Lice!</title><link href=https://blog.licenser.net/css/style.6da5c906cc7a8fbb93f31cd2316c5dbe3f19ac4aa6bfb066f1243045b8f6061e.css rel=stylesheet integrity="sha256-baXJBsx6j7uT8xzSMWxdvj8ZrEqmv7Bm8SQwRbj2Bh4=" crossorigin=anonymous><script defer src=https://blog.licenser.net/js/fontawesome.min.90e14c13cee52929ac33e1c21694a3cc95063a194eb22aad9f7976434e1a9125.js integrity="sha256-kOFME87lKSmsM+HCFpSjzJUGOhlOsiqtn3l2Q04akSU=" crossorigin=anonymous></script></head><body><div class=blog-masthead><div class=container><nav class="nav blog-nav"><a class=nav-link href=https://blog.licenser.net/>Home</a></nav></div></div><header class=blog-header><div class=container><h1 class=blog-title dir=auto><a href=https://blog.licenser.net/ rel=home>Lice!</a></h1><p class="lead blog-description" dir=auto>A collection of somewhat random thoughts.</p></div></header><div class=container><div class=row><div class="col-sm-8 blog-main"><article class=blog-post><header><h2 class=blog-post-title dir=auto><a href=https://blog.licenser.net/2013/01/erlang-and-more-dtrace/>Erlang and more DTrace</a></h2><p class=blog-post-meta><time datetime=2013-01-28T00:00:00Z>2013-01-28</time> by Heinz N. Gies</p></header><p>Some nice additions to the little Erlang DTrace demo. For once I've added a filed to input custom scripts which are run on the server which is pretty neat since it allows running all kind of (l)quantize based scripts from the server and get a nice heatmap.</p><p>Like how about the heatmap of how Erlang function call times?</p><p><img src=/images/posts/2013-01-28-erlang-and-more-dtrace-1.png alt="Erlang Call Heatmap"></p><p>The script used (also included in the repository):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-d data-lang=d>erlang<span style=color:#f92672>*</span><span style=color:#f92672>:</span><span style=color:#f92672>:</span><span style=color:#f92672>:</span>global<span style=color:#f92672>-</span><span style=color:#66d9ef>function</span><span style=color:#f92672>-</span>entry
<span style=color:#f92672>{</span>
  self<span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>funcall_entry_ts<span style=color:#f92672>[</span>copyinstr<span style=color:#f92672>(</span>arg1<span style=color:#f92672>)</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> vtimestamp<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
erlang<span style=color:#f92672>*</span><span style=color:#f92672>:</span><span style=color:#f92672>:</span><span style=color:#f92672>:</span><span style=color:#66d9ef>function</span><span style=color:#f92672>-</span><span style=color:#66d9ef>return</span>
<span style=color:#f92672>{</span>
  <span style=color:#a6e22e>@time</span><span style=color:#f92672>[</span>copyinstr<span style=color:#f92672>(</span>arg1<span style=color:#f92672>)</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> lquantize<span style=color:#f92672>(</span><span style=color:#f92672>(</span>vtimestamp <span style=color:#f92672>-</span> self<span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>funcall_entry_ts<span style=color:#f92672>[</span>copyinstr<span style=color:#f92672>(</span>arg1<span style=color:#f92672>)</span><span style=color:#f92672>]</span> <span style=color:#f92672>)</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>63</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>)</span><span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Now that is already cool <strong>but</strong> there is more, in addition to there is a page now that allows to show list based queries (as count or sum) so for example it would be very easy to get a profiling of an Erlang program like this:</p><p><img src=/images/posts/2013-01-28-erlang-and-more-dtrace-2.png alt="Erlang Profiling"></p><p>The script used (also included in the repository):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-d data-lang=d>erlang<span style=color:#f92672>*</span><span style=color:#f92672>:</span><span style=color:#f92672>:</span><span style=color:#f92672>:</span>global<span style=color:#f92672>-</span><span style=color:#66d9ef>function</span><span style=color:#f92672>-</span>entry
<span style=color:#f92672>{</span>
  self<span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>funcall_entry_ts<span style=color:#f92672>[</span>copyinstr<span style=color:#f92672>(</span>arg1<span style=color:#f92672>)</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> vtimestamp<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
erlang<span style=color:#f92672>*</span><span style=color:#f92672>:</span><span style=color:#f92672>:</span><span style=color:#f92672>:</span><span style=color:#66d9ef>function</span><span style=color:#f92672>-</span><span style=color:#66d9ef>return</span>
<span style=color:#f92672>{</span>
  <span style=color:#a6e22e>@time</span><span style=color:#f92672>[</span>copyinstr<span style=color:#f92672>(</span>arg1<span style=color:#f92672>)</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> sum<span style=color:#f92672>(</span><span style=color:#f92672>(</span>vtimestamp <span style=color:#f92672>-</span> self<span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>funcall_entry_ts<span style=color:#f92672>[</span>copyinstr<span style=color:#f92672>(</span>arg1<span style=color:#f92672>)</span><span style=color:#f92672>]</span> <span style=color:#f92672>)</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span><span style=color:#f92672>)</span><span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Cool thing is this profiling can be turned on and off in a live system and has a <strong>comparable low</strong> performance impact (less then 50% unless functions are hammering in my tests).</p><p>To add to the joy, the scripts are stopped the moment the page is closed eliminating every kind of overhead, without restarting anything!</p><p>So lets sum this up, the old news (when you played with dtrace before) is that you can profile and analyse your applications on the fly with minimal impact, but the funky part is that you can do it directly as part of your application and only shows when you actually look at the page :) it's kind of like quantumanalytics just the other way round!</p><hr><footer><section><h4>Share</h4><nav class="nav sharing-icons"><a class=nav-item href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.licenser.net%2f2013%2f01%2ferlang-and-more-dtrace%2f" title="Share on Facebook"><span class="fab fa-facebook-f fa-2x" aria-hidden=true></span></a><a class=nav-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.licenser.net%2f2013%2f01%2ferlang-and-more-dtrace%2f" title="Share on LinkedIn"><span class="fab fa-linkedin-in fa-2x" aria-hidden=true></span></a><a class=nav-item href="https://twitter.com/intent/tweet?url=https%3a%2f%2fblog.licenser.net%2f2013%2f01%2ferlang-and-more-dtrace%2f&text=Erlang%20and%20more%20DTrace" title="Tweet this"><span class="fab fa-twitter fa-2x"></span></a></nav></section></footer></article></div><aside class="col-sm-3 ml-auto blog-sidebar"><section class=sidebar-module><h4>Links</h4><ol class=list-unstyled><li><a href=https://github.com/Licenser>GitHub</a></li></ol></section></aside></div></div><footer class=blog-footer><p dir=auto>Blog template created by <a href=https://twitter.com/mdo>@mdo</a>, ported to Hugo by <a href=https://twitter.com/mralanorth>@mralanorth</a>.</p><p><a href=#>Back to top</a></p></footer></body></html>