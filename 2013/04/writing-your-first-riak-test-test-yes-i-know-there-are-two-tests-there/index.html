<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="Writing your first riak test test (yes I know there are two tests there)"><meta property="og:description" content="As promised in a previous post I'll talk a bit about writing tests for riak_test. To start with the obvious it's pretty simple and pretty awesome. riak_test gives you the tools you've dreamed of when testing distributed riak_core applications:
 a backchannel to communicate and execute commands on the nodes. a nice and way to bring up and tear down the test environment. helper functions to deal with the riak_core cluster."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.licenser.net/2013/04/writing-your-first-riak-test-test-yes-i-know-there-are-two-tests-there/"><meta property="article:published_time" content="2013-04-09T00:00:00+00:00"><meta property="article:modified_time" content="2013-04-09T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Writing your first riak test test (yes I know there are two tests there)"><meta name=twitter:description content="As promised in a previous post I'll talk a bit about writing tests for riak_test. To start with the obvious it's pretty simple and pretty awesome. riak_test gives you the tools you've dreamed of when testing distributed riak_core applications:
 a backchannel to communicate and execute commands on the nodes. a nice and way to bring up and tear down the test environment. helper functions to deal with the riak_core cluster."><meta name=generator content="Hugo 0.62.2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Writing your first riak test test (yes I know there are two tests there)","url":"https:\/\/blog.licenser.net\/2013\/04\/writing-your-first-riak-test-test-yes-i-know-there-are-two-tests-there\/","wordCount":"770","datePublished":"2013-04-09T00:00:00+00:00","dateModified":"2013-04-09T00:00:00+00:00","author":{"@type":"Person","name":"Heinz N. Gies"}}</script><link rel=canonical href=https://blog.licenser.net/2013/04/writing-your-first-riak-test-test-yes-i-know-there-are-two-tests-there/><title>Writing your first riak test test (yes I know there are two tests there) | Lice!</title><link href=https://blog.licenser.net/css/style.6da5c906cc7a8fbb93f31cd2316c5dbe3f19ac4aa6bfb066f1243045b8f6061e.css rel=stylesheet integrity="sha256-baXJBsx6j7uT8xzSMWxdvj8ZrEqmv7Bm8SQwRbj2Bh4=" crossorigin=anonymous><script defer src=https://blog.licenser.net/js/fontawesome.min.90e14c13cee52929ac33e1c21694a3cc95063a194eb22aad9f7976434e1a9125.js integrity="sha256-kOFME87lKSmsM+HCFpSjzJUGOhlOsiqtn3l2Q04akSU=" crossorigin=anonymous></script></head><body><div class=blog-masthead><div class=container><nav class="nav blog-nav"><a class=nav-link href=https://blog.licenser.net/>Home</a></nav></div></div><header class=blog-header><div class=container><h1 class=blog-title dir=auto><a href=https://blog.licenser.net/ rel=home>Lice!</a></h1><p class="lead blog-description" dir=auto>A collection of somewhat random thoughts.</p></div></header><div class=container><div class=row><div class="col-sm-8 blog-main"><article class=blog-post><header><h2 class=blog-post-title dir=auto><a href=https://blog.licenser.net/2013/04/writing-your-first-riak-test-test-yes-i-know-there-are-two-tests-there/>Writing your first riak test test (yes I know there are two tests there)</a></h2><p class=blog-post-meta><time datetime=2013-04-09T00:00:00Z>2013-04-09</time> by Heinz N. Gies</p></header><p>As promised in a <a href=/blog/2013/03/31/getting-started-with-riak-test-and-riak-core/>previous post</a> I'll talk a bit about writing tests for <code>riak_test</code>. To start with the obvious it's pretty simple and pretty awesome. <code>riak_test</code> gives you the tools you've dreamed of when testing distributed <code>riak_core</code> applications:</p><ul><li>a backchannel to communicate and execute commands on the nodes.</li><li>a nice and way to bring up and tear down the test environment.</li><li>helper functions to deal with the <code>riak_core</code> cluster.</li><li>something called <code>intercepts</code> that allow you to mock certain behaviours in the cluster.</li><li>all the power of Erlang.</li></ul><h2 id=how-a-test-works>How a test works</h2><p>Tests have a very simple structre they pretty much contain a single function: <code>confirm/0</code></p><p>This function gets called when the test is executed and should return <code>pass</code> when everything works well or throw an exception when not. The actual test are simple unit asserts you use.</p><p>That in itself is not really overly exciting and those of you with a short attention span might start to thing &lsquo;boooooooring&rsquo; so lets look at the exciting part.</p><h2 id=starting-your-applicatio>Starting your applicatio</h2><p><code>riak_test</code> offers a way to start instances of your application and communicate with them, the common pattern is to start one (or more) nodes as first part of the script and check of they are up and running. That could look something like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=color:#a6e22e>confirm</span>() <span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>
    [Node] <span style=color:#f92672>=</span> rt:<span style=color:#a6e22e>deploy_nodes</span>(<span style=color:#ae81ff>1</span>),
    <span style=color:#f92672>?</span>assertEqual(ok, rt:<span style=color:#a6e22e>wait_until_nodes_ready</span>([Node])),
    pass.
</code></pre></div><p>This is a minimal test it sets up one instance of our application and waits for it to be ready.</p><p><code>rt:deploy_nodes(1)</code> will deploy one node, the id of the node (a atom with that identifies it to erlang) will be sotred in <code>Node</code>, you can deploy more nodes by increasing the number in <code>rt:deploy_nodes/1</code>.</p><p><code>?assertEqual(ok, rt:wait_until_nodes_ready([Node]))</code> will make the test wait for the nodes to be ready, ready here means that all ring services we defined in the config are provided.</p><p>The node will be running in its own Erlang VM and have the test suite connected as a hidden node. This is the first thing that is truly interesting, since the connection will allow us to run rpc calls on the node this is the first thing that is truly fun.</p><h2 id=an-official-channel>An official channel</h2><p>Now we've a basic test running have our nodes to be started up and the test waiting until all is started and happy.</p><p>So chances are that aside of this back channel communication the node provides some kind of API, and we want to be able to connect to this API to run our tests. Un my case it's a simple TCP port that announces itself over mdns, we could simply listen to the broadcast and use the information it provides to talk to the node. This would work, as long as we've a single node, the moment we've to we would never know which node we're talking to and that would make testing hard.</p><p>So backchannel to the rescue! We'll just get the nodes configuration from the host, for my application I store this kind of information in the application configuration so I've made a function that given a <code>Node</code> returns <code>IP</code> and <code>Port</code> for it to talk to plus one to send data:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=color:#a6e22e>node_endpoing</span>(Node) <span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>
    {ok, IP} <span style=color:#f92672>=</span> rpc:<span style=color:#a6e22e>call</span>(Node, application, get_env, [mdns_server_lib, ip]),
    {ok, Port} <span style=color:#f92672>=</span> rpc:<span style=color:#a6e22e>call</span>(Node, application, get_env, [mdns_server_lib, port]),
    {IP, Port}.

<span style=color:#a6e22e>call</span>(Node, Msg) <span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>
    {IP, Port} <span style=color:#f92672>=</span> node_endpoing(Node),
    lager:<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>~s</span><span style=color:#e6db74>:</span><span style=color:#e6db74>~p</span><span style=color:#e6db74> &lt;- </span><span style=color:#e6db74>~p</span><span style=color:#e6db74>&#34;</span>, [IP, Port, Msg]),
    {ok, Socket} <span style=color:#f92672>=</span> gen_tcp:<span style=color:#a6e22e>connect</span>(IP, Port, [binary, {active,false}, {packet,<span style=color:#ae81ff>4</span>}], <span style=color:#ae81ff>100</span>),
    ok <span style=color:#f92672>=</span> gen_tcp:send(Socket, term_to_binary(Msg)),
    {ok, Repl} <span style=color:#f92672>=</span> gen_tcp:<span style=color:#a6e22e>recv</span>(Socket, <span style=color:#ae81ff>0</span>),
    {reply, Res} <span style=color:#f92672>=</span> binary_to_term(Repl),
    lager:<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>~s</span><span style=color:#e6db74>:</span><span style=color:#e6db74>~p</span><span style=color:#e6db74> -&gt; </span><span style=color:#e6db74>~p</span><span style=color:#e6db74>&#34;</span>, [IP, Port, Res]),
    gen_tcp:<span style=color:#a6e22e>close</span>(Socket),
    Res.
</code></pre></div><p>There is some <code>gen_tcp</code> stuff in there but lets just ignore it for now it's detail not important, the first function is the more interesting one it uses the <code>rpc</code> module to execute the commands on the node we just started which is quite awesome.</p><p>As a note I've put those functions into <code>rt_&lt;applicatin name></code> so for example rt_sniffle.</p><h2 id=testing-the-api>Testing the API</h2><p>With <code>call/2</code> we've now a way to send data directly to the node over the official API channel so lets add to our test. So lets get back to our <code>confirm/0</code> and add some real tests:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=color:#a6e22e>confirm</span>() <span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>
    [Node] <span style=color:#f92672>=</span> rt:<span style=color:#a6e22e>deploy_nodes</span>(<span style=color:#ae81ff>1</span>),
    <span style=color:#f92672>?</span>assertEqual(ok, rt:<span style=color:#a6e22e>wait_until_nodes_ready</span>([Node])),
    <span style=color:#f92672>?</span>assertEqual({ok,[]},
                 rt_sniffle:<span style=color:#a6e22e>call</span>(Node, {vm, list})),
    <span style=color:#f92672>?</span>assertEqual(ok,
                 rt_sniffle:<span style=color:#a6e22e>call</span>(Node, {vm, register, <span style=color:#f92672>&lt;</span><span style=color:#f92672>&lt;</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>vmid</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>&gt;</span><span style=color:#f92672>&gt;</span>, <span style=color:#f92672>&lt;</span><span style=color:#f92672>&lt;</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>hypervisor</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>&gt;</span><span style=color:#f92672>&gt;</span>})),
    <span style=color:#f92672>?</span>assertEqual({ok,[<span style=color:#f92672>&lt;</span><span style=color:#f92672>&lt;</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>vmid</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>&gt;</span><span style=color:#f92672>&gt;</span>]},
                 rt_sniffle:<span style=color:#a6e22e>call</span>(Node, {vm, list})),                 
    pass.
</code></pre></div><p>It's as easy as this, this test will</p><ul><li>List the registered VM's and expect none to be there.</li><li>Create a new VM and expect a ok result.</li><li>List the registered vm's and expect the one we just registered to be present.</li></ul><p>And that's it for basic testing with <code>riak_test</code> I'll follow up on this with an article over intercepts since they add another cool feature to <code>riak_test</code>.</p><hr><footer><section><h4>Share</h4><nav class="nav sharing-icons"><a class=nav-item href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.licenser.net%2f2013%2f04%2fwriting-your-first-riak-test-test-yes-i-know-there-are-two-tests-there%2f" title="Share on Facebook"><span class="fab fa-facebook-f fa-2x" aria-hidden=true></span></a><a class=nav-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.licenser.net%2f2013%2f04%2fwriting-your-first-riak-test-test-yes-i-know-there-are-two-tests-there%2f" title="Share on LinkedIn"><span class="fab fa-linkedin-in fa-2x" aria-hidden=true></span></a><a class=nav-item href="https://twitter.com/intent/tweet?url=https%3a%2f%2fblog.licenser.net%2f2013%2f04%2fwriting-your-first-riak-test-test-yes-i-know-there-are-two-tests-there%2f&text=Writing%20your%20first%20riak%20test%20test%20%28yes%20I%20know%20there%20are%20two%20tests%20there%29" title="Tweet this"><span class="fab fa-twitter fa-2x"></span></a></nav></section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"lice"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="col-sm-3 ml-auto blog-sidebar"><section class=sidebar-module><h4>Links</h4><ol class=list-unstyled><li><a href=https://github.com/Licenser>GitHub</a></li></ol></section></aside></div></div><footer class=blog-footer><p dir=auto>Blog template created by <a href=https://twitter.com/mdo>@mdo</a>, ported to Hugo by <a href=https://twitter.com/mralanorth>@mralanorth</a>.</p><p><a href=#>Back to top</a></p></footer></body></html>