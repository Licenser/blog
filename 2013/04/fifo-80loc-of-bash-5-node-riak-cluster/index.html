<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="FiFo + 80LOC of bash = 5 node riak cluster"><meta property="og:description" content="The reason The question &lsquo;why would I want at least 5 nodes&rsquo; comes up very often in the #riak IRC channel, there is a good explanation. But that's boring, no one likes reading manuals, we, as engineers, like to try things out (aka. break stuff).
Only downside with that is that we need to set things up before we can break them, or even worst need to un-break it later to try out different things (aka."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.licenser.net/2013/04/fifo-80loc-of-bash-5-node-riak-cluster/"><meta property="article:published_time" content="2013-04-23T00:00:00+00:00"><meta property="article:modified_time" content="2013-04-23T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="FiFo + 80LOC of bash = 5 node riak cluster"><meta name=twitter:description content="The reason The question &lsquo;why would I want at least 5 nodes&rsquo; comes up very often in the #riak IRC channel, there is a good explanation. But that's boring, no one likes reading manuals, we, as engineers, like to try things out (aka. break stuff).
Only downside with that is that we need to set things up before we can break them, or even worst need to un-break it later to try out different things (aka."><meta name=generator content="Hugo 0.62.2"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"FiFo \x2b 80LOC of bash = 5 node riak cluster","url":"https:\/\/blog.licenser.net\/2013\/04\/fifo-80loc-of-bash-5-node-riak-cluster\/","wordCount":"1071","datePublished":"2013-04-23T00:00:00+00:00","dateModified":"2013-04-23T00:00:00+00:00","author":{"@type":"Person","name":"Heinz N. Gies"}}</script><link rel=canonical href=https://blog.licenser.net/2013/04/fifo-80loc-of-bash-5-node-riak-cluster/><title>FiFo + 80LOC of bash = 5 node riak cluster | Lice!</title><link href=https://blog.licenser.net/css/style.6da5c906cc7a8fbb93f31cd2316c5dbe3f19ac4aa6bfb066f1243045b8f6061e.css rel=stylesheet integrity="sha256-baXJBsx6j7uT8xzSMWxdvj8ZrEqmv7Bm8SQwRbj2Bh4=" crossorigin=anonymous><script defer src=https://blog.licenser.net/js/fontawesome.min.90e14c13cee52929ac33e1c21694a3cc95063a194eb22aad9f7976434e1a9125.js integrity="sha256-kOFME87lKSmsM+HCFpSjzJUGOhlOsiqtn3l2Q04akSU=" crossorigin=anonymous></script></head><body><div class=blog-masthead><div class=container><nav class="nav blog-nav"><a class=nav-link href=https://blog.licenser.net/>Home</a></nav></div></div><header class=blog-header><div class=container><h1 class=blog-title dir=auto><a href=https://blog.licenser.net/ rel=home>Lice!</a></h1><p class="lead blog-description" dir=auto>A collection of somewhat random thoughts.</p></div></header><div class=container><div class=row><div class="col-sm-8 blog-main"><article class=blog-post><header><h2 class=blog-post-title dir=auto><a href=https://blog.licenser.net/2013/04/fifo-80loc-of-bash-5-node-riak-cluster/>FiFo + 80LOC of bash = 5 node riak cluster</a></h2><p class=blog-post-meta><time datetime=2013-04-23T00:00:00Z>2013-04-23</time> by Heinz N. Gies</p></header><h2 id=the-reason>The reason</h2><p>The question &lsquo;why would I want at least 5 nodes&rsquo; comes up very often in the #riak IRC channel, there is a <a href=http://basho.com/why-your-riak-cluster-should-have-at-least-five-nodes/>good explanation</a>. But that's boring, no one likes reading manuals, we, as engineers, like to try things out (aka. break stuff).</p><p>Only downside with that is that we need to set things up before we can break them, or even worst need to un-break it later to try out different things (aka. break it in different ways). Admittedly setting up a riak instance is <strong>easy</strong> but setting up 5 and connecting them then break them and do all again to break them again, erm‚Ä¶ I mean try things out of cause, can get really tedious and I for once am too lazy to bother with that.</p><h2 id=the-goal>The goal</h2><p>Make setting our breakage, erm test, bed setup as simple as possible, and whipping up things and tearing them down trivial, ideally have one simple command like <code>./riak.sh setup</code> to do that for us and <code>./riak.sh delete</code> undo it all for us to get back to a clean state.</p><h2 id=the-tools>The tools</h2><p>To build anything we'll need some tools, hammer and nails will not do us much good here so we are going to pick:</p><ul><li><a href=http://project-fifo.net>Project FiFo</a> - my favourite virtualisation tool (I am biassed I wrote it), but it's very easy to set up and very powerful.</li><li><a href=https://github.com/project-fifo/pyfi>The FiFo Console Client</a> - we want to script things, a UI isn't helpful.</li><li>bash - the simplest possible scripting tool.</li><li>curl - since riak offers a http fronted it's a wonderful way to check if the system is up.</li><li><a href=http://trentm.com/json/>jsontool</a> - a nifty utility to traverse JSON documents.</li></ul><p>With that we should be set and good to go.</p><h2 id=the-steps>The steps</h2><p>We'll have to perform multiple steps to build our wracking ground for riak lets look at them one by one:</p><h3 id=preparing-the-environment>Preparing the environment</h3><p>Before we can begin we've to set up a few things, I'll not go into detail how to set up FiFo, there is a [good manual] for that with only like 5 steps required. So lets start at some of the script's variables:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#/usr/bin/env bash</span>
PACKAGE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;small&#34;</span>
DATASET<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;base64-1.9.1&#34;</span>
NET<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;7df94bc3-6a9f-4c88-8f80-7a8f4086b79d&#34;</span>
</code></pre></div><ul><li><code>smal</code> is the name of the package created in FiFo, I picked something with 512MB of memory since that should be enough for now.</li><li><code>base64-1.9.1</code> is the dataset it means things are running in a solaris zone this also can be installed from the FiFo UI.</li><li><code>7df94bc3-6a9f-4c88-8f80-7a8f4086b79d</code> is the UUID of the network you can find that with <code>fifo networks list</code></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>schroedinger:fifopy heinz <span style=color:#f92672>[</span>master<span style=color:#f92672>]</span> $ fifo packages list
                                UUID Name       RAM        CPU cap    Quota
------------------------------------ ---------- ---------- ---------- ----------
5f9f6c41-d700-4b4f-80f1-7350a71ed2e6 small      <span style=color:#ae81ff>512</span> MB     100%       <span style=color:#ae81ff>10</span> GB
schroedinger:fifopy heinz <span style=color:#f92672>[</span>master<span style=color:#f92672>]</span> $ fifo networks list
                                UUID Name       Tag                  First            Last
------------------------------------ ---------- ---------- --------------- ---------------
7df94bc3-6a9f-4c88-8f80-7a8f4086b79d test       admin        192.168.0.210   192.168.0.220
schroedinger:fifopy heinz <span style=color:#f92672>[</span>master<span style=color:#f92672>]</span> $ fifo datasets list
                                UUID Name       Version Type  Description
------------------------------------ ---------- ------- ----- ----------
60ed3a3e-92c7-11e2-ba4a-9b6d5feaa0c4 base       1.9.1   zone  A SmartOS ...
</code></pre></div><h3 id=creating-a-vm-with-riak-installed>Creating a VM with riak installed</h3><p>Creating a VM is rather simple we need a little JSON and pipe it to fifo with a cat. Please note the section reading <code>user-script</code> here we make the setup. Here is how it looks.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat <span style=color:#e6db74>&lt;&lt;EOF | fifo vms create -p $PACKAGE -d $DATASET
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;alias&#34;: &#34;riak1&#34;,
</span><span style=color:#e6db74>  &#34;networks&#34;: {&#34;net0&#34;: &#34;$NET&#34;},
</span><span style=color:#e6db74>  &#34;metadata&#34;: {&#34;user-script&#34;: &#34;/opt/local/bin/sed -i.bak \\&#34;s/pkgsrc/pkgsrc-eu-ams/\\&#34; /opt/local/etc/pkgin/repositories.conf; /opt/local/bin/pkgin update; /opt/local/bin/pkgin -y install riak; export IP=\`ifconfig net0 | head -n 2 | tail -n 1 | awk &#39;{print \$2}&#39;\`; /opt/local/bin/sed -i.bak \\&#34;s/127.0.0.1/\$IP/\\&#34; /opt/local/etc/riak/app.config; /opt/local/bin/sed -i.bak \\&#34;s/127.0.0.1/\$IP/\\&#34; /opt/local/etc/riak/vm.args; svcadm enable epmd riak&#34;}
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74>EOF</span>
</code></pre></div><p>To get a bit better look user script section and remove the escape things:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># We configure pkgin to use the european mirror you might not need to do that.</span>
/opt/local/bin/sed -i.bak <span style=color:#e6db74>&#34;s/pkgsrc/pkgsrc-eu-ams/&#34;</span> /opt/local/etc/pkgin/repositories.conf;
<span style=color:#75715e># We update the pkgin database and install riak</span>
/opt/local/bin/pkgin update;
/opt/local/bin/pkgin -y install riak;
<span style=color:#75715e># We find out what IP our VM has from within the VM.</span>
export IP<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>ifconfig net0 | head -n <span style=color:#ae81ff>2</span> | tail -n <span style=color:#ae81ff>1</span> | awk <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#e6db74>`</span>;
<span style=color:#75715e># We update the app.config and vm.args to use the &#39;public&#39; ip instead of the 127.0.0.1</span>
/opt/local/bin/sed -i.bak <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>s/127.0.0.1/</span>$IP<span style=color:#e6db74>/</span><span style=color:#e6db74>&#34;</span> /opt/local/etc/riak/app.config;
/opt/local/bin/sed -i.bak <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>s/127.0.0.1/</span>$IP<span style=color:#e6db74>/</span><span style=color:#e6db74>&#34;</span> /opt/local/etc/riak/vm.args;
<span style=color:#75715e># Start epmd and riak</span>
svcadm enable epmd riak
</code></pre></div><h3 id=waiting-for-riak>Waiting for riak</h3><p>Now that is the first zone set up next we'll want to wait for riak to properly start up. This is needed since the commands are asynchronous and installing the packages can be a tad slow. But we can just to curl the http interface to check for this, so it's rather simple:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># We&#39;ll ask fifo for the IP of our first zone.</span>
IP1<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>fifo vms get riak1 | json networks<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.ip<span style=color:#e6db74>`</span>
<span style=color:#75715e># Print some info so waiting is not so boring</span>
echo -n <span style=color:#e6db74>&#39;Waiting until riak is up and running on the primary node.&#39;</span>
<span style=color:#75715e># now we curl the http interface every second to see if things are good.</span>
<span style=color:#66d9ef>until</span> curl http://<span style=color:#e6db74>${</span>IP1<span style=color:#e6db74>}</span>:8098 2&gt;/dev/null &gt;/dev/null
<span style=color:#66d9ef>do</span>
	sleep <span style=color:#ae81ff>1</span>
	echo -n <span style=color:#e6db74>&#39;.&#39;</span>
<span style=color:#66d9ef>done</span>
<span style=color:#75715e># and we&#39;re done!</span>
echo <span style=color:#e6db74>&#34; done.&#34;</span>
</code></pre></div><h3 id=setting-up-the-remaining-zones>Setting up the remaining zones</h3><p>We're not going to get into too much details with this since it is pretty much working the same as the first VM with the only difference that the user-script holds two more lines:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#66d9ef>for</span> i in <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>
<span style=color:#66d9ef>do</span>
	cat <span style=color:#e6db74>&lt;&lt;EOF | fifo vms create -p $PACKAGE -d $DATASET
</span><span style=color:#e6db74>  {
</span><span style=color:#e6db74>    &#34;alias&#34;: &#34;riak${i}&#34;,
</span><span style=color:#e6db74>    &#34;networks&#34;: {&#34;net0&#34;: &#34;$NET&#34;},
</span><span style=color:#e6db74>    &#34;metadata&#34;: {&#34;user-script&#34;: &#34;/opt/local/bin/sed -i.bak \\&#34;s/pkgsrc/pkgsrc-eu-ams/\\&#34; /opt/local/etc/pkgin/repositories.conf; /opt/local/bin/pkgin update; /opt/local/bin/pkgin -y install riak; export IP=\`ifconfig net0 | head -n 2 | tail -n 1 | awk &#39;{print \$2}&#39;\`; /opt/local/bin/sed -i.bak \\&#34;s/127.0.0.1/\$IP/\\&#34; /opt/local/etc/riak/app.config; /opt/local/bin/sed -i.bak \\&#34;s/127.0.0.1/\$IP/\\&#34; /opt/local/etc/riak/vm.args; svcadm enable epmd riak; sleep 10; /opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster join riak@${IP1}; /opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster plan; /opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster commit&#34;}
</span><span style=color:#e6db74>  }
</span><span style=color:#e6db74>EOF</span>
	IP<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>fifo vms get riak$i | json networks<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.ip<span style=color:#e6db74>`</span>
	echo -n <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Waiting untill riak is up and running on the node </span>$i<span style=color:#e6db74>.</span><span style=color:#e6db74>&#34;</span>
	<span style=color:#66d9ef>until</span> curl http://<span style=color:#e6db74>${</span>IP<span style=color:#e6db74>}</span>:8098 2&gt;/dev/null &gt;/dev/null
	<span style=color:#66d9ef>do</span>
    	sleep <span style=color:#ae81ff>1</span>
		echo -n <span style=color:#e6db74>&#39;.&#39;</span>
	<span style=color:#66d9ef>done</span>
	echo <span style=color:#e6db74>&#34; done.&#34;</span>

<span style=color:#66d9ef>done</span>
</code></pre></div><p>The two new lines are joining the node to the existing riak node which is quite easy, we can use $IP1 we generated in the first step too:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>/opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster join riak@<span style=color:#e6db74>${</span>IP1<span style=color:#e6db74>}</span>
/opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster plan
/opt/local/bin/sudo -uriak /opt/local/sbin/riak-admin cluster commit
</code></pre></div><p>This is run that up and you've a 5 node riak cluster, and it's quick at last if you're in the US and have a good connection to the package repository.</p><p><a href=https://raw.github.com/project-fifo/pyfi/master/examples/riak.sh>Here</a> is this all slapped together.</p><hr><footer><section><h4>Share</h4><nav class="nav sharing-icons"><a class=nav-item href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.licenser.net%2f2013%2f04%2ffifo-80loc-of-bash-5-node-riak-cluster%2f" title="Share on Facebook"><span class="fab fa-facebook-f fa-2x" aria-hidden=true></span></a><a class=nav-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.licenser.net%2f2013%2f04%2ffifo-80loc-of-bash-5-node-riak-cluster%2f" title="Share on LinkedIn"><span class="fab fa-linkedin-in fa-2x" aria-hidden=true></span></a><a class=nav-item href="https://twitter.com/intent/tweet?url=https%3a%2f%2fblog.licenser.net%2f2013%2f04%2ffifo-80loc-of-bash-5-node-riak-cluster%2f&text=FiFo%20%2b%2080LOC%20of%20bash%20%3d%205%20node%20riak%20cluster" title="Tweet this"><span class="fab fa-twitter fa-2x"></span></a></nav></section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"lice"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="col-sm-3 ml-auto blog-sidebar"><section class=sidebar-module><h4>Links</h4><ol class=list-unstyled><li><a href=https://github.com/Licenser>GitHub</a></li><li><a href=https://twitter.com/heinz_gies>Twitter</a></li><a rel=me href=https://mastodon.social/@heinz>Mastodon</a></ol></section></aside></div></div><footer class=blog-footer><p dir=auto><a href=https://firechicken.club/licenser/prev>‚Üê</a>
<a href=https://firechicken.club>üî•üêì</a>
<a href=https://firechicken.club/licenser/next>‚Üí</a></p><p dir=auto>Blog template created by <a href=https://twitter.com/mdo>@mdo</a>, ported to Hugo by <a href=https://twitter.com/mralanorth>@mralanorth</a>.</p><p><a href=#>Back to top</a></p></footer></body></html>